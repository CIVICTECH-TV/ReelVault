<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","build.rs"],"content":"fn main() {\n  tauri_build::build()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","aws_auth.rs"],"content":"use serde::{Deserialize, Serialize};\nuse tauri::command;\nuse aws_config::{BehaviorVersion, Region};\nuse crate::commands::aws_operations::{S3ClientTrait, RealS3Client, create_s3_client};\nuse aws_sdk_sts::Client as StsClient;\nuse crate::internal::{InternalError, standardize_error};\n\n// AWS設定構造体（他のモジュールと共有用）\n#[derive(Debug, Deserialize, Clone)]\npub struct AwsConfig {\n    pub access_key_id: String,\n    pub secret_access_key: String,\n    pub region: String,\n    pub bucket_name: String,\n}\n\n/// AWS認証情報\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct AwsCredentials {\n    pub access_key_id: String,\n    pub secret_access_key: String,\n    pub region: String,\n    pub session_token: Option\u003cString\u003e,\n}\n\n/// AWS認証結果\n#[derive(Debug, Serialize)]\npub struct AwsAuthResult {\n    pub success: bool,\n    pub message: String,\n    pub user_identity: Option\u003cAwsUserIdentity\u003e,\n    pub permissions: Vec\u003cString\u003e,\n}\n\n/// AWS ユーザー情報\n#[derive(Debug, Serialize)]\npub struct AwsUserIdentity {\n    pub user_id: String,\n    pub arn: String,\n    pub account: String,\n}\n\n/// AWS権限チェック結果\n#[derive(Debug, Serialize)]\npub struct PermissionCheck {\n    pub service: String,\n    pub action: String,\n    pub resource: String,\n    pub allowed: bool,\n}\n\n/// 認証情報の基本検証を行う\npub fn validate_aws_credentials(credentials: \u0026AwsCredentials) -\u003e Result\u003c(), String\u003e {\n    if credentials.access_key_id.is_empty() {\n        return Err(\"Access Key ID is required\".to_string());\n    }\n    if credentials.secret_access_key.is_empty() {\n        return Err(\"Secret Access Key is required\".to_string());\n    }\n    if credentials.region.is_empty() {\n        return Err(\"Region is required\".to_string());\n    }\n    Ok(())\n}\n\n/// AWS認証を実行する\n#[command]\npub async fn authenticate_aws(credentials: AwsCredentials) -\u003e Result\u003cAwsAuthResult, String\u003e {\n    // 認証情報の基本検証\n    if let Err(e) = validate_aws_credentials(\u0026credentials) {\n        return Ok(AwsAuthResult {\n            success: false,\n            message: e,\n            user_identity: None,\n            permissions: vec![],\n        });\n    }\n\n    // AWS設定を構築\n    let region = Region::new(credentials.region.clone());\n    let mut config_builder = aws_config::defaults(BehaviorVersion::latest())\n        .region(region);\n\n    // 認証情報を設定\n    use aws_credential_types::Credentials;\n    let creds = if let Some(session_token) = \u0026credentials.session_token {\n        Credentials::new(\n            \u0026credentials.access_key_id,\n            \u0026credentials.secret_access_key,\n            Some(session_token.clone()),\n            None,\n            \"manual\",\n        )\n    } else {\n        Credentials::new(\n            \u0026credentials.access_key_id,\n            \u0026credentials.secret_access_key,\n            None,\n            None,\n            \"manual\",\n        )\n    };\n\n    config_builder = config_builder.credentials_provider(creds);\n    let config = config_builder.load().await;\n\n    // STS クライアントでIDを確認\n    let sts_client = StsClient::new(\u0026config);\n    \n    match sts_client.get_caller_identity().send().await {\n        Ok(identity) =\u003e {\n            let user_identity = AwsUserIdentity {\n                user_id: identity.user_id().unwrap_or(\"unknown\").to_string(),\n                arn: identity.arn().unwrap_or(\"unknown\").to_string(),\n                account: identity.account().unwrap_or(\"unknown\").to_string(),\n            };\n\n            // 基本的な権限チェック\n            let permissions = check_basic_permissions(\u0026config).await;\n\n            log::info!(\"AWS authentication successful for user: {}\", user_identity.arn);\n\n            Ok(AwsAuthResult {\n                success: true,\n                message: \"AWS authentication successful\".to_string(),\n                user_identity: Some(user_identity),\n                permissions,\n            })\n        }\n        Err(e) =\u003e {\n            log::error!(\"AWS authentication failed: {}\", e);\n            Ok(AwsAuthResult {\n                success: false,\n                message: format!(\"Authentication failed: {}\", e),\n                user_identity: None,\n                permissions: vec![],\n            })\n        }\n    }\n}\n\n/// S3バケットへのアクセス権限をテストし、成功時にライフサイクルポリシーを自動設定する\n#[command]\npub async fn test_s3_bucket_access(\n    credentials: AwsCredentials,\n    bucket_name: String,\n) -\u003e Result\u003cPermissionCheck, String\u003e {\n    // S3ClientTraitを使用\n    let s3_client = match create_s3_client(\u0026credentials).await {\n        Ok(client) =\u003e RealS3Client::new(client),\n        Err(e) =\u003e {\n            log::error!(\"Failed to create S3 client: {}\", e);\n            return Err(standardize_error(InternalError::AwsConfig(format!(\"S3 client creation failed: {}\", e))));\n        }\n    };\n\n    // バケットへのアクセステスト\n    match s3_client.head_bucket(\u0026bucket_name).await {\n        Ok(_) =\u003e {\n            log::info!(\"S3 bucket access successful: {}\", bucket_name);\n            \n            // 成功時に自動でライフサイクルポリシーを適用し、確実に反映されるまで待機\n            log::debug!(\"Starting auto-setup lifecycle policy for bucket: {}\", bucket_name);\n            match auto_setup_lifecycle_policy_with_client(\u0026s3_client, \u0026bucket_name).await {\n                Ok(_) =\u003e {\n                    log::info!(\"ReelVault lifecycle policy applied, now verifying...\");\n                    \n                    // ライフサイクル設定が反映されるまで待機（最大60秒、5秒間隔）\n                    match verify_lifecycle_policy_applied_with_client(\u0026s3_client, \u0026bucket_name, 60, 5).await {\n                        Ok(_) =\u003e {\n                            log::info!(\"ReelVault lifecycle policy verified and active for bucket: {}\", bucket_name);\n                        }\n                        Err(e) =\u003e {\n                            log::error!(\"Lifecycle policy verification failed for bucket {}: {}\", bucket_name, e);\n                            return Err(standardize_error(InternalError::AwsConfig(format!(\"ライフサイクル設定の確認に失敗しました: {}\", e))));\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    log::error!(\"Failed to auto-setup lifecycle policy for bucket {}: {}\", bucket_name, e);\n                    return Err(standardize_error(InternalError::AwsConfig(format!(\"ライフサイクル設定に失敗しました: {}\", e))));\n                }\n            }\n            \n            Ok(PermissionCheck {\n                service: \"S3\".to_string(),\n                action: \"head_bucket\".to_string(),\n                resource: bucket_name,\n                allowed: true,\n            })\n        }\n        Err(e) =\u003e {\n            log::error!(\"S3 bucket access failed: {}\", e);\n            Ok(PermissionCheck {\n                service: \"S3\".to_string(),\n                action: \"head_bucket\".to_string(),\n                resource: bucket_name,\n                allowed: false,\n            })\n        }\n    }\n}\n\n/// AwsConfigからaws_config::SdkConfigを作成\npub async fn create_aws_config(config: \u0026AwsConfig) -\u003e Result\u003caws_config::SdkConfig, String\u003e {\n    let region = Region::new(config.region.clone());\n    let mut config_builder = aws_config::defaults(BehaviorVersion::latest())\n        .region(region);\n\n    // 認証情報を設定\n    use aws_credential_types::Credentials;\n    let creds = Credentials::new(\n        \u0026config.access_key_id,\n        \u0026config.secret_access_key,\n        None,\n        None,\n        \"manual\",\n    );\n\n    config_builder = config_builder.credentials_provider(creds);\n    Ok(config_builder.load().await)\n}\n\n/// 基本的なAWS権限をチェック\nasync fn check_basic_permissions(config: \u0026aws_config::SdkConfig) -\u003e Vec\u003cString\u003e {\n    let mut permissions = Vec::new();\n\n    // S3の基本権限チェック\n    let s3_client = match create_s3_client(\u0026AwsCredentials {\n        access_key_id: \"test\".to_string(),\n        secret_access_key: \"test\".to_string(),\n        session_token: None,\n        region: \"us-east-1\".to_string(),\n    }).await {\n        Ok(client) =\u003e RealS3Client::new(client),\n        Err(_) =\u003e {\n            // S3Client作成に失敗した場合は権限なしとして扱う\n            return permissions;\n        }\n    };\n    \n    match s3_client.list_objects(\"test-bucket\", None).await {\n        Ok(_) =\u003e {\n            permissions.push(\"s3:ListBucket\".to_string());\n        }\n        Err(e) =\u003e {\n            let error_str = e.to_string();\n            if !error_str.contains(\"AccessDenied\") \u0026\u0026 !error_str.contains(\"Forbidden\") {\n                // アクセス拒否以外のエラーの場合は権限がある可能性\n                permissions.push(\"s3:ListBucket (uncertain)\".to_string());\n            }\n            log::debug!(\"S3 permission test result: {}\", error_str);\n        }\n    }\n\n    // ライフサイクル関連権限のテスト（ダミーバケットで）\n    // 注意: 実際のバケットがない場合はスキップ\n    let test_bucket = \"test-lifecycle-permissions-bucket\";\n    match s3_client.get_bucket_lifecycle_configuration(test_bucket).await {\n        Ok(_) =\u003e {\n            permissions.push(\"s3:GetLifecycleConfiguration\".to_string());\n        }\n        Err(e) =\u003e {\n            let error_str = e.to_string();\n            if error_str.contains(\"NoSuchBucket\") {\n                // バケットが存在しないのは正常（権限はある）\n                permissions.push(\"s3:GetLifecycleConfiguration\".to_string());\n            } else if !error_str.contains(\"AccessDenied\") \u0026\u0026 !error_str.contains(\"Forbidden\") {\n                // アクセス拒否以外のエラーの場合は権限がある可能性\n                permissions.push(\"s3:GetLifecycleConfiguration (uncertain)\".to_string());\n            }\n            log::debug!(\"Lifecycle permission test result: {}\", error_str);\n        }\n    }\n\n    permissions\n}\n\n/// AWS認証情報をセキュアに保存する（Touch ID/Face ID対応）\n#[command]\npub async fn save_aws_credentials_secure(\n    credentials: AwsCredentials,\n    profile_name: String,\n) -\u003e Result\u003cString, String\u003e {\n    let service_name = \"ReelVault-AWS\";\n\n    // 認証情報をJSONとしてシリアライズ\n    let credentials_json = serde_json::to_string(\u0026credentials)\n        .map_err(|e| format!(\"Failed to serialize credentials: {}\", e))?;\n\n    // macOSの場合はTouch ID/Face ID対応で保存、それ以外は従来通り\n    #[cfg(target_os = \"macos\")]\n    {\n                 if macos_keychain::is_biometry_available() {\n             match macos_keychain::save_password_with_biometry(\u0026service_name, \u0026profile_name, \u0026credentials_json) {\n                 Ok(()) =\u003e (),\n                 Err(e) =\u003e {\n                     log::warn!(\"Touch ID/Face ID保存に失敗、従来方式にフォールバック: {}\", e);\n                     // フォールバック：従来のKeychain保存\n                     fallback_save_credentials(\u0026service_name, \u0026profile_name, \u0026credentials_json)\n                         .map_err(|fe| format!(\"Touch ID保存もフォールバック保存も失敗: Touch ID={}, Fallback={}\", e, fe))?;\n                 }\n             }\n            log::info!(\"AWS credentials saved with Touch ID/Face ID for profile: {}\", profile_name);\n            return Ok(\"Credentials saved with Touch ID/Face ID\".to_string());\n        } else {\n            log::info!(\"Touch ID/Face ID not available, using standard keychain\");\n        }\n    }\n\n    // 非macOSまたはTouch ID非対応の場合\n    fallback_save_credentials(\u0026service_name, \u0026profile_name, \u0026credentials_json)?;\n    log::info!(\"AWS credentials saved securely for profile: {}\", profile_name);\n    Ok(\"Credentials saved securely\".to_string())\n}\n\n/// 従来のKeychain保存（フォールバック用）\nfn fallback_save_credentials(service_name: \u0026str, profile_name: \u0026str, credentials_json: \u0026str) -\u003e Result\u003c(), String\u003e {\n    use keyring::Entry;\n    \n    let entry = Entry::new(service_name, profile_name)\n        .map_err(|e| format!(\"Failed to create keyring entry: {}\", e))?;\n\n    entry.set_password(credentials_json)\n        .map_err(|e| format!(\"Failed to save credentials to keychain: {}\", e))?;\n\n    Ok(())\n}\n\n/// セキュアに保存されたAWS認証情報を読み込む（Touch ID/Face ID対応）\n#[command]\npub async fn load_aws_credentials_secure(profile_name: String) -\u003e Result\u003cAwsCredentials, String\u003e {\n    let service_name = \"ReelVault-AWS\";\n\n    // macOSの場合はTouch ID/Face ID対応で読み込み、それ以外は従来通り\n    let credentials_json = {\n        #[cfg(target_os = \"macos\")]\n        {\n            if macos_keychain::is_biometry_available() {\n                match macos_keychain::load_password_with_biometry(\u0026service_name, \u0026profile_name) {\n                    Ok(json) =\u003e {\n                        log::info!(\"AWS credentials loaded with Touch ID/Face ID for profile: {}\", profile_name);\n                        json\n                    }\n                    Err(e) =\u003e {\n                        log::warn!(\"Touch ID/Face ID読み込みに失敗、従来方式にフォールバック: {}\", e);\n                        // フォールバック：従来のKeychain読み込み\n                        fallback_load_credentials(\u0026service_name, \u0026profile_name)?\n                    }\n                }\n            } else {\n                log::info!(\"Touch ID/Face ID not available, using standard keychain\");\n                fallback_load_credentials(\u0026service_name, \u0026profile_name)?\n            }\n        }\n        #[cfg(not(target_os = \"macos\"))]\n        {\n            fallback_load_credentials(\u0026service_name, \u0026profile_name)?\n        }\n    };\n\n    // JSONからデシリアライズ\n    let credentials: AwsCredentials = serde_json::from_str(\u0026credentials_json)\n        .map_err(|e| format!(\"Failed to deserialize credentials: {}\", e))?;\n\n    log::info!(\"AWS credentials loaded securely for profile: {}\", profile_name);\n    Ok(credentials)\n}\n\n/// 従来のKeychain読み込み（フォールバック用）\nfn fallback_load_credentials(service_name: \u0026str, profile_name: \u0026str) -\u003e Result\u003cString, String\u003e {\n    use keyring::Entry;\n    \n    let entry = Entry::new(service_name, profile_name)\n        .map_err(|e| format!(\"Failed to create keyring entry: {}\", e))?;\n\n    entry.get_password()\n        .map_err(|e| format!(\"Failed to load credentials from keychain: {}\", e))\n}\n\n/// S3ClientTraitを使用してライフサイクルポリシーを自動設定\nasync fn auto_setup_lifecycle_policy_with_client(\n    s3_client: \u0026dyn S3ClientTrait,\n    bucket_name: \u0026str,\n) -\u003e Result\u003c(), String\u003e {\n    use crate::commands::aws_operations::{LifecycleRule, LifecycleTransition};\n    \n    const REELVAULT_RULE_ID: \u0026str = \"ReelVault-Default-Auto-Archive\";\n    const REELVAULT_PREFIX: \u0026str = \"uploads/\";\n\n    // 既存のライフサイクル設定をチェック\n    match s3_client.get_bucket_lifecycle_configuration(bucket_name).await {\n        Ok(existing_rules) =\u003e {\n            // ReelVaultルールが既に存在するかチェック\n            let reelvault_rule_exists = existing_rules.iter().any(|rule| rule.id == REELVAULT_RULE_ID);\n            \n            if reelvault_rule_exists {\n                log::info!(\"ReelVault lifecycle rule already exists for bucket: {}\", bucket_name);\n                return Ok(());\n            }\n        }\n        Err(e) =\u003e {\n            log::debug!(\"No existing lifecycle configuration found for bucket {}: {}\", bucket_name, e);\n        }\n    }\n\n    // ReelVaultライフサイクルルールを作成\n    let reelvault_rule = LifecycleRule {\n        id: REELVAULT_RULE_ID.to_string(),\n        status: \"Enabled\".to_string(),\n        prefix: Some(REELVAULT_PREFIX.to_string()),\n        transitions: vec![\n            LifecycleTransition {\n                days: 1,\n                storage_class: \"DEEP_ARCHIVE\".to_string(),\n            }\n        ],\n    };\n\n    // ライフサイクル設定を適用\n    match s3_client.put_bucket_lifecycle_configuration(bucket_name, vec![reelvault_rule]).await {\n        Ok(_) =\u003e {\n            log::info!(\"ReelVault lifecycle policy applied successfully for bucket: {}\", bucket_name);\n            Ok(())\n        }\n        Err(e) =\u003e {\n            log::error!(\"Failed to apply ReelVault lifecycle policy for bucket {}: {}\", bucket_name, e);\n            Err(format!(\"Failed to apply lifecycle policy: {}\", e))\n        }\n    }\n}\n\n/// S3ClientTraitを使用してライフサイクルポリシーの適用を確認\nasync fn verify_lifecycle_policy_applied_with_client(\n    s3_client: \u0026dyn S3ClientTrait,\n    bucket_name: \u0026str,\n    timeout_seconds: u64,\n    check_interval_seconds: u64,\n) -\u003e Result\u003c(), String\u003e {\n    const REELVAULT_RULE_ID: \u0026str = \"ReelVault-Default-Auto-Archive\";\n    \n    let start_time = std::time::Instant::now();\n    let timeout_duration = std::time::Duration::from_secs(timeout_seconds);\n    let check_interval = std::time::Duration::from_secs(check_interval_seconds);\n\n    loop {\n        if start_time.elapsed() \u003e timeout_duration {\n            return Err(format!(\"Timeout waiting for lifecycle policy to be applied for bucket: {}\", bucket_name));\n        }\n\n        match s3_client.get_bucket_lifecycle_configuration(bucket_name).await {\n            Ok(rules) =\u003e {\n                // ReelVaultルールが存在し、Enabledかチェック\n                if let Some(rule) = rules.iter().find(|r| r.id == REELVAULT_RULE_ID) {\n                    if rule.status == \"Enabled\" {\n                        log::info!(\"ReelVault lifecycle policy verified and active for bucket: {}\", bucket_name);\n                        return Ok(());\n                    } else {\n                        log::debug!(\"ReelVault lifecycle rule found but not enabled for bucket: {}\", bucket_name);\n                    }\n                } else {\n                    log::debug!(\"ReelVault lifecycle rule not found yet for bucket: {}\", bucket_name);\n                }\n            }\n            Err(e) =\u003e {\n                log::debug!(\"Error checking lifecycle configuration for bucket {}: {}\", bucket_name, e);\n            }\n        }\n\n        tokio::time::sleep(check_interval).await;\n    }\n}\n\n#[cfg(target_os = \"macos\")]\nmod macos_keychain {\n    use crate::internal::{InternalError, standardize_error};\n\n    /// Touch ID/Face ID必須でKeychainに保存\n    pub fn save_password_with_biometry(\n        service: \u0026str,\n        account: \u0026str,\n        password: \u0026str,\n    ) -\u003e Result\u003c(), String\u003e {\n        // より簡単なアプローチ：Keyringライブラリでアクセス制御付きで保存\n        save_with_prompt(service, account, password, true)\n    }\n\n    /// Touch ID/Face ID必須でKeychainから読み込み\n    pub fn load_password_with_biometry(\n        service: \u0026str,\n        account: \u0026str,\n    ) -\u003e Result\u003cString, String\u003e {\n        load_with_prompt(service, account, \"ReelVaultのAWS認証情報にアクセスするためにTouch IDまたはFace IDを使用してください\")\n    }\n\n    /// Touch ID/Face IDが利用可能かチェック\n    pub fn is_biometry_available() -\u003e bool {\n        use std::process::Command;\n        \n        // より確実な方法：systemctl と biometryd を使用してチェック\n        let output = Command::new(\"sh\")\n            .arg(\"-c\")\n            .arg(\"ioreg -rd1 -c AppleBiometricSensor | grep -c Biometric \u003e /dev/null 2\u003e\u00261\")\n            .output();\n\n        match output {\n            Ok(output) =\u003e output.status.success(),\n            Err(_) =\u003e {\n                // フォールバック：単純にmacOSかどうかで判断\n                true  // macOSであれば基本的に対応していると仮定\n            }\n        }\n    }\n\n    /// カスタムプロンプト付きで保存（Touch ID/Face ID使用）\n    fn save_with_prompt(service: \u0026str, account: \u0026str, password: \u0026str, use_biometry: bool) -\u003e Result\u003c(), String\u003e {\n        use std::process::Command;\n        \n        if use_biometry {\n            // セキュリティコマンドを使用してTouch ID/Face ID対応で保存\n            let mut child = Command::new(\"security\")\n                .args(\u0026[\n                    \"add-generic-password\",\n                    \"-a\", account,\n                    \"-s\", service,\n                    \"-T\", \"\",  // 空の-Tでアプリ認証制御\n                    \"-U\",      // update if exists\n                    \"-w\", password,\n                ])\n                .spawn()\n                .map_err(|e| format!(\"Failed to launch security command: {}\", e))?;\n\n            let status = child.wait()\n                .map_err(|e| format!(\"Failed to wait for security command: {}\", e))?;\n\n            if status.success() {\n                log::info!(\"Touch ID/Face ID対応Keychain保存が完了しました\");\n                Ok(())\n            } else {\n                Err(format!(\"Touch ID/Face ID Keychain保存に失敗: exit code {:?}\", status.code()))\n            }\n        } else {\n            // 通常のkeyringライブラリ使用\n            use keyring::Entry;\n            let entry = Entry::new(service, account)\n                .map_err(|e| format!(\"Failed to create keyring entry: {}\", e))?;\n            entry.set_password(password)\n                .map_err(|e| format!(\"Failed to save to keychain: {}\", e))?;\n            Ok(())\n        }\n    }\n\n    /// カスタムプロンプト付きで読み込み（Touch ID/Face ID使用）\n    fn load_with_prompt(service: \u0026str, account: \u0026str, _prompt: \u0026str) -\u003e Result\u003cString, String\u003e {\n        use std::process::Command;\n        \n        // セキュリティコマンドを使用してTouch ID/Face ID対応で読み込み\n        let output = Command::new(\"security\")\n            .args(\u0026[\n                \"find-generic-password\",\n                \"-a\", account,\n                \"-s\", service,\n                \"-w\"  // パスワードのみ出力\n            ])\n            .output()\n            .map_err(|e| format!(\"Failed to execute security command: {}\", e))?;\n\n        if output.status.success() {\n            let password = String::from_utf8(output.stdout)\n                .map_err(|e| format!(\"Failed to decode password: {}\", e))?\n                .trim()\n                .to_string();\n            \n            if password.is_empty() {\n                Err(standardize_error(InternalError::Other(\"保存された認証情報が見つかりません\".to_string())))\n            } else {\n                log::info!(\"Touch ID/Face ID認証で情報を読み込みました\");\n                Ok(password)\n            }\n        } else {\n            let error_msg = String::from_utf8_lossy(\u0026output.stderr);\n            if error_msg.contains(\"could not be found\") {\n                Err(standardize_error(InternalError::Other(\"保存された認証情報が見つかりません\".to_string())))\n            } else if error_msg.contains(\"user canceled\") {\n                Err(standardize_error(InternalError::Other(\"Touch ID/Face ID認証がキャンセルされました\".to_string())))\n            } else {\n                Err(standardize_error(InternalError::Other(format!(\"Touch ID/Face ID認証に失敗しました: {}\", error_msg.trim()))))\n            }\n        }\n    }\n}\n\n#[cfg(not(target_os = \"macos\"))]\nmod macos_keychain {\n    use crate::internal::{InternalError, standardize_error};\n\n    pub fn save_password_with_biometry(\n        _service: \u0026str,\n        _account: \u0026str,\n        _password: \u0026str,\n    ) -\u003e Result\u003c(), String\u003e {\n        Err(standardize_error(InternalError::Other(\"Touch ID/Face ID is only available on macOS\".to_string())))\n    }\n\n    pub fn load_password_with_biometry(\n        _service: \u0026str,\n        _account: \u0026str,\n    ) -\u003e Result\u003cString, String\u003e {\n        Err(standardize_error(InternalError::Other(\"Touch ID/Face ID is only available on macOS\".to_string())))\n    }\n\n    pub fn is_biometry_available() -\u003e bool {\n        false\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_aws_credentials_creation() {\n        let credentials = AwsCredentials {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"us-east-1\".to_string(),\n            session_token: None,\n        };\n        \n        assert_eq!(credentials.access_key_id, \"test_key\");\n        assert_eq!(credentials.secret_access_key, \"test_secret\");\n        assert_eq!(credentials.region, \"us-east-1\");\n        assert!(credentials.session_token.is_none());\n    }\n\n    #[test]\n    fn test_aws_credentials_with_session_token() {\n        let credentials = AwsCredentials {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"us-east-1\".to_string(),\n            session_token: Some(\"test_token\".to_string()),\n        };\n        \n        assert_eq!(credentials.access_key_id, \"test_key\");\n        assert_eq!(credentials.secret_access_key, \"test_secret\");\n        assert_eq!(credentials.region, \"us-east-1\");\n        assert_eq!(credentials.session_token, Some(\"test_token\".to_string()));\n    }\n\n    #[test]\n    fn test_aws_config_creation() {\n        let config = AwsConfig {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"us-east-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        assert_eq!(config.access_key_id, \"test_key\");\n        assert_eq!(config.secret_access_key, \"test_secret\");\n        assert_eq!(config.region, \"us-east-1\");\n        assert_eq!(config.bucket_name, \"test-bucket\");\n    }\n\n    #[test]\n    fn test_aws_user_identity_creation() {\n        let identity = AwsUserIdentity {\n            user_id: \"test_user\".to_string(),\n            arn: \"arn:aws:iam::123456789012:user/test_user\".to_string(),\n            account: \"123456789012\".to_string(),\n        };\n        \n        assert_eq!(identity.user_id, \"test_user\");\n        assert_eq!(identity.arn, \"arn:aws:iam::123456789012:user/test_user\");\n        assert_eq!(identity.account, \"123456789012\");\n    }\n\n    #[test]\n    fn test_permission_check_creation() {\n        let permission = PermissionCheck {\n            service: \"S3\".to_string(),\n            action: \"s3:GetObject\".to_string(),\n            resource: \"arn:aws:s3:::test-bucket/*\".to_string(),\n            allowed: true,\n        };\n        \n        assert_eq!(permission.service, \"S3\");\n        assert_eq!(permission.action, \"s3:GetObject\");\n        assert_eq!(permission.resource, \"arn:aws:s3:::test-bucket/*\");\n        assert!(permission.allowed);\n    }\n\n    #[test]\n    fn test_aws_auth_result_creation() {\n        let auth_result = AwsAuthResult {\n            success: true,\n            message: \"Authentication successful\".to_string(),\n            user_identity: Some(AwsUserIdentity {\n                user_id: \"test_user\".to_string(),\n                arn: \"arn:aws:iam::123456789012:user/test_user\".to_string(),\n                account: \"123456789012\".to_string(),\n            }),\n            permissions: vec![\"s3:GetObject\".to_string(), \"s3:PutObject\".to_string()],\n        };\n        \n        assert!(auth_result.success);\n        assert_eq!(auth_result.message, \"Authentication successful\");\n        assert!(auth_result.user_identity.is_some());\n        assert_eq!(auth_result.permissions.len(), 2);\n        assert!(auth_result.permissions.contains(\u0026\"s3:GetObject\".to_string()));\n        assert!(auth_result.permissions.contains(\u0026\"s3:PutObject\".to_string()));\n    }\n\n    #[test]\n    fn test_validate_aws_credentials_success() {\n        let credentials = AwsCredentials {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"us-east-1\".to_string(),\n            session_token: None,\n        };\n        \n        let result = validate_aws_credentials(\u0026credentials);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_validate_aws_credentials_empty_access_key() {\n        let credentials = AwsCredentials {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"us-east-1\".to_string(),\n            session_token: None,\n        };\n        \n        let result = validate_aws_credentials(\u0026credentials);\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Access Key ID is required\");\n    }\n\n    #[test]\n    fn test_validate_aws_credentials_empty_secret_key() {\n        let credentials = AwsCredentials {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"us-east-1\".to_string(),\n            session_token: None,\n        };\n        \n        let result = validate_aws_credentials(\u0026credentials);\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Secret Access Key is required\");\n    }\n\n    #[test]\n    fn test_validate_aws_credentials_empty_region() {\n        let credentials = AwsCredentials {\n            access_key_id: \"test_key\".to_string(),\n            secret_access_key: \"test_secret\".to_string(),\n            region: \"\".to_string(),\n            session_token: None,\n        };\n        \n        let result = validate_aws_credentials(\u0026credentials);\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"Region is required\");\n    }\n\n    #[test]\n    fn test_validate_aws_credentials_all_empty() {\n        let credentials = AwsCredentials {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            session_token: None,\n        };\n        \n        let result = validate_aws_credentials(\u0026credentials);\n        assert!(result.is_err());\n        // 最初のエラー（Access Key ID）が返される\n        assert_eq!(result.unwrap_err(), \"Access Key ID is required\");\n    }\n\n    #[test]\n    fn test_macos_keychain_not_macos() {\n        #[cfg(not(target_os = \"macos\"))]\n        {\n            use super::macos_keychain;\n            let save_result = macos_keychain::save_password_with_biometry(\"service\", \"account\", \"password\");\n            assert!(save_result.is_err());\n            assert!(save_result.unwrap_err().contains(\"Touch ID/Face ID is only available on macOS\"));\n\n            let load_result = macos_keychain::load_password_with_biometry(\"service\", \"account\");\n            assert!(load_result.is_err());\n            assert!(load_result.unwrap_err().contains(\"Touch ID/Face ID is only available on macOS\"));\n\n            assert!(!macos_keychain::is_biometry_available());\n        }\n    }\n\n    #[tokio::test]\n    async fn test_authenticate_aws_invalid_credentials() {\n        let credentials = AwsCredentials {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            session_token: None,\n        };\n        let result = authenticate_aws(credentials).await.unwrap();\n        assert!(!result.success);\n        assert!(result.message.contains(\"Access Key ID is required\"));\n    }\n\n    #[tokio::test]\n    async fn test_test_s3_bucket_access_invalid_credentials() {\n        let credentials = AwsCredentials {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            session_token: None,\n        };\n        let bucket_name = \"\".to_string();\n        // 入力不正時はAWS SDKのconfig生成前にバリデーションで弾くべきだが、現状はバリデーションがないため、\n        // ここでは最低限、関数がエラーを返すことだけ確認する\n        let result = test_s3_bucket_access(credentials, bucket_name).await;\n        assert!(result.is_err() || (result.is_ok() \u0026\u0026 !result.as_ref().unwrap().allowed));\n    }\n}\n\n","traces":[{"line":53,"address":[],"length":0,"stats":{"Line":6}},{"line":54,"address":[],"length":0,"stats":{"Line":6}},{"line":55,"address":[],"length":0,"stats":{"Line":3}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":196,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":4}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":207,"address":[],"length":0,"stats":{"Line":2}},{"line":208,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":2}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}}],"covered":29,"coverable":230},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","aws_operations.rs"],"content":"use serde::{Deserialize, Serialize};\nuse tauri::command;\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\nuse crate::internal::{InternalError, standardize_error};\n\n/// AWS接続設定\n#[derive(Debug, Deserialize, Clone)]\npub struct AwsConfig {\n    pub access_key_id: String,\n    pub secret_access_key: String,\n    pub region: String,\n    pub bucket_name: String,\n}\n\n/// AWS接続テスト結果\n#[derive(Debug, Serialize)]\npub struct ConnectionTestResult {\n    pub success: bool,\n    pub message: String,\n    pub bucket_accessible: bool,\n}\n\n/// S3オブジェクト情報\n#[derive(Debug, Serialize)]\npub struct S3Object {\n    pub key: String,\n    pub size: u64,\n    pub last_modified: String,\n    pub storage_class: String,\n    pub etag: String,\n}\n\n/// アップロード進捗情報\n#[derive(Debug, Serialize)]\npub struct UploadProgress {\n    pub uploaded_bytes: u64,\n    pub total_bytes: u64,\n    pub percentage: f64,\n    pub status: String,\n}\n\n/// ファイル復元情報\n#[derive(Debug, Serialize, Clone)]\npub struct RestoreInfo {\n    pub key: String,\n    pub restore_status: String, // \"in-progress\", \"completed\", \"failed\"\n    pub expiry_date: Option\u003cString\u003e,\n    pub tier: String, // Standard, Expedited, Bulk\n    pub request_time: String,\n    pub completion_time: Option\u003cString\u003e,\n}\n\n/// 復元状況監視結果\n#[derive(Debug, Serialize)]\npub struct RestoreStatusResult {\n    pub key: String,\n    pub is_restored: bool,\n    pub restore_status: String,\n    pub expiry_date: Option\u003cString\u003e,\n    pub error_message: Option\u003cString\u003e,\n}\n\n/// ダウンロード進捗情報\n#[derive(Debug, Serialize)]\npub struct DownloadProgress {\n    pub key: String,\n    pub downloaded_bytes: u64,\n    pub total_bytes: u64,\n    pub percentage: f64,\n    pub status: String, // \"downloading\", \"completed\", \"failed\"\n    pub local_path: Option\u003cString\u003e,\n}\n\n/// 復元通知情報\n#[derive(Debug, Serialize)]\npub struct RestoreNotification {\n    pub key: String,\n    pub status: String, // \"completed\", \"failed\", \"expired\"\n    pub message: String,\n    pub timestamp: String,\n}\n\n/// ライフサイクルルール詳細\n#[derive(Debug, Serialize, Clone)]\npub struct LifecycleRule {\n    pub id: String,\n    pub status: String,  // \"Enabled\" or \"Disabled\"\n    pub prefix: Option\u003cString\u003e,\n    pub transitions: Vec\u003cLifecycleTransition\u003e,\n}\n\n/// ライフサイクル移行設定\n#[derive(Debug, Serialize, Clone)]\npub struct LifecycleTransition {\n    pub days: i32,\n    pub storage_class: String,\n}\n\n// グローバルな復元状況管理\nlazy_static::lazy_static! {\n    static ref RESTORE_TRACKER: Arc\u003cMutex\u003cHashMap\u003cString, RestoreInfo\u003e\u003e\u003e = \n        Arc::new(Mutex::new(HashMap::new()));\n}\n\n/// AWS接続をテストする\n#[command]\npub async fn test_aws_connection(config: AwsConfig) -\u003e Result\u003cConnectionTestResult, String\u003e {\n    // TODO: AWS SDK for Rustを使った実装に置き換える\n    // 現在は基本的な検証のみ実行\n    \n    // 設定の基本検証\n    if config.access_key_id.is_empty() {\n        return Ok(ConnectionTestResult {\n            success: false,\n            message: \"Access Key ID is required\".to_string(),\n            bucket_accessible: false,\n        });\n    }\n    \n    if config.secret_access_key.is_empty() {\n        return Ok(ConnectionTestResult {\n            success: false,\n            message: \"Secret Access Key is required\".to_string(),\n            bucket_accessible: false,\n        });\n    }\n    \n    if config.region.is_empty() {\n        return Ok(ConnectionTestResult {\n            success: false,\n            message: \"Region is required\".to_string(),\n            bucket_accessible: false,\n        });\n    }\n    \n    if config.bucket_name.is_empty() {\n        return Ok(ConnectionTestResult {\n            success: false,\n            message: \"Bucket name is required\".to_string(),\n            bucket_accessible: false,\n        });\n    }\n    \n    // 将来の実装: AWS SDK for Rustを使った実際の接続テスト\n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // let result = s3_client.head_bucket().bucket(\u0026config.bucket_name).send().await;\n    \n    log::info!(\"AWS connection test requested for region: {}\", config.region);\n    log::info!(\"Target bucket: {}\", config.bucket_name);\n    \n    Ok(ConnectionTestResult {\n        success: true,\n        message: \"AWS configuration validated (mock)\".to_string(),\n        bucket_accessible: true,\n    })\n}\n\n/// S3バケット内のオブジェクト一覧を取得\n#[command]\npub async fn list_s3_objects(\n    config: AwsConfig,\n    prefix: Option\u003cString\u003e,\n) -\u003e Result\u003cVec\u003cS3Object\u003e, String\u003e {\n    // 本番用のS3クライアントを作成\n    let s3_client = create_real_s3_client(\u0026config).await?;\n    \n    // 内部関数を呼び出し\n    list_s3_objects_internal(s3_client.as_ref(), \u0026config.bucket_name, prefix.as_deref()).await\n}\n\n/// 内部実装：S3ClientTraitを使ったオブジェクト一覧取得\nasync fn list_s3_objects_internal(\n    s3_client: \u0026dyn S3ClientTrait,\n    bucket: \u0026str,\n    prefix: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003cVec\u003cS3Object\u003e, String\u003e {\n    log::info!(\"S3 object list requested for bucket: {}\", bucket);\n    if let Some(prefix) = prefix {\n        log::info!(\"With prefix: {}\", prefix);\n    }\n\n    // S3ClientTraitのlist_objectsを呼び出し\n    let objects = s3_client.list_objects(bucket, prefix).await?;\n    \n    log::info!(\"Retrieved {} objects from S3 bucket: {}\", objects.len(), bucket);\n    Ok(objects)\n}\n\n/// 本番用S3クライアントを作成\npub async fn create_s3_client(credentials: \u0026crate::commands::aws_auth::AwsCredentials) -\u003e Result\u003caws_sdk_s3::Client, String\u003e {\n    use aws_sdk_s3::config::{Credentials, Region};\n    use aws_sdk_s3::Config;\n    \n    // AWS認証情報を設定\n    let aws_credentials = Credentials::new(\n        \u0026credentials.access_key_id,\n        \u0026credentials.secret_access_key,\n        credentials.session_token.clone(),\n        None, // expiration\n        \"ReelVault\"\n    );\n\n    // AWS設定を構築\n    let aws_config = Config::builder()\n        .region(Region::new(credentials.region.clone()))\n        .credentials_provider(aws_credentials)\n        .build();\n\n    let s3_client = aws_sdk_s3::Client::from_conf(aws_config);\n    \n    Ok(s3_client)\n}\n\n/// 本番用S3クライアントを作成（AwsConfig用）\nasync fn create_real_s3_client(config: \u0026AwsConfig) -\u003e Result\u003cBox\u003cdyn S3ClientTrait\u003e, String\u003e {\n    use aws_sdk_s3::config::{Credentials, Region};\n    use aws_sdk_s3::Config;\n    \n    // AWS認証情報を設定\n    let credentials = Credentials::new(\n        \u0026config.access_key_id,\n        \u0026config.secret_access_key,\n        None, // session_token\n        None, // expiration\n        \"ReelVault\"\n    );\n\n    // AWS設定を構築\n    let aws_config = Config::builder()\n        .region(Region::new(config.region.clone()))\n        .credentials_provider(credentials)\n        .build();\n\n    let s3_client = aws_sdk_s3::Client::from_conf(aws_config);\n    \n    // RealS3Clientでラップして返す\n    Ok(Box::new(RealS3Client { client: s3_client }))\n}\n\n/// 本番用S3クライアントのラッパー\npub struct RealS3Client {\n    client: aws_sdk_s3::Client,\n}\n\nimpl RealS3Client {\n    pub fn new(client: aws_sdk_s3::Client) -\u003e Self {\n        Self { client }\n    }\n}\n\nimpl S3ClientTrait for RealS3Client {\n    fn list_objects\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, prefix: Option\u003c\u0026'a str\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cS3Object\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            // ListObjectsV2 リクエストを構築\n            let mut request = self.client.list_objects_v2().bucket(bucket);\n            if let Some(prefix) = prefix {\n                request = request.prefix(prefix);\n            }\n            \n            // S3 APIを実行\n            let result = request.send().await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            // レスポンスをS3Object構造体に変換\n            let mut objects = Vec::new();\n            for object in result.contents() {\n                if let (Some(key), Some(size), Some(last_modified)) = (\n                    object.key(),\n                    object.size(),\n                    object.last_modified()\n                ) {\n                    objects.push(S3Object {\n                        key: key.to_string(),\n                        size: size as u64,\n                        last_modified: last_modified.to_string(),\n                        storage_class: object.storage_class()\n                            .map(|sc| sc.as_str().to_string())\n                            .unwrap_or_else(|| \"STANDARD\".to_string()),\n                        etag: object.e_tag()\n                            .map(|etag| etag.to_string())\n                            .unwrap_or_else(|| \"\".to_string()),\n                    });\n                }\n            }\n            \n            Ok(objects)\n        })\n    }\n    \n    fn get_object\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cu8\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(b\"mock file content\".to_vec()) })\n    }\n    \n    fn put_object\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            use aws_sdk_s3::primitives::ByteStream;\n            \n            let body = ByteStream::from(data);\n            self.client\n                .put_object()\n                .bucket(bucket)\n                .key(key)\n                .body(body)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(())\n        })\n    }\n    \n    fn head_bucket\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            self.client\n                .head_bucket()\n                .bucket(bucket)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(())\n        })\n    }\n    \n    // マルチパートアップロード用メソッド\n    fn create_multipart_upload\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            let response = self.client\n                .create_multipart_upload()\n                .bucket(bucket)\n                .key(key)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            let upload_id = response.upload_id()\n                .ok_or_else(|| InternalError::S3(\"No upload ID returned\".to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(upload_id.to_string())\n        })\n    }\n    \n    fn upload_part\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, upload_id: \u0026'a str, part_number: i32, data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            use aws_sdk_s3::primitives::ByteStream;\n            \n            let response = self.client\n                .upload_part()\n                .bucket(bucket)\n                .key(key)\n                .upload_id(upload_id)\n                .part_number(part_number)\n                .body(ByteStream::from(data))\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            let etag = response.e_tag()\n                .ok_or_else(|| InternalError::S3(\"No ETag returned\".to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(etag.to_string())\n        })\n    }\n    \n    fn complete_multipart_upload\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, upload_id: \u0026'a str, parts: Vec\u003c(i32, String)\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            let completed_parts: Vec\u003caws_sdk_s3::types::CompletedPart\u003e = parts\n                .into_iter()\n                .map(|(part_number, etag)| {\n                    aws_sdk_s3::types::CompletedPart::builder()\n                        .part_number(part_number)\n                        .e_tag(etag)\n                        .build()\n                })\n                .collect();\n            \n            let completed_upload = aws_sdk_s3::types::CompletedMultipartUpload::builder()\n                .set_parts(Some(completed_parts))\n                .build();\n            \n            self.client\n                .complete_multipart_upload()\n                .bucket(bucket)\n                .key(key)\n                .upload_id(upload_id)\n                .multipart_upload(completed_upload)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(())\n        })\n    }\n    \n    // ライフサイクル関連メソッド\n    fn get_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cLifecycleRule\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            let response = self.client\n                .get_bucket_lifecycle_configuration()\n                .bucket(bucket)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            let rules: Vec\u003cLifecycleRule\u003e = response.rules()\n                .iter()\n                .map(|rule| {\n                    let transitions: Vec\u003cLifecycleTransition\u003e = rule.transitions()\n                        .iter()\n                        .map(|t| LifecycleTransition {\n                            days: t.days().unwrap_or(0),\n                            storage_class: match t.storage_class() {\n                                Some(aws_sdk_s3::types::TransitionStorageClass::DeepArchive) =\u003e \"DEEP_ARCHIVE\".to_string(),\n                                Some(aws_sdk_s3::types::TransitionStorageClass::Glacier) =\u003e \"GLACIER\".to_string(),\n                                Some(aws_sdk_s3::types::TransitionStorageClass::StandardIa) =\u003e \"STANDARD_IA\".to_string(),\n                                _ =\u003e \"UNKNOWN\".to_string(),\n                            }\n                        })\n                        .collect();\n                    \n                    LifecycleRule {\n                        id: rule.id().unwrap_or(\"\").to_string(),\n                        status: match rule.status() {\n                            aws_sdk_s3::types::ExpirationStatus::Enabled =\u003e \"Enabled\".to_string(),\n                            aws_sdk_s3::types::ExpirationStatus::Disabled =\u003e \"Disabled\".to_string(),\n                            _ =\u003e \"Unknown\".to_string(),\n                        },\n                        prefix: rule.filter()\n                            .and_then(|f| f.prefix())\n                            .map(|p| p.to_string()),\n                        transitions,\n                    }\n                })\n                .collect();\n            \n            Ok(rules)\n        })\n    }\n    \n    fn put_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, _rules: Vec\u003cLifecycleRule\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            // シンプルなモック実装\n            log::info!(\"Mock: Setting lifecycle configuration for bucket: {}\", bucket);\n            Ok(())\n        })\n    }\n    \n    fn delete_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            self.client\n                .delete_bucket_lifecycle()\n                .bucket(bucket)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            Ok(())\n        })\n    }\n    \n    fn get_bucket_location\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            let response = self.client\n                .get_bucket_location()\n                .bucket(bucket)\n                .send()\n                .await\n                .map_err(|e| InternalError::S3(e.to_string()))\n                .map_err(standardize_error)?;\n            \n            let location = response.location_constraint()\n                .map(|r| r.as_str())\n                .unwrap_or(\"us-east-1\");\n            \n            Ok(location.to_string())\n        })\n    }\n}\n\n/// Deep Archiveからファイルを復元する\n#[command]\npub async fn restore_file(\n    s3_key: String,\n    config: AwsConfig,\n    tier: String, // \"Standard\", \"Expedited\", \"Bulk\"\n) -\u003e Result\u003cRestoreInfo, String\u003e {\n    // 復元ティアの検証\n    match tier.as_str() {\n        \"Standard\" | \"Expedited\" | \"Bulk\" =\u003e {},\n        _ =\u003e return Err(standardize_error(InternalError::AwsConfig(format!(\"Invalid restore tier: {}. Must be Standard, Expedited, or Bulk\", tier)))),\n    }\n    \n    // TODO: AWS SDK for Rustを使った実際の復元リクエスト\n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // let restore_request = RestoreRequest::builder()\n    //     .days(7) // 復元期間\n    //     .glacier_job_parameters(\n    //         GlacierJobParameters::builder()\n    //             .tier(Tier::from(tier.as_str()))\n    //             .build()\n    //     )\n    //     .build();\n    // \n    // let result = s3_client\n    //     .restore_object()\n    //     .bucket(\u0026config.bucket_name)\n    //     .key(\u0026s3_key)\n    //     .restore_request(restore_request)\n    //     .send()\n    //     .await\n    //     .map_err(|e| e.to_string())?;\n    \n    log::info!(\"Restore requested for: s3://{}/{}\", config.bucket_name, s3_key);\n    log::info!(\"Restore tier: {}\", tier);\n    \n    let restore_info = RestoreInfo {\n        key: s3_key.clone(),\n        restore_status: \"in-progress\".to_string(),\n        expiry_date: Some(\"2024-01-22T00:00:00Z\".to_string()),\n        tier: tier.clone(),\n        request_time: chrono::Utc::now().to_rfc3339(),\n        completion_time: None,\n    };\n    \n    // 復元状況をトラッカーに追加\n    {\n        let mut tracker = RESTORE_TRACKER.lock().unwrap();\n        tracker.insert(s3_key, restore_info.clone());\n    }\n    \n    Ok(restore_info)\n}\n\n/// 復元状況を監視する\n#[command]\npub async fn check_restore_status(\n    s3_key: String,\n    config: AwsConfig,\n) -\u003e Result\u003cRestoreStatusResult, String\u003e {\n    // TODO: AWS SDK for Rustを使った実際の復元状況確認\n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // let result = s3_client\n    //     .head_object()\n    //     .bucket(\u0026config.bucket_name)\n    //     .key(\u0026s3_key)\n    //     .send()\n    //     .await\n    //     .map_err(|e| e.to_string())?;\n    // \n    // let is_restored = result.restore().is_some();\n    // let restore_status = if is_restored { \"completed\" } else { \"in-progress\" };\n    \n    log::info!(\"Checking restore status for: s3://{}/{}\", config.bucket_name, s3_key);\n    \n    // モック実装：復元状況をシミュレート\n    let mut tracker = RESTORE_TRACKER.lock().unwrap();\n    if let Some(restore_info) = tracker.get_mut(\u0026s3_key) {\n        // 簡単なシミュレーション：リクエストから5分後に完了とする\n        let request_time = chrono::DateTime::parse_from_rfc3339(\u0026restore_info.request_time)\n            .map_err(|e| InternalError::Metadata(format!(\"Failed to parse request time: {}\", e)))\n            .map_err(standardize_error)?;\n        let now = chrono::Utc::now();\n        let elapsed = now.signed_duration_since(request_time.with_timezone(\u0026chrono::Utc));\n        \n        if elapsed.num_minutes() \u003e= 5 \u0026\u0026 restore_info.restore_status == \"in-progress\" {\n            restore_info.restore_status = \"completed\".to_string();\n            restore_info.completion_time = Some(now.to_rfc3339());\n        }\n        \n        Ok(RestoreStatusResult {\n            key: s3_key,\n            is_restored: restore_info.restore_status == \"completed\",\n            restore_status: restore_info.restore_status.clone(),\n            expiry_date: restore_info.expiry_date.clone(),\n            error_message: None,\n        })\n    } else {\n        Ok(RestoreStatusResult {\n            key: s3_key,\n            is_restored: false,\n            restore_status: \"not-found\".to_string(),\n            expiry_date: None,\n            error_message: Some(\"Restore request not found\".to_string()),\n        })\n    }\n}\n\n/// 復元完了通知を取得する\n#[command]\npub async fn get_restore_notifications() -\u003e Result\u003cVec\u003cRestoreNotification\u003e, String\u003e {\n    let tracker = RESTORE_TRACKER.lock().unwrap();\n    let mut notifications = Vec::new();\n    \n    for (key, restore_info) in tracker.iter() {\n        if restore_info.restore_status == \"completed\" {\n            notifications.push(RestoreNotification {\n                key: key.clone(),\n                status: \"completed\".to_string(),\n                message: format!(\"File {} is ready for download\", key),\n                timestamp: restore_info.completion_time.clone()\n                    .unwrap_or_else(|| chrono::Utc::now().to_rfc3339()),\n            });\n        } else if restore_info.restore_status == \"failed\" {\n            notifications.push(RestoreNotification {\n                key: key.clone(),\n                status: \"failed\".to_string(),\n                message: format!(\"Restore failed for file {}\", key),\n                timestamp: chrono::Utc::now().to_rfc3339(),\n            });\n        }\n    }\n    \n    Ok(notifications)\n}\n\n/// 通常のS3ファイルをダウンロードする（復元不要）\n#[command]\npub async fn download_s3_file(\n    s3_key: String,\n    local_path: String,\n    config: AwsConfig,\n) -\u003e Result\u003cDownloadProgress, String\u003e {\n    // 本番用のS3クライアントを作成\n    let s3_client = create_real_s3_client(\u0026config).await?;\n    \n    // 内部関数を呼び出し\n    download_s3_file_internal(s3_client.as_ref(), \u0026s3_key, \u0026local_path, \u0026config.bucket_name).await\n}\n\n/// 内部実装：S3ClientTraitを使ったファイルダウンロード\nasync fn download_s3_file_internal(\n    s3_client: \u0026dyn S3ClientTrait,\n    s3_key: \u0026str,\n    local_path: \u0026str,\n    bucket: \u0026str,\n) -\u003e Result\u003cDownloadProgress, String\u003e {\n    use std::path::Path;\n    \n    // ローカルパスの検証\n    let path = Path::new(local_path);\n    if let Some(parent) = path.parent() {\n        if !parent.exists() {\n            std::fs::create_dir_all(parent)\n                .map_err(|e| InternalError::File(format!(\"Failed to create directory {}: {}\", parent.display(), e)))\n                .map_err(standardize_error)?;\n        }\n    }\n    \n    log::info!(\"Standard download requested: s3://{}/{} -\u003e {}\", bucket, s3_key, local_path);\n    \n    // S3ClientTraitのget_objectを呼び出し\n    let data = s3_client.get_object(bucket, s3_key).await?;\n    \n    // ローカルファイルに書き込み\n    std::fs::write(local_path, \u0026data)\n        .map_err(|e| InternalError::File(format!(\"Failed to write file {}: {}\", local_path, e)))\n        .map_err(standardize_error)?;\n    \n    let total_bytes = data.len() as u64;\n    \n    Ok(DownloadProgress {\n        key: s3_key.to_string(),\n        downloaded_bytes: total_bytes,\n        total_bytes,\n        percentage: 100.0,\n        status: \"completed\".to_string(),\n        local_path: Some(local_path.to_string()),\n    })\n}\n\n/// 復元されたファイルをダウンロードする\n#[command]\npub async fn download_restored_file(\n    s3_key: String,\n    local_path: String,\n    config: AwsConfig,\n) -\u003e Result\u003cDownloadProgress, String\u003e {\n    use std::path::Path;\n    \n    // ローカルパスの検証\n    let path = Path::new(\u0026local_path);\n    if let Some(parent) = path.parent() {\n        if !parent.exists() {\n            std::fs::create_dir_all(parent).map_err(|e| {\n                format!(\"Failed to create directory {}: {}\", parent.display(), e)\n            })?;\n        }\n    }\n    \n    // 復元状況の確認\n    let status_result = check_restore_status(s3_key.clone(), config.clone()).await?;\n    if !status_result.is_restored {\n        return Err(format!(\"File {} is not yet restored. Status: {}\", \n                          s3_key, status_result.restore_status));\n    }\n    \n    // TODO: AWS SDK for Rustを使った実際のダウンロード実装\n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // let result = s3_client\n    //     .get_object()\n    //     .bucket(\u0026config.bucket_name)\n    //     .key(\u0026s3_key)\n    //     .send()\n    //     .await\n    //     .map_err(|e| e.to_string())?;\n    // \n    // let mut file = tokio::fs::File::create(\u0026local_path).await\n    //     .map_err(|e| e.to_string())?;\n    // \n    // let mut stream = result.body.into_async_read();\n    // tokio::io::copy(\u0026mut stream, \u0026mut file).await\n    //     .map_err(|e| e.to_string())?;\n    \n    log::info!(\"Download requested: s3://{}/{} -\u003e {}\", \n               config.bucket_name, s3_key, local_path);\n    \n    // モック実装：ダウンロード進捗をシミュレート\n    let total_bytes = 1024 * 1024 * 100; // 100MB\n    \n    Ok(DownloadProgress {\n        key: s3_key,\n        downloaded_bytes: total_bytes,\n        total_bytes,\n        percentage: 100.0,\n        status: \"completed\".to_string(),\n        local_path: Some(local_path),\n    })\n}\n\n/// 復元中のファイル一覧を取得する\n#[command]\npub async fn list_restore_jobs() -\u003e Result\u003cVec\u003cRestoreInfo\u003e, String\u003e {\n    let tracker = RESTORE_TRACKER.lock().unwrap();\n    let restore_jobs: Vec\u003cRestoreInfo\u003e = tracker.values().cloned().collect();\n    Ok(restore_jobs)\n}\n\n/// 復元ジョブをキャンセルする（可能な場合）\n#[command]\npub async fn cancel_restore_job(s3_key: String) -\u003e Result\u003cbool, String\u003e {\n    let mut tracker = RESTORE_TRACKER.lock().unwrap();\n    \n    if let Some(restore_info) = tracker.get_mut(\u0026s3_key) {\n        if restore_info.restore_status == \"in-progress\" {\n            restore_info.restore_status = \"cancelled\".to_string();\n            log::info!(\"Restore job cancelled for: {}\", s3_key);\n            Ok(true)\n        } else {\n            Err(format!(\"Cannot cancel restore job for {}. Current status: {}\", \n                       s3_key, restore_info.restore_status))\n        }\n    } else {\n        Err(format!(\"Restore job not found for: {}\", s3_key))\n    }\n}\n\n/// 復元ジョブの履歴をクリアする\n#[command]\npub async fn clear_restore_history() -\u003e Result\u003cusize, String\u003e {\n    let mut tracker = RESTORE_TRACKER.lock().unwrap();\n    let count = tracker.len();\n    tracker.clear();\n    log::info!(\"Cleared {} restore job(s) from history\", count);\n    Ok(count)\n}\n\n// S3操作の抽象化トレイト\npub trait S3ClientTrait: Send + Sync {\n    fn list_objects\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, prefix: Option\u003c\u0026'a str\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cS3Object\u003e, String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn get_object\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cu8\u003e, String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn put_object\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn head_bucket\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    // マルチパートアップロード用メソッド\n    fn create_multipart_upload\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn upload_part\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, upload_id: \u0026'a str, part_number: i32, data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn complete_multipart_upload\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, key: \u0026'a str, upload_id: \u0026'a str, parts: Vec\u003c(i32, String)\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    // ライフサイクル関連メソッド\n    fn get_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cLifecycleRule\u003e, String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn put_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str, rules: Vec\u003cLifecycleRule\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn delete_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e;\n    fn get_bucket_location\u003c'a\u003e(\u0026'a self, bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e;\n}\n\n// テスト用モック実装\npub struct MockS3Client;\n\n#[cfg(test)]\nimpl S3ClientTrait for MockS3Client {\n    fn list_objects\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _prefix: Option\u003c\u0026'a str\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cS3Object\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            Ok(vec![S3Object {\n                key: \"mock/file.txt\".to_string(),\n                size: 123,\n                last_modified: \"2024-01-01T00:00:00Z\".to_string(),\n                storage_class: \"STANDARD\".to_string(),\n                etag: \"mock-etag\".to_string(),\n            }])\n        })\n    }\n    fn get_object\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cu8\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(b\"mock file content\".to_vec()) })\n    }\n    fn put_object\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _key: \u0026'a str, _data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(()) })\n    }\n    fn head_bucket\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(()) })\n    }\n    \n    // マルチパートアップロード用メソッド\n    fn create_multipart_upload\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _key: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(\"mock-upload-id\".to_string()) })\n    }\n    \n    fn upload_part\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _key: \u0026'a str, _upload_id: \u0026'a str, _part_number: i32, _data: Vec\u003cu8\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(\"mock-part-id\".to_string()) })\n    }\n    \n    fn complete_multipart_upload\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _key: \u0026'a str, _upload_id: \u0026'a str, _parts: Vec\u003c(i32, String)\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(()) })\n    }\n    \n    // ライフサイクル関連メソッド\n    fn get_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cVec\u003cLifecycleRule\u003e, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            // モックのReelVaultルールを返す\n            Ok(vec![\n                LifecycleRule {\n                    id: \"ReelVault-Default-Auto-Archive\".to_string(),\n                    status: \"Enabled\".to_string(),\n                    prefix: Some(\"uploads/\".to_string()),\n                    transitions: vec![\n                        LifecycleTransition {\n                            days: 1,\n                            storage_class: \"DEEP_ARCHIVE\".to_string(),\n                        }\n                    ],\n                }\n            ])\n        })\n    }\n    \n    fn put_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str, _rules: Vec\u003cLifecycleRule\u003e) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(()) })\n    }\n    \n    fn delete_bucket_lifecycle_configuration\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003c(), String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(()) })\n    }\n    \n    fn get_bucket_location\u003c'a\u003e(\u0026'a self, _bucket: \u0026'a str) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput=Result\u003cString, String\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move { Ok(\"us-east-1\".to_string()) })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_aws_config_creation() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        assert_eq!(config.access_key_id, \"AKIA1234567890\");\n        assert_eq!(config.secret_access_key, \"secret123\");\n        assert_eq!(config.region, \"ap-northeast-1\");\n        assert_eq!(config.bucket_name, \"test-bucket\");\n    }\n\n    #[test]\n    fn test_connection_test_result_creation() {\n        let result = ConnectionTestResult {\n            success: true,\n            message: \"Connection successful\".to_string(),\n            bucket_accessible: true,\n        };\n        \n        assert_eq!(result.success, true);\n        assert_eq!(result.message, \"Connection successful\");\n        assert_eq!(result.bucket_accessible, true);\n    }\n\n    #[test]\n    fn test_s3_object_creation() {\n        let s3_object = S3Object {\n            key: \"uploads/video.mp4\".to_string(),\n            size: 1024 * 1024 * 100, // 100MB\n            last_modified: \"2024-01-01T00:00:00Z\".to_string(),\n            storage_class: \"DEEP_ARCHIVE\".to_string(),\n            etag: \"abc123def456\".to_string(),\n        };\n        \n        assert_eq!(s3_object.key, \"uploads/video.mp4\");\n        assert_eq!(s3_object.size, 1024 * 1024 * 100);\n        assert_eq!(s3_object.last_modified, \"2024-01-01T00:00:00Z\");\n        assert_eq!(s3_object.storage_class, \"DEEP_ARCHIVE\");\n        assert_eq!(s3_object.etag, \"abc123def456\");\n    }\n\n    #[test]\n    fn test_upload_progress_creation() {\n        let progress = UploadProgress {\n            uploaded_bytes: 50 * 1024 * 1024, // 50MB\n            total_bytes: 100 * 1024 * 1024,   // 100MB\n            percentage: 50.0,\n            status: \"uploading\".to_string(),\n        };\n        \n        assert_eq!(progress.uploaded_bytes, 50 * 1024 * 1024);\n        assert_eq!(progress.total_bytes, 100 * 1024 * 1024);\n        assert_eq!(progress.percentage, 50.0);\n        assert_eq!(progress.status, \"uploading\");\n    }\n\n    #[test]\n    fn test_restore_info_creation() {\n        let restore_info = RestoreInfo {\n            key: \"uploads/video.mp4\".to_string(),\n            restore_status: \"in-progress\".to_string(),\n            expiry_date: Some(\"2024-01-08T00:00:00Z\".to_string()),\n            tier: \"Standard\".to_string(),\n            request_time: \"2024-01-01T00:00:00Z\".to_string(),\n            completion_time: None,\n        };\n        \n        assert_eq!(restore_info.key, \"uploads/video.mp4\");\n        assert_eq!(restore_info.restore_status, \"in-progress\");\n        assert_eq!(restore_info.expiry_date, Some(\"2024-01-08T00:00:00Z\".to_string()));\n        assert_eq!(restore_info.tier, \"Standard\");\n        assert_eq!(restore_info.request_time, \"2024-01-01T00:00:00Z\");\n        assert_eq!(restore_info.completion_time, None);\n    }\n\n    #[test]\n    fn test_restore_status_result_creation() {\n        let status_result = RestoreStatusResult {\n            key: \"uploads/video.mp4\".to_string(),\n            is_restored: false,\n            restore_status: \"in-progress\".to_string(),\n            expiry_date: Some(\"2024-01-08T00:00:00Z\".to_string()),\n            error_message: None,\n        };\n        \n        assert_eq!(status_result.key, \"uploads/video.mp4\");\n        assert_eq!(status_result.is_restored, false);\n        assert_eq!(status_result.restore_status, \"in-progress\");\n        assert_eq!(status_result.expiry_date, Some(\"2024-01-08T00:00:00Z\".to_string()));\n        assert_eq!(status_result.error_message, None);\n    }\n\n    #[test]\n    fn test_download_progress_creation() {\n        let download_progress = DownloadProgress {\n            key: \"uploads/video.mp4\".to_string(),\n            downloaded_bytes: 25 * 1024 * 1024, // 25MB\n            total_bytes: 100 * 1024 * 1024,     // 100MB\n            percentage: 25.0,\n            status: \"downloading\".to_string(),\n            local_path: Some(\"/tmp/video.mp4\".to_string()),\n        };\n        \n        assert_eq!(download_progress.key, \"uploads/video.mp4\");\n        assert_eq!(download_progress.downloaded_bytes, 25 * 1024 * 1024);\n        assert_eq!(download_progress.total_bytes, 100 * 1024 * 1024);\n        assert_eq!(download_progress.percentage, 25.0);\n        assert_eq!(download_progress.status, \"downloading\");\n        assert_eq!(download_progress.local_path, Some(\"/tmp/video.mp4\".to_string()));\n    }\n\n    #[test]\n    fn test_restore_notification_creation() {\n        let notification = RestoreNotification {\n            key: \"uploads/video.mp4\".to_string(),\n            status: \"completed\".to_string(),\n            message: \"Restore completed successfully\".to_string(),\n            timestamp: \"2024-01-01T00:00:00Z\".to_string(),\n        };\n        \n        assert_eq!(notification.key, \"uploads/video.mp4\");\n        assert_eq!(notification.status, \"completed\");\n        assert_eq!(notification.message, \"Restore completed successfully\");\n        assert_eq!(notification.timestamp, \"2024-01-01T00:00:00Z\");\n    }\n\n    #[tokio::test]\n    async fn test_test_aws_connection_success() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = test_aws_connection(config).await;\n        \n        assert!(result.is_ok());\n        let connection_result = result.unwrap();\n        assert_eq!(connection_result.success, true);\n        assert!(connection_result.message.contains(\"validated\"));\n        assert_eq!(connection_result.bucket_accessible, true);\n    }\n\n    #[tokio::test]\n    async fn test_test_aws_connection_empty_access_key() {\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = test_aws_connection(config).await;\n        \n        assert!(result.is_ok());\n        let connection_result = result.unwrap();\n        assert_eq!(connection_result.success, false);\n        assert!(connection_result.message.contains(\"Access Key ID is required\"));\n        assert_eq!(connection_result.bucket_accessible, false);\n    }\n\n    #[tokio::test]\n    async fn test_test_aws_connection_empty_secret_key() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = test_aws_connection(config).await;\n        \n        assert!(result.is_ok());\n        let connection_result = result.unwrap();\n        assert_eq!(connection_result.success, false);\n        assert!(connection_result.message.contains(\"Secret Access Key is required\"));\n        assert_eq!(connection_result.bucket_accessible, false);\n    }\n\n    #[tokio::test]\n    async fn test_test_aws_connection_empty_region() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = test_aws_connection(config).await;\n        \n        assert!(result.is_ok());\n        let connection_result = result.unwrap();\n        assert_eq!(connection_result.success, false);\n        assert!(connection_result.message.contains(\"Region is required\"));\n        assert_eq!(connection_result.bucket_accessible, false);\n    }\n\n    #[tokio::test]\n    async fn test_test_aws_connection_empty_bucket() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        \n        let result = test_aws_connection(config).await;\n        \n        assert!(result.is_ok());\n        let connection_result = result.unwrap();\n        assert_eq!(connection_result.success, false);\n        assert!(connection_result.message.contains(\"Bucket name is required\"));\n        assert_eq!(connection_result.bucket_accessible, false);\n    }\n\n    #[tokio::test]\n    async fn test_restore_file_basic() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = restore_file(\n            \"uploads/video.mp4\".to_string(),\n            config,\n            \"Standard\".to_string(),\n        ).await;\n        \n        assert!(result.is_ok());\n        let restore_info = result.unwrap();\n        assert_eq!(restore_info.key, \"uploads/video.mp4\");\n        assert_eq!(restore_info.tier, \"Standard\");\n        assert!(!restore_info.request_time.is_empty());\n    }\n\n    #[tokio::test]\n    async fn test_check_restore_status_basic() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        \n        let result = check_restore_status(\n            \"uploads/video.mp4\".to_string(),\n            config,\n        ).await;\n        \n        assert!(result.is_ok());\n        let status_result = result.unwrap();\n        assert_eq!(status_result.key, \"uploads/video.mp4\");\n        // モック実装なので、基本的な構造のみ確認\n        assert!(!status_result.restore_status.is_empty());\n    }\n\n    #[tokio::test]\n    async fn test_get_restore_notifications() {\n        let result = get_restore_notifications().await;\n        \n        assert!(result.is_ok());\n        let notifications = result.unwrap();\n        // モック実装なので、空の配列が返されることを確認\n        assert_eq!(notifications.len(), 0);\n    }\n\n    #[tokio::test]\n    async fn test_list_restore_jobs() {\n        let result = list_restore_jobs().await;\n        \n        assert!(result.is_ok());\n        let jobs = result.unwrap();\n        // モック実装なので、空の配列が返されることを確認\n        assert_eq!(jobs.len(), 0);\n    }\n\n    #[tokio::test]\n    async fn test_cancel_restore_job() {\n        let result = cancel_restore_job(\"uploads/video.mp4\".to_string()).await;\n        \n        assert!(result.is_err());\n        let error = result.unwrap_err();\n        // 存在しないジョブなのでエラーが返される\n        assert!(error.contains(\"Restore job not found\"));\n    }\n\n    #[tokio::test]\n    async fn test_clear_restore_history() {\n        let result = clear_restore_history().await;\n        \n        assert!(result.is_ok());\n        let cleared_count = result.unwrap();\n        // モック実装なので、0が返されることを確認\n        assert_eq!(cleared_count, 0);\n    }\n\n    #[test]\n    fn test_restore_tracker_static() {\n        // RESTORE_TRACKERの静的初期化をテスト\n        let tracker = \u0026*RESTORE_TRACKER;\n        let jobs = tracker.lock().unwrap();\n        // 他のテストでジョブが追加されている可能性があるので、0以上であることを確認\n        assert!(jobs.len() \u003e= 0);\n    }\n\n    #[tokio::test]\n    async fn test_list_s3_objects_with_mock() {\n        // モッククライアントを使用したテスト\n        let mock_client = MockS3Client;\n        let bucket = \"test-bucket\";\n        let prefix = Some(\"test-prefix\");\n        \n        let result = list_s3_objects_internal(\u0026mock_client, bucket, prefix).await;\n        assert!(result.is_ok());\n        \n        let objects = result.unwrap();\n        assert_eq!(objects.len(), 1);\n        assert_eq!(objects[0].key, \"mock/file.txt\");\n        assert_eq!(objects[0].size, 123);\n        assert_eq!(objects[0].storage_class, \"STANDARD\");\n    }\n\n    #[tokio::test]\n    async fn test_list_s3_objects_with_mock_no_prefix() {\n        // プレフィックスなしでのモックテスト\n        let mock_client = MockS3Client;\n        let bucket = \"test-bucket\";\n        let prefix = None;\n        \n        let result = list_s3_objects_internal(\u0026mock_client, bucket, prefix).await;\n        assert!(result.is_ok());\n        \n        let objects = result.unwrap();\n        assert_eq!(objects.len(), 1);\n        assert_eq!(objects[0].key, \"mock/file.txt\");\n    }\n\n    #[tokio::test]\n    async fn test_download_s3_file_with_mock() {\n        // モッククライアントを使用したダウンロードテスト\n        let mock_client = MockS3Client;\n        let s3_key = \"test/file.txt\";\n        let local_path = \"/tmp/test_download.txt\";\n        let bucket = \"test-bucket\";\n        \n        let result = download_s3_file_internal(\u0026mock_client, s3_key, local_path, bucket).await;\n        assert!(result.is_ok());\n        \n        let progress = result.unwrap();\n        assert_eq!(progress.key, s3_key);\n        assert_eq!(progress.status, \"completed\");\n        assert_eq!(progress.percentage, 100.0);\n        assert_eq!(progress.local_path, Some(local_path.to_string()));\n        \n        // ダウンロードされたファイルの内容を確認\n        let file_content = std::fs::read_to_string(local_path).unwrap();\n        assert_eq!(file_content, \"mock file content\");\n        \n        // テストファイルを削除\n        let _ = std::fs::remove_file(local_path);\n    }\n} ","traces":[{"line":108,"address":[],"length":0,"stats":{"Line":10}},{"line":113,"address":[],"length":0,"stats":{"Line":5}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":117,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":125,"address":[],"length":0,"stats":{"Line":1}},{"line":129,"address":[],"length":0,"stats":{"Line":3}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":1}},{"line":141,"address":[],"length":0,"stats":{"Line":1}},{"line":150,"address":[],"length":0,"stats":{"Line":1}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":2}},{"line":179,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":3}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":4}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":6}},{"line":198,"address":[],"length":0,"stats":{"Line":3}},{"line":199,"address":[],"length":0,"stats":{"Line":3}},{"line":200,"address":[],"length":0,"stats":{"Line":3}},{"line":201,"address":[],"length":0,"stats":{"Line":3}},{"line":206,"address":[],"length":0,"stats":{"Line":3}},{"line":207,"address":[],"length":0,"stats":{"Line":3}},{"line":208,"address":[],"length":0,"stats":{"Line":3}},{"line":211,"address":[],"length":0,"stats":{"Line":3}},{"line":213,"address":[],"length":0,"stats":{"Line":3}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":3}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":2}},{"line":317,"address":[],"length":0,"stats":{"Line":4}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":319,"address":[],"length":0,"stats":{"Line":2}},{"line":320,"address":[],"length":0,"stats":{"Line":2}},{"line":321,"address":[],"length":0,"stats":{"Line":2}},{"line":322,"address":[],"length":0,"stats":{"Line":2}},{"line":323,"address":[],"length":0,"stats":{"Line":6}},{"line":324,"address":[],"length":0,"stats":{"Line":4}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":1}},{"line":407,"address":[],"length":0,"stats":{"Line":2}},{"line":408,"address":[],"length":0,"stats":{"Line":1}},{"line":409,"address":[],"length":0,"stats":{"Line":1}},{"line":410,"address":[],"length":0,"stats":{"Line":1}},{"line":411,"address":[],"length":0,"stats":{"Line":1}},{"line":412,"address":[],"length":0,"stats":{"Line":1}},{"line":413,"address":[],"length":0,"stats":{"Line":3}},{"line":414,"address":[],"length":0,"stats":{"Line":2}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":1}},{"line":500,"address":[],"length":0,"stats":{"Line":1}},{"line":501,"address":[],"length":0,"stats":{"Line":2}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":1}},{"line":528,"address":[],"length":0,"stats":{"Line":1}},{"line":531,"address":[],"length":0,"stats":{"Line":1}},{"line":532,"address":[],"length":0,"stats":{"Line":1}},{"line":533,"address":[],"length":0,"stats":{"Line":1}},{"line":534,"address":[],"length":0,"stats":{"Line":1}},{"line":535,"address":[],"length":0,"stats":{"Line":1}},{"line":541,"address":[],"length":0,"stats":{"Line":1}},{"line":542,"address":[],"length":0,"stats":{"Line":1}},{"line":545,"address":[],"length":0,"stats":{"Line":1}},{"line":550,"address":[],"length":0,"stats":{"Line":1}},{"line":569,"address":[],"length":0,"stats":{"Line":1}},{"line":572,"address":[],"length":0,"stats":{"Line":1}},{"line":573,"address":[],"length":0,"stats":{"Line":1}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":1}},{"line":595,"address":[],"length":0,"stats":{"Line":1}},{"line":596,"address":[],"length":0,"stats":{"Line":1}},{"line":597,"address":[],"length":0,"stats":{"Line":1}},{"line":598,"address":[],"length":0,"stats":{"Line":1}},{"line":599,"address":[],"length":0,"stats":{"Line":1}},{"line":606,"address":[],"length":0,"stats":{"Line":2}},{"line":607,"address":[],"length":0,"stats":{"Line":1}},{"line":608,"address":[],"length":0,"stats":{"Line":1}},{"line":610,"address":[],"length":0,"stats":{"Line":1}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":1}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":1}},{"line":656,"address":[],"length":0,"stats":{"Line":1}},{"line":657,"address":[],"length":0,"stats":{"Line":2}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":1}},{"line":668,"address":[],"length":0,"stats":{"Line":1}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":1}},{"line":677,"address":[],"length":0,"stats":{"Line":1}},{"line":678,"address":[],"length":0,"stats":{"Line":1}},{"line":679,"address":[],"length":0,"stats":{"Line":1}},{"line":680,"address":[],"length":0,"stats":{"Line":1}},{"line":681,"address":[],"length":0,"stats":{"Line":1}},{"line":682,"address":[],"length":0,"stats":{"Line":1}},{"line":683,"address":[],"length":0,"stats":{"Line":1}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":2}},{"line":751,"address":[],"length":0,"stats":{"Line":1}},{"line":752,"address":[],"length":0,"stats":{"Line":1}},{"line":753,"address":[],"length":0,"stats":{"Line":1}},{"line":758,"address":[],"length":0,"stats":{"Line":2}},{"line":759,"address":[],"length":0,"stats":{"Line":1}},{"line":761,"address":[],"length":0,"stats":{"Line":1}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":1}},{"line":777,"address":[],"length":0,"stats":{"Line":2}},{"line":778,"address":[],"length":0,"stats":{"Line":1}},{"line":779,"address":[],"length":0,"stats":{"Line":1}},{"line":780,"address":[],"length":0,"stats":{"Line":1}},{"line":781,"address":[],"length":0,"stats":{"Line":1}},{"line":782,"address":[],"length":0,"stats":{"Line":1}}],"covered":110,"coverable":328},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","config.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::PathBuf;\nuse tauri::{AppHandle, Manager};\nuse crate::internal::{InternalError, standardize_error};\n\n// 設定データ構造\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AppConfig {\n    pub version: String,\n    pub app_settings: AppSettings,\n    pub user_preferences: UserPreferences,\n    pub aws_settings: AwsSettings,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AppSettings {\n    pub log_level: String,\n    pub theme: String,\n    pub language: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UserPreferences {\n    pub default_bucket_name: Option\u003cString\u003e,\n    pub default_storage_class: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AwsSettings {\n    pub default_region: String,\n    pub timeout_seconds: u64,\n    pub max_retries: u32,\n    pub profile_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct ConfigValidationResult {\n    pub valid: bool,\n    pub errors: Vec\u003cString\u003e,\n    pub warnings: Vec\u003cString\u003e,\n}\n\n// デフォルト設定実装\nimpl Default for AppConfig {\n    fn default() -\u003e Self {\n        AppConfig {\n            version: \"1.0.0\".to_string(),\n            app_settings: AppSettings::default(),\n            user_preferences: UserPreferences::default(),\n            aws_settings: AwsSettings::default(),\n        }\n    }\n}\n\nimpl Default for AppSettings {\n    fn default() -\u003e Self {\n        AppSettings {\n            log_level: \"info\".to_string(),\n            theme: \"dark\".to_string(),\n            language: \"ja\".to_string(),\n        }\n    }\n}\n\nimpl Default for UserPreferences {\n    fn default() -\u003e Self {\n        UserPreferences {\n            default_bucket_name: None,\n            default_storage_class: \"DEEP_ARCHIVE\".to_string(),\n        }\n    }\n}\n\nimpl Default for AwsSettings {\n    fn default() -\u003e Self {\n        AwsSettings {\n            default_region: \"ap-northeast-1\".to_string(), // Default to Tokyo region\n            timeout_seconds: 300,\n            max_retries: 3,\n            profile_name: None,\n        }\n    }\n}\n\n// 設定ファイルパス取得\nfn get_config_path(app: \u0026AppHandle) -\u003e Result\u003cPathBuf, InternalError\u003e {\n    let app_data_dir = app\n        .path()\n        .app_data_dir()\n        .map_err(|e| InternalError::Config(format!(\"Failed to get app data directory: {}\", e)))?;\n    \n    // ディレクトリが存在しない場合は作成\n    if !app_data_dir.exists() {\n        fs::create_dir_all(\u0026app_data_dir)\n            .map_err(|e| InternalError::Config(format!(\"Failed to create app data directory: {}\", e)))?;\n    }\n    \n    Ok(app_data_dir.join(\"config.json\"))\n}\n\n// バックアップファイルパス取得\nfn get_backup_path(app: \u0026AppHandle) -\u003e Result\u003cPathBuf, InternalError\u003e {\n    let app_data_dir = app\n        .path()\n        .app_data_dir()\n        .map_err(|e| InternalError::Config(format!(\"Failed to get app data directory: {}\", e)))?;\n    \n    Ok(app_data_dir.join(\"config.backup.json\"))\n}\n\n// 設定検証\nfn validate_config(config: \u0026AppConfig) -\u003e ConfigValidationResult {\n    let mut errors = Vec::new();\n    let mut warnings = Vec::new();\n\n    // バージョン検証\n    if config.version.is_empty() {\n        errors.push(\"Config version cannot be empty\".to_string());\n    }\n\n    // ログレベル検証\n    let valid_log_levels = [\"info\", \"debug\"];\n    if !valid_log_levels.contains(\u0026config.app_settings.log_level.as_str()) {\n        errors.push(format!(\"Invalid log level: {}\", config.app_settings.log_level));\n    }\n\n    // テーマ検証\n    let valid_themes = [\"light\", \"dark\", \"auto\"];\n    if !valid_themes.contains(\u0026config.app_settings.theme.as_str()) {\n        warnings.push(format!(\"Unknown theme: {}\", config.app_settings.theme));\n    }\n\n    // AWS設定検証\n    if config.aws_settings.timeout_seconds == 0 {\n        errors.push(\"AWS timeout cannot be zero\".to_string());\n    }\n\n    if config.aws_settings.timeout_seconds \u003e 3600 {\n        warnings.push(\"AWS timeout is very long (\u003e1 hour)\".to_string());\n    }\n\n    // ストレージクラス検証\n    let valid_storage_classes = [\"STANDARD\", \"STANDARD_IA\", \"ONEZONE_IA\", \"REDUCED_REDUNDANCY\", \"GLACIER\", \"DEEP_ARCHIVE\"];\n    if !valid_storage_classes.contains(\u0026config.user_preferences.default_storage_class.as_str()) {\n        errors.push(format!(\"Invalid storage class: {}\", config.user_preferences.default_storage_class));\n    }\n\n    ConfigValidationResult {\n        valid: errors.is_empty(),\n        errors,\n        warnings,\n    }\n}\n\n// Tauri Commands\n\n#[tauri::command]\npub async fn get_config(app: AppHandle) -\u003e Result\u003cAppConfig, String\u003e {\n    let config_path = get_config_path(\u0026app)\n        .map_err(standardize_error)?;\n    \n    if !config_path.exists() {\n        // 設定ファイルが存在しない場合はデフォルト設定を返す\n        let default_config = AppConfig::default();\n        return Ok(default_config);\n    }\n\n    let config_content = fs::read_to_string(\u0026config_path)\n        .map_err(|e| InternalError::Config(format!(\"Failed to read config file: {}\", e)))\n        .map_err(standardize_error)?;\n\n    let config: AppConfig = serde_json::from_str(\u0026config_content)\n        .map_err(|e| InternalError::Config(format!(\"Failed to parse config file: {}\", e)))\n        .map_err(standardize_error)?;\n\n    Ok(config)\n}\n\n#[tauri::command]\npub async fn set_config(app: AppHandle, config: AppConfig) -\u003e Result\u003cbool, String\u003e {\n    // 設定検証\n    let validation = validate_config(\u0026config);\n    if !validation.valid {\n        return Err(standardize_error(InternalError::Other(format!(\"Config validation failed: {}\", validation.errors.join(\", \")))));\n    }\n\n    let config_path = get_config_path(\u0026app)\n        .map_err(standardize_error)?;\n    \n    // 既存の設定をバックアップ\n    if config_path.exists() {\n        let backup_path = get_backup_path(\u0026app)\n            .map_err(standardize_error)?;\n        fs::copy(\u0026config_path, \u0026backup_path)\n            .map_err(|e| InternalError::Config(format!(\"Failed to create backup: {}\", e)))\n            .map_err(standardize_error)?;\n    }\n\n    // 新しい設定を保存\n    let config_json = serde_json::to_string_pretty(\u0026config)\n        .map_err(|e| InternalError::Config(format!(\"Failed to serialize config: {}\", e)))\n        .map_err(standardize_error)?;\n\n    fs::write(\u0026config_path, config_json)\n        .map_err(|e| InternalError::Config(format!(\"Failed to write config file: {}\", e)))\n        .map_err(standardize_error)?;\n\n    Ok(true)\n}\n\n#[tauri::command]\npub async fn update_config(app: AppHandle, updates: HashMap\u003cString, serde_json::Value\u003e) -\u003e Result\u003cAppConfig, String\u003e {\n    // 現在の設定を取得\n    let mut config = get_config(app.clone()).await?;\n\n    // 更新を適用\n    for (key, value) in updates {\n        match key.as_str() {\n\n            \"app_settings.log_level\" =\u003e {\n                if let Some(v) = value.as_str() {\n                    config.app_settings.log_level = v.to_string();\n                }\n            }\n            \"app_settings.theme\" =\u003e {\n                if let Some(v) = value.as_str() {\n                    config.app_settings.theme = v.to_string();\n                }\n            }\n            \"app_settings.language\" =\u003e {\n                if let Some(v) = value.as_str() {\n                    config.app_settings.language = v.to_string();\n                }\n            }\n            \"user_preferences.default_bucket_name\" =\u003e {\n                config.user_preferences.default_bucket_name = value.as_str().map(String::from);\n            }\n            \"user_preferences.default_storage_class\" =\u003e {\n                if let Some(v) = value.as_str() {\n                    config.user_preferences.default_storage_class = v.to_string();\n                }\n            }\n\n            \"aws_settings.default_region\" =\u003e {\n                if let Some(v) = value.as_str() {\n                    config.aws_settings.default_region = v.to_string();\n                }\n            }\n            \"aws_settings.timeout_seconds\" =\u003e {\n                if let Some(v) = value.as_u64() {\n                    config.aws_settings.timeout_seconds = v;\n                }\n            }\n            \"aws_settings.max_retries\" =\u003e {\n                if let Some(v) = value.as_u64() {\n                    config.aws_settings.max_retries = v as u32;\n                }\n            }\n            \"aws_settings.profile_name\" =\u003e {\n                config.aws_settings.profile_name = value.as_str().map(String::from);\n            }\n            _ =\u003e {\n                return Err(standardize_error(InternalError::Other(format!(\"Unknown config key: {}\", key))));\n            }\n        }\n    }\n\n    // 更新された設定を保存\n    set_config(app, config.clone()).await?;\n    \n    Ok(config)\n}\n\n#[tauri::command]\npub async fn reset_config(app: AppHandle) -\u003e Result\u003cAppConfig, String\u003e {\n    let default_config = AppConfig::default();\n    set_config(app, default_config.clone()).await?;\n    Ok(default_config)\n}\n\n#[tauri::command]\npub async fn validate_config_file(app: AppHandle) -\u003e Result\u003cConfigValidationResult, String\u003e {\n    let config = get_config(app).await?;\n    Ok(validate_config(\u0026config))\n}\n\n#[tauri::command]\npub async fn validate_config_data(config: AppConfig) -\u003e Result\u003cConfigValidationResult, String\u003e {\n    // 渡された設定を直接検証（保存せずに）\n    Ok(validate_config(\u0026config))\n}\n\n#[tauri::command]\npub async fn backup_config(app: AppHandle) -\u003e Result\u003cString, String\u003e {\n    let config_path = get_config_path(\u0026app)\n        .map_err(standardize_error)?;\n    \n    if !config_path.exists() {\n        return Err(standardize_error(InternalError::Other(\"No config file to backup\".to_string())));\n    }\n\n    let timestamp = chrono::Utc::now().format(\"%Y%m%d_%H%M%S\");\n    let app_data_dir = app\n        .path()\n        .app_data_dir()\n        .map_err(|e| InternalError::Config(format!(\"Failed to get app data directory: {}\", e)))\n        .map_err(standardize_error)?;\n    \n    let backup_path = app_data_dir.join(format!(\"config_backup_{}.json\", timestamp));\n    \n    fs::copy(\u0026config_path, \u0026backup_path)\n        .map_err(|e| InternalError::Config(format!(\"Failed to create backup: {}\", e)))\n        .map_err(standardize_error)?;\n\n    Ok(backup_path.to_string_lossy().to_string())\n}\n\n#[tauri::command]\npub async fn export_config(app: AppHandle, export_path: Option\u003cString\u003e) -\u003e Result\u003cString, String\u003e {\n    let config_path = get_config_path(\u0026app)\n        .map_err(standardize_error)?;\n    \n    if !config_path.exists() {\n        return Err(standardize_error(InternalError::Other(\"設定ファイルが存在しません\".to_string())));\n    }\n\n    let destination_path = if let Some(path) = export_path {\n        PathBuf::from(path)\n    } else {\n        // デフォルトのエクスポートパス（デスクトップにタイムスタンプ付きで）\n        let home_dir = std::env::var(\"HOME\")\n            .or_else(|_| std::env::var(\"USERPROFILE\"))\n            .map_err(|_| InternalError::Config(\"ホームディレクトリが取得できません\".to_string()))\n            .map_err(standardize_error)?;\n        \n        let desktop_path = PathBuf::from(home_dir).join(\"Desktop\");\n        let timestamp = chrono::Utc::now().format(\"%Y%m%d_%H%M%S\");\n        desktop_path.join(format!(\"ReelVault_Config_{}.json\", timestamp))\n    };\n\n    fs::copy(\u0026config_path, \u0026destination_path)\n        .map_err(|e| InternalError::Config(format!(\"設定のエクスポートに失敗しました: {}\", e)))\n        .map_err(standardize_error)?;\n\n    Ok(destination_path.to_string_lossy().to_string())\n}\n\n#[tauri::command]\npub async fn import_config(app: AppHandle, import_path: String) -\u003e Result\u003cAppConfig, String\u003e {\n    let import_file = PathBuf::from(import_path);\n    \n    if !import_file.exists() {\n        return Err(standardize_error(InternalError::Other(\"インポートファイルが存在しません\".to_string())));\n    }\n\n    if !import_file.is_file() {\n        return Err(standardize_error(InternalError::Other(\"指定されたパスはファイルではありません\".to_string())));\n    }\n\n    // インポートファイルの読み込み\n    let import_content = fs::read_to_string(\u0026import_file)\n        .map_err(|e| InternalError::Config(format!(\"インポートファイルの読み込みに失敗しました: {}\", e)))\n        .map_err(standardize_error)?;\n\n    // JSONとして解析\n    let imported_config: AppConfig = serde_json::from_str(\u0026import_content)\n        .map_err(|e| InternalError::Config(format!(\"設定ファイルの形式が正しくありません: {}\", e)))\n        .map_err(standardize_error)?;\n\n    // インポートされた設定を検証\n    let validation = validate_config(\u0026imported_config);\n    if !validation.valid {\n        return Err(standardize_error(InternalError::Other(format!(\"インポートされた設定に問題があります: {}\", validation.errors.join(\", \")))));\n    }\n\n    // 現在の設定をバックアップしてから新しい設定を適用\n    let config_path = get_config_path(\u0026app)\n        .map_err(standardize_error)?;\n    if config_path.exists() {\n        let backup_path = get_backup_path(\u0026app)\n            .map_err(standardize_error)?;\n        fs::copy(\u0026config_path, \u0026backup_path)\n            .map_err(|e| InternalError::Config(format!(\"既存設定のバックアップに失敗しました: {}\", e)))\n            .map_err(standardize_error)?;\n    }\n\n    // 新しい設定を保存\n    let config_json = serde_json::to_string_pretty(\u0026imported_config)\n        .map_err(|e| InternalError::Config(format!(\"設定の保存に失敗しました: {}\", e)))\n        .map_err(standardize_error)?;\n\n    fs::write(\u0026config_path, config_json)\n        .map_err(|e| InternalError::Config(format!(\"設定ファイルの書き込みに失敗しました: {}\", e)))\n        .map_err(standardize_error)?;\n\n    Ok(imported_config)\n}\n\n#[tauri::command]\npub async fn restore_config(app: AppHandle, backup_path: String) -\u003e Result\u003cAppConfig, String\u003e {\n    let backup_file = PathBuf::from(backup_path);\n    \n    if !backup_file.exists() {\n        return Err(standardize_error(InternalError::Other(\"Backup file does not exist\".to_string())));\n    }\n\n    let backup_content = fs::read_to_string(\u0026backup_file)\n        .map_err(|e| InternalError::Config(format!(\"Failed to read backup file: {}\", e)))\n        .map_err(standardize_error)?;\n\n    let config: AppConfig = serde_json::from_str(\u0026backup_content)\n        .map_err(|e| InternalError::Config(format!(\"Failed to parse backup file: {}\", e)))\n        .map_err(standardize_error)?;\n\n    // 設定検証\n    let validation = validate_config(\u0026config);\n    if !validation.valid {\n        return Err(standardize_error(InternalError::Other(format!(\"Backup config validation failed: {}\", validation.errors.join(\", \")))));\n    }\n\n    // 復元実行\n    set_config(app, config.clone()).await?;\n    \n    Ok(config)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_app_config_default() {\n        let config = AppConfig::default();\n        assert_eq!(config.version, \"1.0.0\");\n        assert_eq!(config.app_settings.log_level, \"info\");\n        assert_eq!(config.app_settings.theme, \"dark\");\n        assert_eq!(config.app_settings.language, \"ja\");\n        assert_eq!(config.aws_settings.default_region, \"ap-northeast-1\");\n        assert_eq!(config.aws_settings.timeout_seconds, 300);\n        assert_eq!(config.aws_settings.max_retries, 3);\n        assert_eq!(config.user_preferences.default_storage_class, \"DEEP_ARCHIVE\");\n    }\n\n    #[test]\n    fn test_validate_config_valid() {\n        let config = AppConfig::default();\n        let result = validate_config(\u0026config);\n        assert!(result.valid);\n        assert!(result.errors.is_empty());\n    }\n\n    #[test]\n    fn test_validate_config_invalid_log_level() {\n        let mut config = AppConfig::default();\n        config.app_settings.log_level = \"invalid\".to_string();\n        let result = validate_config(\u0026config);\n        assert!(!result.valid);\n        assert!(result.errors.iter().any(|e| e.contains(\"Invalid log level\")));\n    }\n\n    #[test]\n    fn test_validate_config_invalid_storage_class() {\n        let mut config = AppConfig::default();\n        config.user_preferences.default_storage_class = \"INVALID_CLASS\".to_string();\n        let result = validate_config(\u0026config);\n        assert!(!result.valid);\n        assert!(result.errors.iter().any(|e| e.contains(\"Invalid storage class\")));\n    }\n\n    #[tokio::test]\n    async fn test_get_config_success() {\n        // AppHandleのモックは複雑なので、基本的な構造体テストのみ実行\n        let default_config = AppConfig::default();\n        assert_eq!(default_config.app_settings.log_level, \"info\");\n        assert_eq!(default_config.user_preferences.default_storage_class, \"DEEP_ARCHIVE\");\n        assert_eq!(default_config.aws_settings.default_region, \"ap-northeast-1\");\n    }\n\n    #[tokio::test]\n    async fn test_set_config_structure() {\n        let new_config = AppConfig {\n            version: \"1.0.0\".to_string(),\n            app_settings: AppSettings {\n                log_level: \"debug\".to_string(),\n                theme: \"dark\".to_string(),\n                language: \"en\".to_string(),\n            },\n            user_preferences: UserPreferences {\n                default_bucket_name: Some(\"test-bucket\".to_string()),\n                default_storage_class: \"GLACIER\".to_string(),\n            },\n            aws_settings: AwsSettings {\n                default_region: \"us-west-2\".to_string(),\n                timeout_seconds: 600,\n                max_retries: 5,\n                profile_name: Some(\"test-profile\".to_string()),\n            },\n        };\n        \n        // 構造体の検証\n        assert_eq!(new_config.app_settings.log_level, \"debug\");\n        assert_eq!(new_config.user_preferences.default_storage_class, \"GLACIER\");\n        assert_eq!(new_config.aws_settings.default_region, \"us-west-2\");\n    }\n\n    #[tokio::test]\n    async fn test_config_validation_result() {\n        let validation = ConfigValidationResult {\n            valid: true,\n            errors: vec![],\n            warnings: vec![\"Test warning\".to_string()],\n        };\n        \n        assert!(validation.valid);\n        assert_eq!(validation.errors.len(), 0);\n        assert_eq!(validation.warnings.len(), 1);\n        assert_eq!(validation.warnings[0], \"Test warning\");\n    }\n\n    #[tokio::test]\n    async fn test_config_validation_with_errors() {\n        let validation = ConfigValidationResult {\n            valid: false,\n            errors: vec![\"Error 1\".to_string(), \"Error 2\".to_string()],\n            warnings: vec![],\n        };\n        \n        assert!(!validation.valid);\n        assert_eq!(validation.errors.len(), 2);\n        assert_eq!(validation.warnings.len(), 0);\n        assert!(validation.errors.contains(\u0026\"Error 1\".to_string()));\n        assert!(validation.errors.contains(\u0026\"Error 2\".to_string()));\n    }\n\n    #[tokio::test]\n    async fn test_validate_config_function() {\n        let config = AppConfig::default();\n        let validation = validate_config(\u0026config);\n        \n        // デフォルト設定は有効\n        assert!(validation.valid);\n        assert_eq!(validation.errors.len(), 0);\n    }\n\n    #[tokio::test]\n    async fn test_validate_config_function_invalid_log_level() {\n        let mut config = AppConfig::default();\n        config.app_settings.log_level = \"invalid\".to_string();\n        let validation = validate_config(\u0026config);\n        \n        assert!(!validation.valid);\n        assert!(validation.errors.iter().any(|e| e.contains(\"Invalid log level\")));\n    }\n\n    #[tokio::test]\n    async fn test_validate_config_function_invalid_storage_class() {\n        let mut config = AppConfig::default();\n        config.user_preferences.default_storage_class = \"INVALID\".to_string();\n        let validation = validate_config(\u0026config);\n        \n        assert!(!validation.valid);\n        assert!(validation.errors.iter().any(|e| e.contains(\"Invalid storage class\")));\n    }\n}\n\n ","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":8}},{"line":49,"address":[],"length":0,"stats":{"Line":8}},{"line":50,"address":[],"length":0,"stats":{"Line":8}},{"line":51,"address":[],"length":0,"stats":{"Line":8}},{"line":52,"address":[],"length":0,"stats":{"Line":8}},{"line":58,"address":[],"length":0,"stats":{"Line":8}},{"line":60,"address":[],"length":0,"stats":{"Line":8}},{"line":61,"address":[],"length":0,"stats":{"Line":8}},{"line":62,"address":[],"length":0,"stats":{"Line":8}},{"line":68,"address":[],"length":0,"stats":{"Line":8}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":77,"address":[],"length":0,"stats":{"Line":8}},{"line":79,"address":[],"length":0,"stats":{"Line":8}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":6}},{"line":115,"address":[],"length":0,"stats":{"Line":6}},{"line":116,"address":[],"length":0,"stats":{"Line":6}},{"line":119,"address":[],"length":0,"stats":{"Line":6}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":6}},{"line":125,"address":[],"length":0,"stats":{"Line":8}},{"line":126,"address":[],"length":0,"stats":{"Line":2}},{"line":130,"address":[],"length":0,"stats":{"Line":6}},{"line":131,"address":[],"length":0,"stats":{"Line":6}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":6}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":6}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":6}},{"line":146,"address":[],"length":0,"stats":{"Line":8}},{"line":147,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":6}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}}],"covered":28,"coverable":193},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","file_operations.rs"],"content":"use std::path::PathBuf;\nuse std::sync::mpsc::channel;\nuse std::time::Duration;\nuse serde::{Deserialize, Serialize};\nuse tauri::command;\nuse notify::{RecommendedWatcher, RecursiveMode, Watcher, Config, Event, EventKind};\nuse std::collections::HashMap;\nuse crate::internal::{InternalError, standardize_error};\nuse uuid::Uuid;\n\n/// ファイル情報を表す構造体\n#[derive(Debug, Serialize, Deserialize)]\npub struct FileInfo {\n    pub name: String,\n    pub path: String,\n    pub size: u64,\n    pub modified: String,\n    pub is_directory: bool,\n    pub extension: Option\u003cString\u003e,\n}\n\n/// ディレクトリ監視の設定\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct WatchConfig {\n    pub path: String,\n    pub recursive: bool,\n    pub file_patterns: Vec\u003cString\u003e, // 例: [\"*.mp4\", \"*.mov\", \"*.avi\"]\n    pub max_file_size_mb: Option\u003cu64\u003e, // ファイルサイズ制限（MB）\n    pub auto_upload: bool, // 自動アップロード有効\n    pub exclude_patterns: Vec\u003cString\u003e, // 除外パターン (例: [\"*.tmp\", \"*/.DS_Store\"])\n    pub exclude_directories: Vec\u003cString\u003e, // 除外ディレクトリ\n    pub auto_metadata: bool, // 自動メタデータ作成\n}\n\n/// セキュリティ検証用の定数\n#[allow(dead_code)]\nconst MAX_FILE_SIZE_DEFAULT_MB: u64 = 10 * 1024; // デフォルト10GB\n#[allow(dead_code)]\nconst ALLOWED_FILE_EXTENSIONS: \u0026[\u0026str] = \u0026[\n    \"mp4\", \"mov\", \"avi\", \"mkv\", \"wmv\", \"flv\", \"webm\",\n    \"m4v\", \"3gp\", \"f4v\", \"asf\", \"rm\", \"rmvb\", \"vob\"\n];\n\n/// ファイルパスのセキュリティ検証\nfn validate_file_path(path: \u0026PathBuf) -\u003e Result\u003cPathBuf, InternalError\u003e {\n    // パストラバーサル攻撃対策\n    let canonical_path = path.canonicalize()\n        .map_err(|e| InternalError::File(format!(\"Failed to resolve path: {}\", e)))?;\n    \n    // ユーザーのホームディレクトリ外アクセス制限（macOS/Linux）\n    if let Some(home_dir) = dirs::home_dir() {\n        if !canonical_path.starts_with(\u0026home_dir) {\n            return Err(InternalError::File(format!(\n                \"Access denied: Path outside user directory: {}\", \n                canonical_path.display()\n            )));\n        }\n    }\n    \n    Ok(canonical_path)\n}\n\n/// ファイルサイズ検証\nfn validate_file_size(file_path: \u0026PathBuf, max_size_mb: u64) -\u003e Result\u003c(), InternalError\u003e {\n    if let Ok(metadata) = file_path.metadata() {\n        let file_size_mb = metadata.len() / (1024 * 1024);\n        if file_size_mb \u003e max_size_mb {\n            return Err(InternalError::File(format!(\n                \"File too large: {} MB (max: {} MB)\", \n                file_size_mb, \n                max_size_mb\n            )));\n        }\n    }\n    Ok(())\n}\n\n/// ファイルパターンマッチング（glob風）\nfn matches_pattern(file_path: \u0026PathBuf, pattern: \u0026str) -\u003e bool {\n    let file_name = file_path.file_name()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"\");\n    \n    if pattern.starts_with(\"*.\") {\n        // 拡張子マッチング (例: *.mp4)\n        let ext = \u0026pattern[2..];\n        return file_path.extension()\n            .and_then(|s| s.to_str())\n            .map(|s| s.eq_ignore_ascii_case(ext))\n            .unwrap_or(false);\n    } else if pattern.contains('*') {\n        // 単純なワイルドカードマッチング\n        let pattern_regex = pattern.replace('*', \".*\");\n        return regex::Regex::new(\u0026pattern_regex)\n            .map(|r| r.is_match(file_name))\n            .unwrap_or(false);\n    } else {\n        // 完全一致\n        return file_name == pattern;\n    }\n}\n\n/// ファイルを除外すべきかチェック\nfn should_exclude_file(file_path: \u0026PathBuf, config: \u0026WatchConfig) -\u003e bool {\n    let _file_name = file_path.file_name()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"\");\n    \n    // 除外パターンチェック\n    for pattern in \u0026config.exclude_patterns {\n        if matches_pattern(file_path, pattern) {\n            log::debug!(\"File excluded by pattern '{}': {}\", pattern, file_path.display());\n            return true;\n        }\n    }\n    \n    // 除外ディレクトリチェック\n    for exclude_dir in \u0026config.exclude_directories {\n        if file_path.to_string_lossy().contains(exclude_dir) {\n            log::debug!(\"File excluded by directory '{}': {}\", exclude_dir, file_path.display());\n            return true;\n        }\n    }\n    \n    // ファイルパターンチェック（許可されたファイルのみ）\n    if !config.file_patterns.is_empty() {\n        let mut matches_any = false;\n        for pattern in \u0026config.file_patterns {\n            if matches_pattern(file_path, pattern) {\n                matches_any = true;\n                break;\n            }\n        }\n        if !matches_any {\n            log::debug!(\"File not matching patterns: {}\", file_path.display());\n            return true;\n        }\n    }\n    \n    false\n}\n\n/// ファイル変更イベントを処理\nasync fn handle_file_event(event: Event, config: \u0026WatchConfig) -\u003e Result\u003c(), String\u003e {\n    match event.kind {\n        EventKind::Create(_) | EventKind::Modify(_) =\u003e {\n            for path in event.paths {\n                if path.is_file() \u0026\u0026 !should_exclude_file(\u0026path, config) {\n                    log::info!(\"File event detected: {}\", path.display());\n                    \n                    // ファイルサイズチェック\n                    if let Some(max_size) = config.max_file_size_mb {\n                        if let Err(e) = validate_file_size(\u0026path, max_size) {\n                            log::warn!(\"File size validation failed: {}\", e);\n                            continue;\n                        }\n                    }\n                    \n                    // 自動メタデータ作成\n                    if config.auto_metadata {\n                        if let Err(e) = create_auto_metadata(\u0026path).await {\n                            log::error!(\"Failed to create metadata for {}: {}\", path.display(), e);\n                        }\n                    }\n                    \n                    // 自動アップロード\n                    if config.auto_upload {\n                        if let Err(e) = queue_auto_upload(\u0026path).await {\n                            log::error!(\"Failed to queue upload for {}: {}\", path.display(), e);\n                        }\n                    }\n                }\n            }\n        }\n        _ =\u003e {} // その他のイベントは無視\n    }\n    Ok(())\n}\n\n/// 自動メタデータ作成\nasync fn create_auto_metadata(file_path: \u0026PathBuf) -\u003e Result\u003c(), String\u003e {\n    use crate::commands::metadata::{create_file_metadata, save_file_metadata};\n    \n    let file_path_str = file_path.to_string_lossy().to_string();\n    \n    // 自動タグ生成（ファイル名、拡張子ベース）\n    let mut auto_tags = vec![\"auto-detected\".to_string()];\n    \n    if let Some(extension) = file_path.extension().and_then(|s| s.to_str()) {\n        auto_tags.push(format!(\"ext-{}\", extension.to_lowercase()));\n    }\n    \n    if let Some(parent_dir) = file_path.parent().and_then(|p| p.file_name()).and_then(|s| s.to_str()) {\n        auto_tags.push(format!(\"dir-{}\", parent_dir));\n    }\n    \n    // カスタムフィールド\n    let mut custom_fields = HashMap::new();\n    custom_fields.insert(\"auto_detected\".to_string(), \"true\".to_string());\n    custom_fields.insert(\"watch_path\".to_string(), file_path_str.clone());\n    \n    // メタデータ作成\n    match create_file_metadata(file_path_str.clone(), auto_tags, custom_fields).await {\n        Ok(metadata) =\u003e {\n            // データベースに保存\n            let db_path = \"./metadata.db\".to_string(); // TODO: 設定から取得\n            if let Err(e) = save_file_metadata(metadata, db_path).await {\n                return Err(format!(\"Failed to save metadata: {}\", e));\n            }\n            log::info!(\"Auto metadata created for: {}\", file_path.display());\n        }\n        Err(e) =\u003e {\n            return Err(format!(\"Failed to create metadata: {}\", e));\n        }\n    }\n    \n    Ok(())\n}\n\n/// 自動アップロードキューに追加\nasync fn queue_auto_upload(file_path: \u0026PathBuf) -\u003e Result\u003c(), String\u003e {\n    // TODO: アップロードキューへの追加実装\n    // 現在はログ出力のみ\n    log::info!(\"Queued for auto upload: {}\", file_path.display());\n    \n    // 将来的にはupload_file関数と連携\n    // let s3_key = generate_s3_key(\u0026file_path);\n    // queue_upload_task(file_path, s3_key).await?;\n    \n    Ok(())\n}\n\n/// ディレクトリ選択ダイアログを開く\n#[command]\npub async fn select_directory(app: tauri::AppHandle) -\u003e Result\u003cOption\u003cString\u003e, String\u003e {\n    use tauri_plugin_dialog::DialogExt;\n    \n    let result = app.dialog().file().blocking_pick_folder();\n    \n    match result {\n        Some(path) =\u003e {\n            // FilePath型を文字列に変換\n            Ok(Some(path.to_string()))\n        },\n        None =\u003e Ok(None), // ユーザーがキャンセル\n    }\n}\n\n/// ディレクトリ内のファイル一覧を取得\n#[command]\npub async fn list_files(directory: String) -\u003e Result\u003cVec\u003cFileInfo\u003e, String\u003e {\n    use std::fs;\n    \n    let path = PathBuf::from(\u0026directory);\n    \n    // セキュリティ検証\n    let validated_path = validate_file_path(\u0026path)\n        .map_err(standardize_error)?;\n    \n    let mut files = Vec::new();\n    \n    if !validated_path.is_dir() {\n        return Err(format!(\"Path is not a directory: {}\", validated_path.display()));\n    }\n    \n    match fs::read_dir(\u0026validated_path) {\n        Ok(entries) =\u003e {\n            for entry in entries {\n                match entry {\n                    Ok(entry) =\u003e {\n                        let metadata = entry.metadata().map_err(|e| e.to_string())?;\n                        let file_name = entry.file_name().to_string_lossy().to_string();\n                        let file_path = entry.path().to_string_lossy().to_string();\n                        \n                        let extension = entry.path()\n                            .extension()\n                            .and_then(|s| s.to_str())\n                            .map(|s| s.to_string());\n                        \n                        let modified = metadata\n                            .modified()\n                            .map(|t| format!(\"{:?}\", t))\n                            .unwrap_or_else(|_| \"Unknown\".to_string());\n                        \n                        files.push(FileInfo {\n                            name: file_name,\n                            path: file_path,\n                            size: metadata.len(),\n                            modified,\n                            is_directory: metadata.is_dir(),\n                            extension,\n                        });\n                    }\n                    Err(e) =\u003e return Err(e.to_string()),\n                }\n            }\n        }\n        Err(e) =\u003e return Err(e.to_string()),\n    }\n    \n    Ok(files)\n}\n\n/// 特定ファイルの詳細情報を取得\n#[command]\npub async fn get_file_info(file_path: String) -\u003e Result\u003cFileInfo, String\u003e {\n    use std::fs;\n    \n    let path = PathBuf::from(\u0026file_path);\n    \n    // セキュリティ検証\n    let validated_path = validate_file_path(\u0026path)\n        .map_err(standardize_error)?;\n    \n    let metadata = fs::metadata(\u0026validated_path).map_err(|e| e.to_string())?;\n    let file_name = validated_path\n        .file_name()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"Unknown\")\n        .to_string();\n    \n    let extension = validated_path\n        .extension()\n        .and_then(|s| s.to_str())\n        .map(|s| s.to_string());\n    \n    let modified = metadata\n        .modified()\n        .map(|t| format!(\"{:?}\", t))\n        .unwrap_or_else(|_| \"Unknown\".to_string());\n    \n    Ok(FileInfo {\n        name: file_name,\n        path: validated_path.to_string_lossy().to_string(),\n        size: metadata.len(),\n        modified,\n        is_directory: metadata.is_dir(),\n        extension,\n    })\n}\n\n/// ディレクトリ監視を開始（notify crate実装版）\n#[command]\npub async fn watch_directory(config: WatchConfig) -\u003e Result\u003cString, String\u003e {\n    let path = PathBuf::from(\u0026config.path);\n    \n    // セキュリティ検証\n    let canonical_path = validate_file_path(\u0026path)\n        .map_err(standardize_error)?;\n    \n    if !canonical_path.is_dir() {\n        return Err(format!(\"Watch path is not a directory: {}\", canonical_path.display()));\n    }\n    \n    // パターンの検証\n    if config.file_patterns.is_empty() {\n        return Err(\"File patterns cannot be empty\".to_string());\n    }\n    \n    // 実際のファイル監視実装\n    let (tx, rx) = channel();\n    \n    let notify_config = Config::default()\n        .with_poll_interval(Duration::from_secs(1));\n        \n    let mut watcher = RecommendedWatcher::new(tx, notify_config)\n        .map_err(|e| format!(\"Failed to create watcher: {}\", e))?;\n    \n    let recursive_mode = if config.recursive {\n        RecursiveMode::Recursive\n    } else {\n        RecursiveMode::NonRecursive\n    };\n    \n    watcher.watch(\u0026canonical_path, recursive_mode)\n        .map_err(|e| format!(\"Failed to start watching: {}\", e))?;\n    \n    log::info!(\"File watching started for: {}\", canonical_path.display());\n    log::info!(\"Recursive: {}\", config.recursive);\n    log::info!(\"Patterns: {:?}\", config.file_patterns);\n    \n    // 拡張された監視機能（Issue #30対応）\n    let config_clone = config.clone();\n    tokio::spawn(async move {\n        log::info!(\"Advanced file watching started with features:\");\n        log::info!(\"  - Auto upload: {}\", config_clone.auto_upload);\n        log::info!(\"  - Auto metadata: {}\", config_clone.auto_metadata);\n        log::info!(\"  - Exclude patterns: {:?}\", config_clone.exclude_patterns);\n        log::info!(\"  - Exclude directories: {:?}\", config_clone.exclude_directories);\n        \n        for result in rx {\n            match result {\n                Ok(event) =\u003e {\n                    log::debug!(\"File event: {:?}\", event);\n                    \n                    // 拡張されたイベント処理\n                    if let Err(e) = handle_file_event(event, \u0026config_clone).await {\n                        log::error!(\"Failed to handle file event: {}\", e);\n                    }\n                }\n                Err(error) =\u003e {\n                    log::error!(\"Watch error: {:?}\", error);\n                }\n            }\n        }\n    });\n    \n    Ok(format!(\n        \"Advanced directory watching started for: {} (patterns: {:?}, recursive: {}, auto_upload: {}, auto_metadata: {})\", \n        canonical_path.display(),\n        config.file_patterns,\n        config.recursive,\n        config.auto_upload,\n        config.auto_metadata\n    ))\n}\n\n/// 監視システムのテスト用コマンド（デバッグ・検証用）\n#[command]\npub async fn test_watch_system(config: WatchConfig) -\u003e Result\u003cString, String\u003e {\n    log::info!(\"Testing watch system configuration\");\n    \n    // 設定検証\n    let path = PathBuf::from(\u0026config.path);\n    let canonical_path = validate_file_path(\u0026path)\n        .map_err(standardize_error)?;\n    \n    if !canonical_path.is_dir() {\n        return Err(format!(\"Watch path is not a directory: {}\", canonical_path.display()));\n    }\n    \n    // パターン検証\n    if config.file_patterns.is_empty() {\n        return Err(\"File patterns cannot be empty\".to_string());\n    }\n    \n    // テストファイル作成\n    let test_files = vec![\n        (\"test_video.mp4\", true),   // 許可されるファイル\n        (\"test_video.mov\", true),   // 許可されるファイル\n        (\"test.tmp\", false),        // 除外されるファイル\n        (\"document.txt\", false),    // パターンに一致しない\n        (\".DS_Store\", false),       // 除外されるファイル\n    ];\n    \n    let mut results = Vec::new();\n    \n    for (filename, should_be_included) in test_files {\n        let test_path = canonical_path.join(filename);\n        let excluded = should_exclude_file(\u0026test_path, \u0026config);\n        \n        let result_msg = if should_be_included {\n            if excluded {\n                format!(\"❌ {} - 期待: 含まれる, 実際: 除外される\", filename)\n            } else {\n                format!(\"✅ {} - 期待: 含まれる, 実際: 含まれる\", filename)\n            }\n        } else {\n            if excluded {\n                format!(\"✅ {} - 期待: 除外される, 実際: 除外される\", filename)\n            } else {\n                format!(\"❌ {} - 期待: 除外される, 実際: 含まれる\", filename)\n            }\n        };\n        \n        results.push(result_msg);\n    }\n    \n    let summary = format!(\n        \"Watch system test completed for: {}\\nResults:\\n{}\", \n        canonical_path.display(),\n        results.join(\"\\n\")\n    );\n    \n    log::info!(\"{}\", summary);\n    Ok(summary)\n}\n\n/// 現在のディレクトリでテスト可能なサンプル設定を生成\n#[command]\npub async fn get_sample_watch_configs() -\u003e Result\u003cVec\u003cWatchConfig\u003e, String\u003e {\n    let current_dir = std::env::current_dir()\n        .map_err(|e| format!(\"Failed to get current directory: {}\", e))?\n        .to_string_lossy()\n        .to_string();\n    \n    Ok(vec![\n        WatchConfig {\n            path: current_dir.clone(),\n            recursive: false,\n            file_patterns: vec![\"*.mp4\".to_string()],\n            max_file_size_mb: Some(100),\n            auto_upload: false,\n            exclude_patterns: vec![\"*.tmp\".to_string()],\n            exclude_directories: vec![],\n            auto_metadata: true,\n        },\n        WatchConfig {\n            path: current_dir.clone(),\n            recursive: true,\n            file_patterns: vec![\"*.mp4\".to_string(), \"*.mov\".to_string(), \"*.avi\".to_string()],\n            max_file_size_mb: Some(5120), // 5GB\n            auto_upload: true,\n            exclude_patterns: vec![\n                \"*.tmp\".to_string(),\n                \"*.part\".to_string(),\n                \"*/.DS_Store\".to_string(),\n                \"*/Thumbs.db\".to_string(),\n            ],\n            exclude_directories: vec![\n                \".git\".to_string(),\n                \"node_modules\".to_string(),\n                \".cache\".to_string(),\n            ],\n            auto_metadata: true,\n        },\n        WatchConfig {\n            path: current_dir,\n            recursive: true,\n            file_patterns: vec![\"*.*\".to_string()], // すべてのファイル\n            max_file_size_mb: Some(1024), // 1GB\n            auto_upload: false,\n            exclude_patterns: vec![\n                \"*.log\".to_string(),\n                \"*.tmp\".to_string(),\n                \"*.cache\".to_string(),\n                \"*/.DS_Store\".to_string(),\n            ],\n            exclude_directories: vec![\n                \".git\".to_string(),\n                \"target\".to_string(),\n                \"dist\".to_string(),\n                \"build\".to_string(),\n            ],\n            auto_metadata: false,\n        },\n    ])\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::TempDir;\n    use std::fs;\n\n    /// テスト用WatchConfigを作成\n    fn create_test_watch_config(path: \u0026str) -\u003e WatchConfig {\n        WatchConfig {\n            path: path.to_string(),\n            recursive: true,\n            file_patterns: vec![\"*.mp4\".to_string(), \"*.mov\".to_string()],\n            max_file_size_mb: Some(100),\n            auto_upload: true,\n            exclude_patterns: vec![\"*.tmp\".to_string(), \"*/.DS_Store\".to_string()],\n            exclude_directories: vec![\".git\".to_string(), \"node_modules\".to_string()],\n            auto_metadata: true,\n        }\n    }\n\n    #[test]\n    fn test_matches_pattern() {\n        let mp4_file = PathBuf::from(\"video.mp4\");\n        let mov_file = PathBuf::from(\"movie.mov\");\n        let txt_file = PathBuf::from(\"document.txt\");\n        let tmp_file = PathBuf::from(\"temp.tmp\");\n\n        // 拡張子マッチング\n        assert!(matches_pattern(\u0026mp4_file, \"*.mp4\"));\n        assert!(matches_pattern(\u0026mov_file, \"*.mov\"));\n        assert!(!matches_pattern(\u0026txt_file, \"*.mp4\"));\n\n        // 完全一致\n        assert!(matches_pattern(\u0026PathBuf::from(\"exact.txt\"), \"exact.txt\"));\n        assert!(!matches_pattern(\u0026PathBuf::from(\"other.txt\"), \"exact.txt\"));\n\n        // ワイルドカード\n        assert!(matches_pattern(\u0026tmp_file, \"*temp*\"));\n        assert!(matches_pattern(\u0026PathBuf::from(\"prefix_something\"), \"prefix*\"));\n    }\n\n    #[test]\n    fn test_should_exclude_file() {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let config = create_test_watch_config(temp_dir.path().to_str().unwrap());\n\n        // 除外パターンテスト\n        let tmp_file = temp_dir.path().join(\"test.tmp\");\n        let ds_store = temp_dir.path().join(\".DS_Store\");\n        let video_file = temp_dir.path().join(\"video.mp4\");\n\n        assert!(should_exclude_file(\u0026tmp_file, \u0026config));\n        assert!(should_exclude_file(\u0026ds_store, \u0026config));\n        assert!(!should_exclude_file(\u0026video_file, \u0026config));\n\n        // 除外ディレクトリテスト\n        let git_file = temp_dir.path().join(\".git/config\");\n        assert!(should_exclude_file(\u0026git_file, \u0026config));\n    }\n\n    #[test]\n    fn test_validate_file_size() {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let small_file = temp_dir.path().join(\"small.txt\");\n        \n        // 小さなファイルを作成\n        fs::write(\u0026small_file, \"small content\").unwrap();\n        \n        // 1MBの制限でテスト（実際のファイルは1KB未満）\n        assert!(validate_file_size(\u0026small_file, 1).is_ok());\n        \n        // 制限を非常に小さくしてテスト\n        // Note: 実際のファイルサイズによってはテストが変わる可能性\n        let result = validate_file_size(\u0026small_file, 0);\n        // サイズが0より大きい場合はエラーになるはず\n        // ただし、ファイルが非常に小さい場合は計算上0MBになる可能性もある\n    }\n\n    #[test]\n    fn test_validate_file_path() {\n        // 有効なパスのテスト（現在のディレクトリ）\n        let current_dir = std::env::current_dir().unwrap();\n        assert!(validate_file_path(\u0026current_dir).is_ok());\n\n        // 無効なパス（存在しない）\n        let invalid_path = PathBuf::from(\"/nonexistent/path/that/should/not/exist\");\n        assert!(validate_file_path(\u0026invalid_path).is_err());\n    }\n\n    #[test]\n    fn test_watch_config_structure() {\n        let config = create_test_watch_config(\"/test/path\");\n        \n        assert_eq!(config.path, \"/test/path\");\n        assert!(config.recursive);\n        assert!(config.auto_upload);\n        assert!(config.auto_metadata);\n        assert_eq!(config.file_patterns.len(), 2);\n        assert_eq!(config.exclude_patterns.len(), 2);\n        assert_eq!(config.exclude_directories.len(), 2);\n        assert_eq!(config.max_file_size_mb, Some(100));\n    }\n\n    #[test]\n    fn test_file_pattern_matching_edge_cases() {\n        let file = PathBuf::from(\"video.MP4\"); // 大文字拡張子\n        \n        // 大文字小文字を無視したマッチング\n        assert!(matches_pattern(\u0026file, \"*.mp4\"));\n        assert!(matches_pattern(\u0026file, \"*.MP4\"));\n        \n        let no_ext_file = PathBuf::from(\"video\");\n        assert!(!matches_pattern(\u0026no_ext_file, \"*.mp4\"));\n    }\n\n    #[test]\n    fn test_exclude_patterns_comprehensive() {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let mut config = create_test_watch_config(temp_dir.path().to_str().unwrap());\n        \n        // より多くの除外パターンを追加\n        config.exclude_patterns.extend(vec![\n            \"*.log\".to_string(),\n            \"*backup*\".to_string(),\n            \"Thumbs.db\".to_string(),\n        ]);\n        \n        let log_file = temp_dir.path().join(\"app.log\");\n        let backup_file = temp_dir.path().join(\"backup_video.mp4\");\n        let thumbs_file = temp_dir.path().join(\"Thumbs.db\");\n        let normal_file = temp_dir.path().join(\"normal.mp4\");\n        \n        assert!(should_exclude_file(\u0026log_file, \u0026config));\n        assert!(should_exclude_file(\u0026backup_file, \u0026config));\n        assert!(should_exclude_file(\u0026thumbs_file, \u0026config));\n        assert!(!should_exclude_file(\u0026normal_file, \u0026config));\n    }\n\n    #[test]\n    fn test_should_exclude_file_empty_patterns() {\n        let temp_dir = tempfile::tempdir().unwrap();\n        \n        // 空のパターン配列でテスト\n        let config = WatchConfig {\n            path: temp_dir.path().to_str().unwrap().to_string(),\n            recursive: true,\n            file_patterns: vec![], // 空のパターン配列\n            max_file_size_mb: Some(100),\n            auto_upload: true,\n            exclude_patterns: vec![], // 空の除外パターン配列\n            exclude_directories: vec![],\n            auto_metadata: true,\n        };\n        \n        let test_file = temp_dir.path().join(\"test.mp4\");\n        fs::write(\u0026test_file, \"test content\").unwrap();\n        \n        // 空のパターン配列の場合、パターンチェックがスキップされるため除外されない\n        assert!(!should_exclude_file(\u0026test_file, \u0026config));\n        \n        // 除外パターンだけ設定した場合\n        let mut config_with_exclude = config.clone();\n        config_with_exclude.exclude_patterns = vec![\"*.tmp\".to_string()];\n        \n        let tmp_file = temp_dir.path().join(\"test.tmp\");\n        fs::write(\u0026tmp_file, \"tmp content\").unwrap();\n        \n        // 除外パターンに一致するファイルは除外される\n        assert!(should_exclude_file(\u0026tmp_file, \u0026config_with_exclude));\n        // 除外パターンに一致しないファイルは除外されない（file_patternsが空なのでパターンチェックはスキップ）\n        assert!(!should_exclude_file(\u0026test_file, \u0026config_with_exclude));\n    }\n\n    #[tokio::test]\n    async fn test_list_files_success() {\n        // UUID付きテストディレクトリで並列衝突防止\n        let home_dir = dirs::home_dir().unwrap();\n        let test_dir = home_dir.join(format!(\"test_file_operations_{}\", Uuid::new_v4()));\n        \n        // 既存のテストディレクトリがあれば削除\n        if test_dir.exists() {\n            let _ = fs::remove_dir_all(\u0026test_dir);\n        }\n        \n        // テストディレクトリを作成\n        fs::create_dir_all(\u0026test_dir).unwrap();\n        \n        // テストファイルを作成（1つだけ）\n        fs::write(test_dir.join(\"test.txt\"), \"test content\").unwrap();\n        \n        let directory = test_dir.to_str().unwrap().to_string();\n        let result = list_files(directory).await;\n        \n        // クリーンアップ（再帰的に削除）\n        let _ = fs::remove_dir_all(\u0026test_dir); // エラーを無視\n        \n        assert!(result.is_ok());\n        let files = result.unwrap();\n        \n        // 最低1つのファイルがあることを確認\n        assert!(files.len() \u003e= 1);\n        \n        // 作成したファイルが見つかることを確認\n        let test_file = files.iter().find(|f| f.name == \"test.txt\");\n        assert!(test_file.is_some(), \"test.txt not found in files: {:?}\", files.iter().map(|f| \u0026f.name).collect::\u003cVec\u003c_\u003e\u003e());\n        let test_file = test_file.unwrap();\n        assert_eq!(test_file.name, \"test.txt\");\n        assert!(test_file.path.contains(\"test.txt\"));\n        assert!(test_file.size \u003e 0);\n        assert!(!test_file.is_directory);\n        assert_eq!(test_file.extension, Some(\"txt\".to_string()));\n    }\n\n    #[tokio::test]\n    async fn test_list_files_invalid_directory() {\n        let invalid_path = \"/nonexistent/directory/that/should/not/exist\".to_string();\n        let result = list_files(invalid_path).await;\n        \n        assert!(result.is_err());\n        let error_msg = result.unwrap_err();\n        assert!(error_msg.contains(\"File operation error\") || error_msg.contains(\"No such file or directory\"));\n    }\n\n    #[tokio::test]\n    async fn test_get_file_info_success() {\n        // UUID付きテストディレクトリで並列衝突防止\n        let home_dir = dirs::home_dir().unwrap();\n        let test_dir = home_dir.join(format!(\"test_file_operations_{}\", Uuid::new_v4()));\n        \n        // 既存のテストディレクトリがあれば削除\n        if test_dir.exists() {\n            let _ = fs::remove_dir_all(\u0026test_dir);\n        }\n        \n        fs::create_dir_all(\u0026test_dir).unwrap();\n        \n        let test_file = test_dir.join(\"test.txt\");\n        fs::write(\u0026test_file, \"test content\").unwrap();\n        \n        let file_path = test_file.to_str().unwrap().to_string();\n        let result = get_file_info(file_path).await;\n        \n        // クリーンアップ（再帰的に削除）\n        let _ = fs::remove_dir_all(\u0026test_dir); // エラーを無視\n        \n        assert!(result.is_ok());\n        let file_info = result.unwrap();\n        \n        assert_eq!(file_info.name, \"test.txt\");\n        assert!(file_info.path.contains(\"test.txt\"));\n        assert!(file_info.size \u003e 0);\n        assert!(!file_info.is_directory);\n        assert_eq!(file_info.extension, Some(\"txt\".to_string()));\n        assert!(!file_info.modified.is_empty());\n    }\n\n    #[tokio::test]\n    async fn test_get_file_info_nonexistent_file() {\n        let nonexistent_path = \"/nonexistent/file.txt\".to_string();\n        let result = get_file_info(nonexistent_path).await;\n        \n        assert!(result.is_err());\n        let error_msg = result.unwrap_err();\n        assert!(error_msg.contains(\"File operation error\") || error_msg.contains(\"No such file or directory\"));\n    }\n\n    #[tokio::test]\n    async fn test_get_sample_watch_configs() {\n        let result = get_sample_watch_configs().await;\n        \n        assert!(result.is_ok());\n        let configs = result.unwrap();\n        \n        // サンプル設定が3つ作成されることを確認\n        assert_eq!(configs.len(), 3);\n        \n        // 各設定の基本構造を確認\n        for config in \u0026configs {\n            assert!(!config.path.is_empty());\n            assert!(!config.file_patterns.is_empty());\n            assert!(config.max_file_size_mb.is_some());\n        }\n        \n        // 最初の設定（非再帰的）を確認\n        assert!(!configs[0].recursive);\n        assert!(!configs[0].auto_upload);\n        assert!(configs[0].auto_metadata);\n        \n        // 2番目の設定（再帰的、自動アップロード）を確認\n        assert!(configs[1].recursive);\n        assert!(configs[1].auto_upload);\n        assert!(configs[1].auto_metadata);\n    }\n\n    #[tokio::test]\n    async fn test_get_file_info_attributes_validation() {\n        // UUID付きテストディレクトリで並列衝突防止\n        let home_dir = dirs::home_dir().unwrap();\n        let test_dir = home_dir.join(format!(\"test_file_operations_{}\", Uuid::new_v4()));\n        \n        // 既存のテストディレクトリがあれば削除\n        if test_dir.exists() {\n            let _ = fs::remove_dir_all(\u0026test_dir);\n        }\n        \n        fs::create_dir_all(\u0026test_dir).unwrap();\n        \n        // 拡張子なしファイルを作成\n        let no_ext_file = test_dir.join(\"testfile\");\n        fs::write(\u0026no_ext_file, \"test content\").unwrap();\n        \n        // 隠しファイルを作成\n        let hidden_file = test_dir.join(\".hidden\");\n        fs::write(\u0026hidden_file, \"hidden content\").unwrap();\n        \n        // 拡張子なしファイルの検証\n        let no_ext_path = no_ext_file.to_str().unwrap().to_string();\n        let result = get_file_info(no_ext_path).await;\n        \n        assert!(result.is_ok());\n        let file_info = result.unwrap();\n        \n        assert_eq!(file_info.name, \"testfile\");\n        assert!(file_info.path.contains(\"testfile\"));\n        assert!(file_info.size \u003e 0);\n        assert!(!file_info.is_directory);\n        assert_eq!(file_info.extension, None); // 拡張子なし\n        assert!(!file_info.modified.is_empty());\n        assert_ne!(file_info.modified, \"Unknown\"); // modifiedが\"Unknown\"でないことを確認\n        \n        // 隠しファイルの検証\n        let hidden_path = hidden_file.to_str().unwrap().to_string();\n        let result = get_file_info(hidden_path).await;\n        \n        assert!(result.is_ok());\n        let file_info = result.unwrap();\n        \n        assert_eq!(file_info.name, \".hidden\");\n        assert!(file_info.path.contains(\".hidden\"));\n        assert!(file_info.size \u003e 0);\n        assert!(!file_info.is_directory);\n        assert_eq!(file_info.extension, None); // 隠しファイルは拡張子なし\n        assert!(!file_info.modified.is_empty());\n        assert_ne!(file_info.modified, \"Unknown\"); // modifiedが\"Unknown\"でないことを確認\n        \n        // クリーンアップ（再帰的に削除）\n        let _ = fs::remove_dir_all(\u0026test_dir); // エラーを無視\n    }\n\n    #[tokio::test]\n    async fn test_get_file_info_permission_error() {\n        // UUID付きテストディレクトリで並列衝突防止\n        let home_dir = dirs::home_dir().unwrap();\n        let test_dir = home_dir.join(format!(\"test_file_operations_{}\", Uuid::new_v4()));\n        \n        // 既存のテストディレクトリがあれば削除\n        if test_dir.exists() {\n            let _ = fs::remove_dir_all(\u0026test_dir);\n        }\n        \n        fs::create_dir_all(\u0026test_dir).unwrap();\n        \n        // 読み取り不可ファイルを作成\n        let readonly_file = test_dir.join(\"readonly.txt\");\n        fs::write(\u0026readonly_file, \"readonly content\").unwrap();\n        \n        // ファイルの権限を000に変更（読み取り不可）\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let mut perms = fs::metadata(\u0026readonly_file).unwrap().permissions();\n            perms.set_mode(0o000); // 読み取り・書き込み・実行権限を全て削除\n            fs::set_permissions(\u0026readonly_file, perms).unwrap();\n        }\n        \n        let readonly_path = readonly_file.to_str().unwrap().to_string();\n        let result = get_file_info(readonly_path).await;\n        \n        // 権限を元に戻してからクリーンアップ\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let mut perms = fs::metadata(\u0026readonly_file).unwrap().permissions();\n            perms.set_mode(0o644); // 通常の権限に戻す\n            fs::set_permissions(\u0026readonly_file, perms).unwrap();\n        }\n        \n        // クリーンアップ（再帰的に削除）\n        let _ = fs::remove_dir_all(\u0026test_dir); // エラーを無視\n        \n        // Unix系では権限エラー、Windowsでは成功する可能性がある\n        #[cfg(unix)]\n        {\n            // macOSではファイル所有者であれば権限000でも読み取り可能な場合がある\n            if result.is_err() {\n                let error_msg = result.unwrap_err();\n                assert!(error_msg.contains(\"Permission denied\") || error_msg.contains(\"Access denied\"));\n            } else {\n                // 権限エラーが発生しなくても、ファイル情報が正しく取得できればOK\n                let file_info = result.unwrap();\n                assert_eq!(file_info.name, \"readonly.txt\");\n                assert!(file_info.size \u003e 0);\n            }\n        }\n        \n        #[cfg(windows)]\n        {\n            // Windowsでは権限エラーが発生しない可能性があるため、成功してもOK\n            if result.is_ok() {\n                let file_info = result.unwrap();\n                assert_eq!(file_info.name, \"readonly.txt\");\n                assert!(file_info.size \u003e 0);\n            }\n        }\n    }\n} ","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":9}},{"line":47,"address":[],"length":0,"stats":{"Line":15}},{"line":48,"address":[],"length":0,"stats":{"Line":24}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[],"length":0,"stats":{"Line":40}},{"line":80,"address":[],"length":0,"stats":{"Line":40}},{"line":81,"address":[],"length":0,"stats":{"Line":120}},{"line":84,"address":[],"length":0,"stats":{"Line":40}},{"line":86,"address":[],"length":0,"stats":{"Line":24}},{"line":87,"address":[],"length":0,"stats":{"Line":24}},{"line":88,"address":[],"length":0,"stats":{"Line":67}},{"line":89,"address":[],"length":0,"stats":{"Line":67}},{"line":90,"address":[],"length":0,"stats":{"Line":24}},{"line":91,"address":[],"length":0,"stats":{"Line":16}},{"line":93,"address":[],"length":0,"stats":{"Line":12}},{"line":94,"address":[],"length":0,"stats":{"Line":12}},{"line":95,"address":[],"length":0,"stats":{"Line":36}},{"line":96,"address":[],"length":0,"stats":{"Line":12}},{"line":99,"address":[],"length":0,"stats":{"Line":4}},{"line":104,"address":[],"length":0,"stats":{"Line":11}},{"line":105,"address":[],"length":0,"stats":{"Line":11}},{"line":106,"address":[],"length":0,"stats":{"Line":33}},{"line":110,"address":[],"length":0,"stats":{"Line":58}},{"line":111,"address":[],"length":0,"stats":{"Line":26}},{"line":112,"address":[],"length":0,"stats":{"Line":5}},{"line":118,"address":[],"length":0,"stats":{"Line":19}},{"line":119,"address":[],"length":0,"stats":{"Line":7}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":5}},{"line":127,"address":[],"length":0,"stats":{"Line":3}},{"line":128,"address":[],"length":0,"stats":{"Line":9}},{"line":129,"address":[],"length":0,"stats":{"Line":4}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":2}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":4}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":4}},{"line":254,"address":[],"length":0,"stats":{"Line":2}},{"line":257,"address":[],"length":0,"stats":{"Line":3}},{"line":258,"address":[],"length":0,"stats":{"Line":3}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":1}},{"line":267,"address":[],"length":0,"stats":{"Line":1}},{"line":268,"address":[],"length":0,"stats":{"Line":3}},{"line":269,"address":[],"length":0,"stats":{"Line":1}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":271,"address":[],"length":0,"stats":{"Line":1}},{"line":277,"address":[],"length":0,"stats":{"Line":1}},{"line":278,"address":[],"length":0,"stats":{"Line":1}},{"line":282,"address":[],"length":0,"stats":{"Line":1}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":1}},{"line":306,"address":[],"length":0,"stats":{"Line":10}},{"line":309,"address":[],"length":0,"stats":{"Line":5}},{"line":312,"address":[],"length":0,"stats":{"Line":9}},{"line":313,"address":[],"length":0,"stats":{"Line":6}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":318,"address":[],"length":0,"stats":{"Line":4}},{"line":324,"address":[],"length":0,"stats":{"Line":2}},{"line":325,"address":[],"length":0,"stats":{"Line":2}},{"line":329,"address":[],"length":0,"stats":{"Line":4}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":2}},{"line":482,"address":[],"length":0,"stats":{"Line":2}},{"line":483,"address":[],"length":0,"stats":{"Line":2}}],"covered":66,"coverable":198},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","lifecycle.rs"],"content":"use serde::Serialize;\nuse tauri::command;\nuse crate::commands::aws_operations::{S3ClientTrait, RealS3Client, create_s3_client, LifecycleRule, LifecycleTransition};\nuse crate::commands::aws_auth::{AwsConfig, create_aws_config, AwsCredentials};\nuse crate::internal::{InternalError, standardize_error};\n\n/// ReelVault固定ライフサイクル設定\nconst REELVAULT_TRANSITION_DAYS: i32 = 1;  // 1日後移行\nconst REELVAULT_RULE_ID: \u0026str = \"ReelVault-Default-Auto-Archive\";\nconst REELVAULT_STORAGE_CLASS: \u0026str = \"DEEP_ARCHIVE\";\n\n\n\n/// ライフサイクルポリシー設定結果\n#[derive(Debug, Serialize)]\npub struct LifecyclePolicyResult {\n    pub success: bool,\n    pub message: String,\n    pub rule_id: String,\n    pub transition_days: i32,\n    pub storage_class: String,\n}\n\n/// ライフサイクルポリシー状況\n#[derive(Debug, Serialize)]\npub struct LifecyclePolicyStatus {\n    pub enabled: bool,\n    pub rule_id: Option\u003cString\u003e,\n    pub transition_days: Option\u003ci32\u003e,\n    pub storage_class: Option\u003cString\u003e,\n    pub prefix: Option\u003cString\u003e,\n    pub error_message: Option\u003cString\u003e,\n}\n\n/// ReelVault標準ライフサイクルポリシーを有効化\n/// \n/// 固定設定:\n/// - uploads/配下の全ファイル\n/// - 1日後にDEEP_ARCHIVEに移行\n/// - 128KB以上のファイルのみ（AWS制限）\n#[command]\npub async fn enable_reelvault_lifecycle(config: AwsConfig) -\u003e Result\u003cLifecyclePolicyResult, String\u003e {\n    // 設定の基本検証\n    if config.bucket_name.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Bucket name is required\".to_string())));\n    }\n\n    // TODO: AWS SDK for Rustを使った実装\n    // 現在はモック実装\n    // \n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // let lifecycle_config = create_reelvault_lifecycle_config();\n    // let result = s3_client\n    //     .put_bucket_lifecycle_configuration()\n    //     .bucket(\u0026config.bucket_name)\n    //     .lifecycle_configuration(lifecycle_config)\n    //     .send()\n    //     .await\n    //     .map_err(|e| format!(\"Failed to set lifecycle policy: {}\", e))?;\n\n    log::info!(\"ReelVault lifecycle policy enabled for bucket: {}\", config.bucket_name);\n    log::info!(\"Rule: {} days -\u003e {}\", REELVAULT_TRANSITION_DAYS, REELVAULT_STORAGE_CLASS);\n\n    Ok(LifecyclePolicyResult {\n        success: true,\n        message: format!(\n            \"ReelVault lifecycle policy enabled: {} day(s) -\u003e {}\",\n            REELVAULT_TRANSITION_DAYS, REELVAULT_STORAGE_CLASS\n        ),\n        rule_id: REELVAULT_RULE_ID.to_string(),\n        transition_days: REELVAULT_TRANSITION_DAYS,\n        storage_class: REELVAULT_STORAGE_CLASS.to_string(),\n    })\n}\n\n/// 現在のライフサイクルポリシー設定状況を取得\n#[command]\npub async fn get_lifecycle_status(config: AwsConfig) -\u003e Result\u003cLifecyclePolicyStatus, String\u003e {\n    // 設定の基本検証\n    if config.bucket_name.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Bucket name is required\".to_string())));\n    }\n\n    // S3ClientTraitを使用\n    let aws_credentials = match create_aws_config(\u0026config).await {\n        Ok(aws_config) =\u003e AwsCredentials {\n            access_key_id: config.access_key_id.clone(),\n            secret_access_key: config.secret_access_key.clone(),\n            session_token: None,\n            region: config.region.clone(),\n        },\n        Err(e) =\u003e {\n            log::error!(\"Failed to create AWS config: {}\", e);\n            return Ok(LifecyclePolicyStatus {\n                enabled: false,\n                rule_id: None,\n                transition_days: None,\n                storage_class: None,\n                prefix: None,\n                error_message: Some(format!(\"AWS config creation failed: {}\", e)),\n            });\n        }\n    };\n    \n    let s3_client = match create_s3_client(\u0026aws_credentials).await {\n        Ok(client) =\u003e RealS3Client::new(client),\n        Err(e) =\u003e {\n            log::error!(\"Failed to create S3 client: {}\", e);\n            return Ok(LifecyclePolicyStatus {\n                enabled: false,\n                rule_id: None,\n                transition_days: None,\n                storage_class: None,\n                prefix: None,\n                error_message: Some(format!(\"S3 client creation failed: {}\", e)),\n            });\n        }\n    };\n\n    log::info!(\"Lifecycle status check for bucket: {}\", config.bucket_name);\n\n    // まずバケットの存在確認\n    log::debug!(\"Checking bucket existence: {}\", config.bucket_name);\n    match s3_client.head_bucket(\u0026config.bucket_name).await {\n        Ok(_) =\u003e {\n            log::debug!(\"Bucket exists and accessible: {}\", config.bucket_name);\n        }\n        Err(e) =\u003e {\n            log::error!(\"Bucket access failed: {}\", e);\n            return Ok(LifecyclePolicyStatus {\n                enabled: false,\n                rule_id: None,\n                transition_days: None,\n                storage_class: None,\n                prefix: None,\n                error_message: Some(format!(\"バケットアクセスエラー: {}\", e)),\n            });\n        }\n    }\n\n    // バケットのリージョン確認\n    log::debug!(\"Checking bucket region: {}\", config.bucket_name);\n    match s3_client.get_bucket_location(\u0026config.bucket_name).await {\n        Ok(bucket_region) =\u003e {\n            log::debug!(\"Bucket region: {}\", bucket_region);\n        }\n        Err(e) =\u003e {\n            log::warn!(\"Failed to get bucket region (non-fatal): {}\", e);\n        }\n    }\n\n    // ライフサイクル設定を取得\n    log::debug!(\"Calling get_bucket_lifecycle_configuration for bucket: {}\", config.bucket_name);\n    match s3_client.get_bucket_lifecycle_configuration(\u0026config.bucket_name).await {\n        Ok(rules) =\u003e {\n            log::debug!(\"Successfully retrieved lifecycle configuration, rules count: {}\", rules.len());\n            // ReelVaultルールを検索\n            for rule in \u0026rules {\n                if rule.id == REELVAULT_RULE_ID {\n                    // ReelVaultルールが見つかった場合\n                    let enabled = rule.status == \"Enabled\";\n                    \n                    let (transition_days, storage_class) = if !rule.transitions.is_empty() {\n                        let first_transition = \u0026rule.transitions[0];\n                        (first_transition.days, first_transition.storage_class.clone())\n                    } else {\n                        (0, \"NONE\".to_string())\n                    };\n\n                    return Ok(LifecyclePolicyStatus {\n                        enabled,\n                        rule_id: Some(REELVAULT_RULE_ID.to_string()),\n                        transition_days: Some(transition_days),\n                        storage_class: Some(storage_class),\n                        prefix: rule.prefix.clone(),\n                        error_message: None,\n                    });\n                }\n            }\n            \n            // ReelVaultルールが見つからない場合\n            log::debug!(\"ReelVault lifecycle rule not found in {} rules\", rules.len());\n            Ok(LifecyclePolicyStatus {\n                enabled: false,\n                rule_id: None,\n                transition_days: None,\n                storage_class: None,\n                prefix: None,\n                error_message: Some(\"ReelVault lifecycle rule not found\".to_string()),\n            })\n        }\n        Err(e) =\u003e {\n            log::error!(\"Failed to get lifecycle configuration: {}\", e);\n            Ok(LifecyclePolicyStatus {\n                enabled: false,\n                rule_id: None,\n                transition_days: None,\n                storage_class: None,\n                prefix: None,\n                error_message: Some(format!(\"ライフサイクル設定取得エラー: {}\", e)),\n            })\n        }\n    }\n}\n\n/// ライフサイクルポリシーを無効化\n#[command]\npub async fn disable_lifecycle_policy(config: AwsConfig) -\u003e Result\u003cLifecyclePolicyResult, String\u003e {\n    // 設定の基本検証\n    if config.bucket_name.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Bucket name is required\".to_string())));\n    }\n\n    // TODO: AWS SDK for Rustを使った実装\n    // 現在はモック実装\n    // \n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // let result = s3_client\n    //     .delete_bucket_lifecycle()\n    //     .bucket(\u0026config.bucket_name)\n    //     .send()\n    //     .await\n    //     .map_err(|e| format!(\"Failed to disable lifecycle policy: {}\", e))?;\n\n    log::info!(\"ReelVault lifecycle policy disabled for bucket: {}\", config.bucket_name);\n\n    Ok(LifecyclePolicyResult {\n        success: true,\n        message: \"ReelVault lifecycle policy disabled\".to_string(),\n        rule_id: REELVAULT_RULE_ID.to_string(),\n        transition_days: 0,\n        storage_class: \"STANDARD\".to_string(),\n    })\n}\n\n/// 全ライフサイクルルール一覧を取得（Phase 2準備）\n#[command]\npub async fn list_lifecycle_rules(config: AwsConfig) -\u003e Result\u003cVec\u003cLifecycleRule\u003e, String\u003e {\n    // 設定の基本検証\n    if config.bucket_name.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Bucket name is required\".to_string())));\n    }\n\n    // S3ClientTraitを使用\n    let aws_credentials = match create_aws_config(\u0026config).await {\n        Ok(aws_config) =\u003e AwsCredentials {\n            access_key_id: config.access_key_id.clone(),\n            secret_access_key: config.secret_access_key.clone(),\n            session_token: None,\n            region: config.region.clone(),\n        },\n        Err(e) =\u003e {\n            log::error!(\"Failed to create AWS config: {}\", e);\n            return Err(standardize_error(InternalError::Config(format!(\"AWS config creation failed: {}\", e))));\n        }\n    };\n    \n    let s3_client = match create_s3_client(\u0026aws_credentials).await {\n        Ok(client) =\u003e RealS3Client::new(client),\n        Err(e) =\u003e {\n            log::error!(\"Failed to create S3 client: {}\", e);\n            return Err(standardize_error(InternalError::S3(format!(\"S3 client creation failed: {}\", e))));\n        }\n    };\n\n    match s3_client.get_bucket_lifecycle_configuration(\u0026config.bucket_name).await {\n        Ok(rules) =\u003e {\n            Ok(rules)\n        }\n        Err(e) =\u003e {\n            log::error!(\"Failed to get lifecycle rules: {}\", e);\n            Err(standardize_error(InternalError::S3(format!(\"Failed to get lifecycle rules: {}\", e))))\n        }\n    }\n}\n\n/// ライフサイクル設定のバリデーション\n#[command]\npub async fn validate_lifecycle_config(config: AwsConfig) -\u003e Result\u003cbool, String\u003e {\n    // 基本的なバリデーション\n    if config.bucket_name.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Bucket name is required\".to_string())));\n    }\n\n    if config.access_key_id.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Access Key ID is required\".to_string())));\n    }\n\n    if config.secret_access_key.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Secret Access Key is required\".to_string())));\n    }\n\n    if config.region.is_empty() {\n        return Err(standardize_error(InternalError::Config(\"Region is required\".to_string())));\n    }\n\n    // TODO: AWS接続テストとバケット権限チェック\n    // let aws_config = aws_config::load_from_env().await;\n    // let s3_client = aws_sdk_s3::Client::new(\u0026aws_config);\n    // \n    // // バケット存在チェック\n    // s3_client.head_bucket().bucket(\u0026config.bucket_name).send().await\n    //     .map_err(|e| format!(\"Bucket access failed: {}\", e))?;\n    // \n    // // ライフサイクル設定権限チェック\n    // let test_config = create_reelvault_lifecycle_config();\n    // s3_client\n    //     .put_bucket_lifecycle_configuration()\n    //     .bucket(\u0026config.bucket_name)\n    //     .lifecycle_configuration(test_config)\n    //     .send()\n    //     .await\n    //     .map_err(|e| format!(\"Lifecycle permission denied: {}\", e))?;\n\n    log::info!(\"Lifecycle config validation completed for bucket: {}\", config.bucket_name);\n\n    Ok(true)\n}\n\n#[derive(serde::Serialize)]\npub struct UploadReadinessResult {\n    pub safe: bool,\n    pub message: String,\n    pub lifecycle_healthy: bool,\n}\n\n/// アップロード前の安全確認\n#[command]\npub async fn check_upload_readiness(config: AwsConfig) -\u003e Result\u003cUploadReadinessResult, String\u003e {\n    log::info!(\"Checking upload readiness for bucket: {}\", config.bucket_name);\n\n    // 基本設定チェック\n    if config.bucket_name.is_empty() {\n        return Ok(UploadReadinessResult {\n            safe: false,\n            message: \"S3バケット名が設定されていません\".to_string(),\n            lifecycle_healthy: false,\n        });\n    }\n\n    if config.access_key_id.is_empty() || config.secret_access_key.is_empty() {\n        return Ok(UploadReadinessResult {\n            safe: false,\n            message: \"AWS認証情報が不完全です\".to_string(),\n            lifecycle_healthy: false,\n        });\n    }\n\n    // AWS設定を作成\n    let aws_credentials = match create_aws_config(\u0026config).await {\n        Ok(aws_config) =\u003e AwsCredentials {\n            access_key_id: config.access_key_id.clone(),\n            secret_access_key: config.secret_access_key.clone(),\n            session_token: None,\n            region: config.region.clone(),\n        },\n        Err(e) =\u003e {\n            log::error!(\"Failed to create AWS config: {}\", e);\n            return Ok(UploadReadinessResult {\n                safe: false,\n                message: format!(\"AWS設定の作成に失敗: {}\", e),\n                lifecycle_healthy: false,\n            });\n        }\n    };\n    \n    let s3_client = match create_s3_client(\u0026aws_credentials).await {\n        Ok(client) =\u003e RealS3Client::new(client),\n        Err(e) =\u003e {\n            log::error!(\"Failed to create S3 client: {}\", e);\n            return Ok(UploadReadinessResult {\n                safe: false,\n                message: format!(\"S3クライアントの作成に失敗: {}\", e),\n                lifecycle_healthy: false,\n            });\n        }\n    };\n\n    // 1. バケットアクセス確認\n    match s3_client.head_bucket(\u0026config.bucket_name).await {\n        Ok(_) =\u003e {\n            log::info!(\"✅ Bucket access confirmed: {}\", config.bucket_name);\n        }\n        Err(e) =\u003e {\n            log::warn!(\"❌ Bucket access check failed: {:?}\", e);\n            return Ok(UploadReadinessResult {\n                safe: false,\n                message: format!(\"バケット「{}」にアクセスできません: {}\", config.bucket_name, e),\n                lifecycle_healthy: false,\n            });\n        }\n    }\n\n    // 2. ライフサイクル設定確認\n    let lifecycle_healthy = match s3_client.get_bucket_lifecycle_configuration(\u0026config.bucket_name).await {\n        Ok(rules) =\u003e {\n            // ReelVaultルールが存在するかチェック\n            let reelvault_rule = rules.iter().find(|rule| {\n                rule.id == REELVAULT_RULE_ID\n            });\n\n            if let Some(rule) = reelvault_rule {\n                // ルールがEnabledかチェック\n                let enabled = rule.status == \"Enabled\";\n                log::info!(\"ReelVault lifecycle rule found, enabled: {}\", enabled);\n                enabled\n            } else {\n                log::warn!(\"ReelVault lifecycle rule not found\");\n                false\n            }\n        },\n        Err(e) =\u003e {\n            // エラーの詳細をチェック\n            let error_string = e.to_string();\n            log::warn!(\"Error checking lifecycle configuration: {}\", error_string);\n            \n            if error_string.contains(\"NoSuchLifecycleConfiguration\") {\n                log::info!(\"No lifecycle configuration found for bucket: {} - upload not safe\", config.bucket_name);\n                false\n            } else {\n                log::error!(\"Unexpected lifecycle check error: {:?}\", e);\n                false\n            }\n        }\n    };\n\n    // 3. 結果判定\n    if lifecycle_healthy {\n        log::info!(\"✅ Upload readiness check passed for bucket: {}\", config.bucket_name);\n        Ok(UploadReadinessResult {\n            safe: true,\n            message: \"アップロード準備完了。ライフサイクル設定も正常です。\".to_string(),\n            lifecycle_healthy: true,\n        })\n    } else {\n        log::warn!(\"⚠️ Upload readiness check failed - lifecycle not configured for bucket: {}\", config.bucket_name);\n        Ok(UploadReadinessResult {\n            safe: false,\n            message: format!(\n                \"ライフサイクル設定に問題があります。バケット「{}」のライフサイクルポリシーが見つかりません。AWS認証タブで「🔄 ライフサイクル再設定」を実行してください。\", \n                config.bucket_name\n            ),\n            lifecycle_healthy: false,\n        })\n    }\n}\n\n// 内部ヘルパー関数（将来のAWS SDK実装用）\n\n// ReelVault固定ライフサイクル設定を生成\n// fn create_reelvault_lifecycle_config() -\u003e LifecycleConfiguration {\n//     use aws_sdk_s3::types::{\n//         LifecycleConfiguration, LifecycleRule, LifecycleRuleFilter,\n//         Transition, BucketLifecycleConfigurationStatus, TransitionStorageClass\n//     };\n//     \n//     let transition = Transition::builder()\n//         .days(REELVAULT_TRANSITION_DAYS)\n//         .storage_class(TransitionStorageClass::DeepArchive)\n//         .build();\n//     \n//     let rule = LifecycleRule::builder()\n//         .id(REELVAULT_RULE_ID)\n//         .status(BucketLifecycleConfigurationStatus::Enabled)\n//         .filter(LifecycleRuleFilter::Prefix(\"uploads/\".to_string()))\n//         .transitions(transition)\n//         .build();\n//     \n//     LifecycleConfiguration::builder()\n//         .rules(rule)\n//         .build()\n// }\n\n// ライフサイクルルールをパース\n// fn parse_lifecycle_rule(rule: LifecycleRule) -\u003e LifecyclePolicyStatus {\n//     let mut transition_days = None;\n//     let mut storage_class = None;\n//     \n//     if let Some(transitions) = rule.transitions {\n//         if let Some(first_transition) = transitions.first() {\n//             transition_days = first_transition.days;\n//             storage_class = first_transition.storage_class.as_ref().map(|s| s.to_string());\n//         }\n//     }\n//     \n//     let prefix = match rule.filter {\n//         Some(LifecycleRuleFilter::Prefix(p)) =\u003e Some(p),\n//         _ =\u003e None,\n//     };\n//     \n//     LifecyclePolicyStatus {\n//         enabled: rule.status == Some(BucketLifecycleConfigurationStatus::Enabled),\n//         rule_id: rule.id,\n//         transition_days,\n//         storage_class,\n//         prefix,\n//         error_message: None,\n//     }\n// }\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_lifecycle_policy_result_creation() {\n        let result = LifecyclePolicyResult {\n            success: true,\n            message: \"ReelVault lifecycle policy enabled: 1 day(s) -\u003e DEEP_ARCHIVE\".to_string(),\n            rule_id: REELVAULT_RULE_ID.to_string(),\n            transition_days: 1,\n            storage_class: REELVAULT_STORAGE_CLASS.to_string(),\n        };\n        assert!(result.success);\n        assert_eq!(result.message, \"ReelVault lifecycle policy enabled: 1 day(s) -\u003e DEEP_ARCHIVE\");\n        assert_eq!(result.rule_id, REELVAULT_RULE_ID.to_string());\n        assert_eq!(result.transition_days, 1);\n        assert_eq!(result.storage_class, REELVAULT_STORAGE_CLASS.to_string());\n    }\n\n    #[test]\n    fn test_lifecycle_policy_status_variants() {\n        let enabled = LifecyclePolicyStatus {\n            enabled: true,\n            rule_id: Some(REELVAULT_RULE_ID.to_string()),\n            transition_days: Some(1),\n            storage_class: Some(REELVAULT_STORAGE_CLASS.to_string()),\n            prefix: Some(\"uploads/\".to_string()),\n            error_message: None,\n        };\n        let disabled = LifecyclePolicyStatus {\n            enabled: false,\n            rule_id: None,\n            transition_days: None,\n            storage_class: None,\n            prefix: None,\n            error_message: None,\n        };\n        let not_found = LifecyclePolicyStatus {\n            enabled: false,\n            rule_id: None,\n            transition_days: None,\n            storage_class: None,\n            prefix: None,\n            error_message: Some(\"ReelVault lifecycle rule not found\".to_string()),\n        };\n        let error = LifecyclePolicyStatus {\n            enabled: false,\n            rule_id: None,\n            transition_days: None,\n            storage_class: None,\n            prefix: None,\n            error_message: Some(\"ライフサイクル設定取得エラー: test error\".to_string()),\n        };\n        \n        assert!(enabled.enabled);\n        assert_eq!(enabled.rule_id, Some(REELVAULT_RULE_ID.to_string()));\n        assert_eq!(enabled.transition_days, Some(1));\n        assert_eq!(enabled.storage_class, Some(REELVAULT_STORAGE_CLASS.to_string()));\n        assert_eq!(enabled.prefix, Some(\"uploads/\".to_string()));\n        assert_eq!(enabled.error_message, None);\n\n        assert!(!disabled.enabled);\n        assert_eq!(disabled.rule_id, None);\n        assert_eq!(disabled.transition_days, None);\n        assert_eq!(disabled.storage_class, None);\n        assert_eq!(disabled.prefix, None);\n        assert_eq!(disabled.error_message, None);\n\n        assert!(!not_found.enabled);\n        assert_eq!(not_found.rule_id, None);\n        assert_eq!(not_found.transition_days, None);\n        assert_eq!(not_found.storage_class, None);\n        assert_eq!(not_found.prefix, None);\n        assert_eq!(not_found.error_message, Some(\"ReelVault lifecycle rule not found\".to_string()));\n\n        assert!(!error.enabled);\n        assert_eq!(error.rule_id, None);\n        assert_eq!(error.transition_days, None);\n        assert_eq!(error.storage_class, None);\n        assert_eq!(error.prefix, None);\n        assert_eq!(error.error_message, Some(\"ライフサイクル設定取得エラー: test error\".to_string()));\n    }\n\n    #[test]\n    fn test_lifecycle_rule_creation() {\n        let rule = LifecycleRule {\n            id: \"ReelVault-Default-Auto-Archive\".to_string(),\n            status: \"Enabled\".to_string(),\n            prefix: Some(\"uploads/\".to_string()),\n            transitions: vec![\n                LifecycleTransition {\n                    days: 1,\n                    storage_class: \"DEEP_ARCHIVE\".to_string(),\n                },\n            ],\n        };\n        assert_eq!(rule.id, \"ReelVault-Default-Auto-Archive\");\n        assert_eq!(rule.status, \"Enabled\");\n        assert_eq!(rule.prefix, Some(\"uploads/\".to_string()));\n        assert_eq!(rule.transitions.len(), 1);\n        assert_eq!(rule.transitions[0].days, 1);\n        assert_eq!(rule.transitions[0].storage_class, \"DEEP_ARCHIVE\");\n    }\n\n    #[test]\n    fn test_lifecycle_transition_creation() {\n        let transition = LifecycleTransition {\n            days: 90,\n            storage_class: \"GLACIER\".to_string(),\n        };\n        assert_eq!(transition.days, 90);\n        assert_eq!(transition.storage_class, \"GLACIER\");\n    }\n\n    #[tokio::test]\n    async fn test_validate_lifecycle_config_valid() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        let result = validate_lifecycle_config(config).await;\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), true);\n    }\n\n    #[tokio::test]\n    async fn test_validate_lifecycle_config_invalid() {\n        // 空のconfigは不正\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        let result = validate_lifecycle_config(config).await;\n        assert!(result.is_err());\n        let err = result.unwrap_err();\n        assert!(err.contains(\"required\"));\n    }\n\n    #[tokio::test]\n    async fn test_enable_reelvault_lifecycle_success() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        let result = enable_reelvault_lifecycle(config).await;\n        assert!(result.is_ok());\n        let policy_result = result.unwrap();\n        assert!(policy_result.success);\n        assert!(policy_result.message.contains(\"enabled\"));\n    }\n\n    #[tokio::test]\n    async fn test_enable_reelvault_lifecycle_invalid() {\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        let result = enable_reelvault_lifecycle(config).await;\n        assert!(result.is_err());\n        let err = result.unwrap_err();\n        assert!(err.contains(\"required\"));\n    }\n\n    #[tokio::test]\n    async fn test_get_lifecycle_status_success() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        let result = get_lifecycle_status(config).await;\n        // モック実装では成功またはエラーメッセージ付きで失敗する可能性がある\n        if let Ok(status) = result {\n            // 成功した場合、基本的な構造を確認\n            assert!(status.rule_id.is_none() || status.rule_id.is_some());\n        } else {\n            // 失敗した場合、エラーメッセージが含まれていることを確認\n            let err = result.unwrap_err();\n            assert!(!err.is_empty());\n        }\n    }\n\n    #[tokio::test]\n    async fn test_get_lifecycle_status_invalid() {\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        let result = get_lifecycle_status(config).await;\n        assert!(result.is_err() || result.as_ref().unwrap().error_message.is_some());\n    }\n\n    #[tokio::test]\n    async fn test_disable_lifecycle_policy_success() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        let result = disable_lifecycle_policy(config).await;\n        assert!(result.is_ok());\n        let policy_result = result.unwrap();\n        assert!(policy_result.success);\n        assert!(policy_result.message.contains(\"disabled\"));\n    }\n\n    #[tokio::test]\n    async fn test_disable_lifecycle_policy_invalid() {\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        let result = disable_lifecycle_policy(config).await;\n        assert!(result.is_err());\n        let err = result.unwrap_err();\n        assert!(err.contains(\"required\"));\n    }\n\n    #[tokio::test]\n    async fn test_list_lifecycle_rules_success() {\n        let config = AwsConfig {\n            access_key_id: \"AKIA1234567890\".to_string(),\n            secret_access_key: \"secret123\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            bucket_name: \"test-bucket\".to_string(),\n        };\n        let result = list_lifecycle_rules(config).await;\n        // モック実装では成功またはエラーが返る可能性がある\n        if let Ok(rules) = result {\n            // 成功した場合、配列の長さを確認（0以上）\n            assert!(rules.len() \u003e= 0);\n        } else {\n            // 失敗した場合、エラーメッセージが含まれていることを確認\n            let err = result.unwrap_err();\n            assert!(!err.is_empty());\n        }\n    }\n\n    #[tokio::test]\n    async fn test_list_lifecycle_rules_invalid() {\n        let config = AwsConfig {\n            access_key_id: \"\".to_string(),\n            secret_access_key: \"\".to_string(),\n            region: \"\".to_string(),\n            bucket_name: \"\".to_string(),\n        };\n        let result = list_lifecycle_rules(config).await;\n        assert!(result.is_err());\n        let err = result.unwrap_err();\n        assert!(err.contains(\"required\"));\n    }\n} ","traces":[{"line":42,"address":[],"length":0,"stats":{"Line":4}},{"line":44,"address":[],"length":0,"stats":{"Line":2}},{"line":45,"address":[],"length":0,"stats":{"Line":1}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":82,"address":[],"length":0,"stats":{"Line":2}},{"line":83,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[],"length":0,"stats":{"Line":1}},{"line":134,"address":[],"length":0,"stats":{"Line":1}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":4}},{"line":212,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":1}},{"line":229,"address":[],"length":0,"stats":{"Line":1}},{"line":242,"address":[],"length":0,"stats":{"Line":4}},{"line":244,"address":[],"length":0,"stats":{"Line":2}},{"line":245,"address":[],"length":0,"stats":{"Line":1}},{"line":249,"address":[],"length":0,"stats":{"Line":1}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":1}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":1}},{"line":275,"address":[],"length":0,"stats":{"Line":1}},{"line":276,"address":[],"length":0,"stats":{"Line":1}},{"line":283,"address":[],"length":0,"stats":{"Line":4}},{"line":285,"address":[],"length":0,"stats":{"Line":2}},{"line":286,"address":[],"length":0,"stats":{"Line":1}},{"line":289,"address":[],"length":0,"stats":{"Line":1}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":1}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":1}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":1}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}}],"covered":37,"coverable":164},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","metadata.rs"],"content":"use std::path::PathBuf;\nuse std::collections::HashMap;\nuse serde::{Deserialize, Serialize};\nuse tauri::command;\nuse rusqlite::{Connection, Result as SqliteResult};\nuse sha2::{Sha256, Digest};\nuse std::fs::File;\nuse std::io::{BufReader, Read};\nuse std::sync::Mutex;\nuse crate::internal::{InternalError, standardize_error};\n\n/// ファイルメタデータを表す構造体\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct FileMetadata {\n    pub id: Option\u003ci64\u003e,\n    pub file_path: String,\n    pub file_name: String,\n    pub file_size: u64,\n    pub file_hash: String,\n    pub mime_type: String,\n    pub created_at: String,\n    pub modified_at: String,\n    pub video_metadata: Option\u003cVideoMetadata\u003e,\n    pub tags: Vec\u003cString\u003e,\n    pub custom_fields: HashMap\u003cString, String\u003e,\n}\n\n/// 動画メタデータを表す構造体\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct VideoMetadata {\n    pub duration: Option\u003cf64\u003e,\n    pub width: Option\u003cu32\u003e,\n    pub height: Option\u003cu32\u003e,\n    pub frame_rate: Option\u003cf64\u003e,\n    pub bit_rate: Option\u003cu64\u003e,\n    pub codec: Option\u003cString\u003e,\n    pub format: Option\u003cString\u003e,\n}\n\n/// メタデータ検索条件\n#[derive(Debug, Deserialize)]\npub struct MetadataSearchQuery {\n    pub file_name_pattern: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n    pub size_min: Option\u003cu64\u003e,\n    pub size_max: Option\u003cu64\u003e,\n    #[allow(dead_code)]\n    pub date_from: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    pub date_to: Option\u003cString\u003e,\n    pub mime_type: Option\u003cString\u003e,\n}\n\n/// データベース管理構造体\npub struct MetadataDatabase {\n    connection: Connection,\n}\n\nimpl MetadataDatabase {\n    /// 新しいデータベース接続を作成\n    pub fn new(db_path: \u0026str) -\u003e SqliteResult\u003cSelf\u003e {\n        let connection = Connection::open(db_path)?;\n        let db = MetadataDatabase { connection };\n        db.initialize_tables()?;\n        Ok(db)\n    }\n\n    /// データベーステーブルを初期化\n    fn initialize_tables(\u0026self) -\u003e SqliteResult\u003c()\u003e {\n        // ファイルメタデータテーブル\n        self.connection.execute(\n            \"CREATE TABLE IF NOT EXISTS file_metadata (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                file_path TEXT UNIQUE NOT NULL,\n                file_name TEXT NOT NULL,\n                file_size INTEGER NOT NULL,\n                file_hash TEXT NOT NULL,\n                mime_type TEXT NOT NULL,\n                created_at TEXT NOT NULL,\n                modified_at TEXT NOT NULL,\n                video_metadata TEXT,\n                custom_fields TEXT\n            )\",\n            [],\n        )?;\n\n        // タグテーブル\n        self.connection.execute(\n            \"CREATE TABLE IF NOT EXISTS tags (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                name TEXT UNIQUE NOT NULL\n            )\",\n            [],\n        )?;\n\n        // ファイル-タグ関連テーブル\n        self.connection.execute(\n            \"CREATE TABLE IF NOT EXISTS file_tags (\n                file_id INTEGER,\n                tag_id INTEGER,\n                PRIMARY KEY (file_id, tag_id),\n                FOREIGN KEY (file_id) REFERENCES file_metadata(id),\n                FOREIGN KEY (tag_id) REFERENCES tags(id)\n            )\",\n            [],\n        )?;\n\n        // インデックス作成\n        self.connection.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_file_path ON file_metadata(file_path)\",\n            [],\n        )?;\n        \n        self.connection.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_file_hash ON file_metadata(file_hash)\",\n            [],\n        )?;\n\n        Ok(())\n    }\n\n    /// メタデータを保存\n    pub fn save_metadata(\u0026self, metadata: \u0026FileMetadata) -\u003e SqliteResult\u003ci64\u003e {\n        let video_metadata_json = metadata.video_metadata\n            .as_ref()\n            .map(|vm| serde_json::to_string(vm).unwrap_or_default());\n        \n        let custom_fields_json = serde_json::to_string(\u0026metadata.custom_fields)\n            .unwrap_or_default();\n\n        let mut stmt = self.connection.prepare(\n            \"INSERT OR REPLACE INTO file_metadata \n             (file_path, file_name, file_size, file_hash, mime_type, created_at, modified_at, video_metadata, custom_fields)\n             VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9)\"\n        )?;\n\n        stmt.execute([\n            \u0026metadata.file_path,\n            \u0026metadata.file_name,\n            \u0026metadata.file_size.to_string(),\n            \u0026metadata.file_hash,\n            \u0026metadata.mime_type,\n            \u0026metadata.created_at,\n            \u0026metadata.modified_at,\n            \u0026video_metadata_json.unwrap_or_default(),\n            \u0026custom_fields_json,\n        ])?;\n\n        let file_id = self.connection.last_insert_rowid();\n\n        // タグを保存\n        self.save_tags(file_id, \u0026metadata.tags)?;\n\n        Ok(file_id)\n    }\n\n    /// タグを保存\n    fn save_tags(\u0026self, file_id: i64, tags: \u0026[String]) -\u003e SqliteResult\u003c()\u003e {\n        // 既存のタグ関連を削除\n        self.connection.execute(\n            \"DELETE FROM file_tags WHERE file_id = ?1\",\n            [file_id],\n        )?;\n\n        for tag in tags {\n            // タグを挿入（既存の場合は無視）\n            self.connection.execute(\n                \"INSERT OR IGNORE INTO tags (name) VALUES (?1)\",\n                [tag],\n            )?;\n\n            // タグIDを取得\n            let tag_id: i64 = self.connection.query_row(\n                \"SELECT id FROM tags WHERE name = ?1\",\n                [tag],\n                |row| row.get(0),\n            )?;\n\n            // ファイル-タグ関連を挿入\n            self.connection.execute(\n                \"INSERT INTO file_tags (file_id, tag_id) VALUES (?1, ?2)\",\n                [file_id, tag_id],\n            )?;\n        }\n\n        Ok(())\n    }\n\n    /// メタデータを検索\n    pub fn search_metadata(\u0026self, query: \u0026MetadataSearchQuery) -\u003e SqliteResult\u003cVec\u003cFileMetadata\u003e\u003e {\n        let mut sql = \"SELECT * FROM file_metadata WHERE 1=1\".to_string();\n        let mut params: Vec\u003cString\u003e = Vec::new();\n\n        if let Some(pattern) = \u0026query.file_name_pattern {\n            sql.push_str(\" AND file_name LIKE ?\");\n            params.push(format!(\"%{}%\", pattern));\n        }\n\n        if let Some(mime_type) = \u0026query.mime_type {\n            sql.push_str(\" AND mime_type = ?\");\n            params.push(mime_type.clone());\n        }\n\n        if let Some(size_min) = query.size_min {\n            sql.push_str(\" AND file_size \u003e= ?\");\n            params.push(size_min.to_string());\n        }\n\n        if let Some(size_max) = query.size_max {\n            sql.push_str(\" AND file_size \u003c= ?\");\n            params.push(size_max.to_string());\n        }\n\n        sql.push_str(\" ORDER BY modified_at DESC\");\n\n        let mut stmt = self.connection.prepare(\u0026sql)?;\n        let metadata_iter = stmt.query_map(\n            rusqlite::params_from_iter(params.iter()),\n            |row| {\n                let id: i64 = row.get(0)?;\n                let video_metadata_json: Option\u003cString\u003e = row.get(8)?;\n                let custom_fields_json: String = row.get(9)?;\n\n                let video_metadata = video_metadata_json\n                    .and_then(|json| serde_json::from_str(\u0026json).ok());\n                \n                let custom_fields: HashMap\u003cString, String\u003e = \n                    serde_json::from_str(\u0026custom_fields_json).unwrap_or_default();\n\n                // タグを取得\n                let tags = self.get_tags_for_file(id).unwrap_or_default();\n\n                Ok(FileMetadata {\n                    id: Some(id),\n                    file_path: row.get(1)?,\n                    file_name: row.get(2)?,\n                    file_size: row.get::\u003c_, i64\u003e(3)? as u64,\n                    file_hash: row.get(4)?,\n                    mime_type: row.get(5)?,\n                    created_at: row.get(6)?,\n                    modified_at: row.get(7)?,\n                    video_metadata,\n                    tags,\n                    custom_fields,\n                })\n            },\n        )?;\n\n        let mut results = Vec::new();\n        for metadata in metadata_iter {\n            results.push(metadata?);\n        }\n\n        Ok(results)\n    }\n\n    /// ファイルのタグを取得\n    fn get_tags_for_file(\u0026self, file_id: i64) -\u003e SqliteResult\u003cVec\u003cString\u003e\u003e {\n        let mut stmt = self.connection.prepare(\n            \"SELECT t.name FROM tags t \n             JOIN file_tags ft ON t.id = ft.tag_id \n             WHERE ft.file_id = ?1\"\n        )?;\n        \n        let tag_iter = stmt.query_map([file_id], |row| {\n            Ok(row.get::\u003c_, String\u003e(0)?)\n        })?;\n\n        let mut tags = Vec::new();\n        for tag in tag_iter {\n            tags.push(tag?);\n        }\n\n        Ok(tags)\n    }\n\n    /// ファイルパスでメタデータを取得\n    pub fn get_metadata_by_path(\u0026self, file_path: \u0026str) -\u003e SqliteResult\u003cFileMetadata\u003e {\n        let mut stmt = self.connection.prepare(\n            \"SELECT * FROM file_metadata WHERE file_path = ?1\"\n        )?;\n\n        let metadata = stmt.query_row([file_path], |row| {\n            let id: i64 = row.get(0)?;\n            let video_metadata_json: Option\u003cString\u003e = row.get(8)?;\n            let custom_fields_json: String = row.get(9)?;\n\n            let video_metadata = video_metadata_json\n                .and_then(|json| serde_json::from_str(\u0026json).ok());\n            \n            let custom_fields: HashMap\u003cString, String\u003e = \n                serde_json::from_str(\u0026custom_fields_json).unwrap_or_default();\n\n            // タグを取得\n            let tags = self.get_tags_for_file(id).unwrap_or_default();\n\n            Ok(FileMetadata {\n                id: Some(id),\n                file_path: row.get(1)?,\n                file_name: row.get(2)?,\n                file_size: row.get::\u003c_, i64\u003e(3)? as u64,\n                file_hash: row.get(4)?,\n                mime_type: row.get(5)?,\n                created_at: row.get(6)?,\n                modified_at: row.get(7)?,\n                video_metadata,\n                tags,\n                custom_fields,\n            })\n        })?;\n\n        Ok(metadata)\n    }\n\n    /// ファイルパスでメタデータを削除\n    pub fn delete_metadata(\u0026self, file_path: \u0026str) -\u003e SqliteResult\u003c()\u003e {\n        // ファイルIDを取得\n        let file_id: i64 = self.connection.query_row(\n            \"SELECT id FROM file_metadata WHERE file_path = ?1\",\n            [file_path],\n            |row| row.get(0),\n        )?;\n\n        // タグ関連を削除\n        self.connection.execute(\n            \"DELETE FROM file_tags WHERE file_id = ?1\",\n            [file_id],\n        )?;\n\n        // メタデータを削除\n        self.connection.execute(\n            \"DELETE FROM file_metadata WHERE id = ?1\",\n            [file_id],\n        )?;\n\n        Ok(())\n    }\n\n    /// すべてのタグを取得\n    pub fn get_all_tags(\u0026self) -\u003e SqliteResult\u003cVec\u003cString\u003e\u003e {\n        let mut stmt = self.connection.prepare(\"SELECT name FROM tags ORDER BY name\")?;\n        \n        let tag_iter = stmt.query_map([], |row| {\n            Ok(row.get::\u003c_, String\u003e(0)?)\n        })?;\n\n        let mut tags = Vec::new();\n        for tag in tag_iter {\n            tags.push(tag?);\n        }\n\n        Ok(tags)\n    }\n}\n\n/// ファイルハッシュを計算\npub fn calculate_file_hash(file_path: \u0026PathBuf) -\u003e Result\u003cString, InternalError\u003e {\n    let file = File::open(file_path)\n        .map_err(|e| InternalError::File(format!(\"Failed to open file: {}\", e)))?;\n    \n    let mut reader = BufReader::new(file);\n    let mut hasher = Sha256::new();\n    let mut buffer = [0; 1024];\n\n    loop {\n        let count = reader.read(\u0026mut buffer)\n            .map_err(|e| InternalError::File(format!(\"Failed to read file: {}\", e)))?;\n        if count == 0 {\n            break;\n        }\n        hasher.update(\u0026buffer[..count]);\n    }\n\n    Ok(format!(\"{:x}\", hasher.finalize()))\n}\n\n/// MIMEタイプを推定\npub fn detect_mime_type(file_path: \u0026PathBuf) -\u003e String {\n    if let Some(extension) = file_path.extension().and_then(|s| s.to_str()) {\n        match extension.to_lowercase().as_str() {\n            \"mp4\" =\u003e \"video/mp4\".to_string(),\n            \"mov\" =\u003e \"video/quicktime\".to_string(),\n            \"avi\" =\u003e \"video/x-msvideo\".to_string(),\n            \"mkv\" =\u003e \"video/x-matroska\".to_string(),\n            \"wmv\" =\u003e \"video/x-ms-wmv\".to_string(),\n            \"flv\" =\u003e \"video/x-flv\".to_string(),\n            \"webm\" =\u003e \"video/webm\".to_string(),\n            _ =\u003e \"application/octet-stream\".to_string(),\n        }\n    } else {\n        \"application/octet-stream\".to_string()\n    }\n}\n\n// Tauri Command API実装\n\n/// グローバルなメタデータデータベース接続\n#[allow(dead_code)]\npub struct MetadataState(pub Mutex\u003cOption\u003cMetadataDatabase\u003e\u003e);\n\n/// メタデータデータベースを初期化\n#[command]\npub async fn initialize_metadata_db(db_path: String) -\u003e Result\u003cString, String\u003e {\n    match MetadataDatabase::new(\u0026db_path) {\n        Ok(_) =\u003e Ok(\"Metadata database initialized successfully\".to_string()),\n        Err(e) =\u003e Err(standardize_error(InternalError::Database(format!(\"Failed to initialize metadata database: {}\", e))))\n    }\n}\n\n/// ファイルメタデータを作成\n#[command]\npub async fn create_file_metadata(\n    file_path: String,\n    tags: Vec\u003cString\u003e,\n    custom_fields: HashMap\u003cString, String\u003e,\n) -\u003e Result\u003cFileMetadata, String\u003e {\n    let path = PathBuf::from(\u0026file_path);\n    \n    // ファイルの存在確認\n    if !path.exists() {\n        return Err(standardize_error(InternalError::File(format!(\"File does not exist: {}\", file_path))));\n    }\n\n    // ファイル情報を取得\n    let metadata = std::fs::metadata(\u0026path)\n        .map_err(|e| standardize_error(InternalError::File(format!(\"Failed to get file metadata: {}\", e))))?;\n\n    // ファイルハッシュを計算\n    let file_hash = calculate_file_hash(\u0026path)\n        .map_err(|e| standardize_error(e))?;\n\n    // MIMEタイプを検出\n    let mime_type = detect_mime_type(\u0026path);\n\n    // 動画メタデータを抽出（動画ファイルの場合）\n    let video_metadata = if mime_type.starts_with(\"video/\") {\n        extract_video_metadata(\u0026path).ok()\n    } else {\n        None\n    };\n\n    let metadata = FileMetadata {\n        id: None,\n        file_path,\n        file_name: path.file_name()\n            .and_then(|n| n.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string(),\n        file_size: metadata.len(),\n        file_hash,\n        mime_type,\n        created_at: format!(\"{:?}\", metadata.created().unwrap_or(std::time::SystemTime::now())),\n        modified_at: format!(\"{:?}\", metadata.modified().unwrap_or(std::time::SystemTime::now())),\n        video_metadata,\n        tags,\n        custom_fields,\n    };\n\n    Ok(metadata)\n}\n\n/// ファイルメタデータを保存\n#[command]\npub async fn save_file_metadata(\n    metadata: FileMetadata,\n    db_path: String,\n) -\u003e Result\u003ci64, String\u003e {\n    let db = MetadataDatabase::new(\u0026db_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to create database connection: {}\", e))))?;\n\n    db.save_metadata(\u0026metadata)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to save metadata: {}\", e))))\n}\n\n/// ファイルメタデータを検索\n#[command]\npub async fn search_file_metadata(\n    query: MetadataSearchQuery,\n    db_path: String,\n) -\u003e Result\u003cVec\u003cFileMetadata\u003e, String\u003e {\n    let db = MetadataDatabase::new(\u0026db_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to create database connection: {}\", e))))?;\n\n    db.search_metadata(\u0026query)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to search metadata: {}\", e))))\n}\n\n/// ファイルメタデータを更新\n#[command]\npub async fn update_file_metadata(\n    file_path: String,\n    tags: Option\u003cVec\u003cString\u003e\u003e,\n    custom_fields: Option\u003cHashMap\u003cString, String\u003e\u003e,\n    db_path: String,\n) -\u003e Result\u003cString, String\u003e {\n    let db = MetadataDatabase::new(\u0026db_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to create database connection: {}\", e))))?;\n\n    // 既存のメタデータを取得\n    let existing_metadata = db.get_metadata_by_path(\u0026file_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to get existing metadata: {}\", e))))?;\n\n    let mut updated_metadata = existing_metadata;\n\n    // タグを更新\n    if let Some(new_tags) = tags {\n        updated_metadata.tags = new_tags;\n    }\n\n    // カスタムフィールドを更新\n    if let Some(new_fields) = custom_fields {\n        updated_metadata.custom_fields = new_fields;\n    }\n\n    // 更新されたメタデータを保存\n    db.save_metadata(\u0026updated_metadata)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to update metadata: {}\", e))))?;\n\n    Ok(\"Metadata updated successfully\".to_string())\n}\n\n/// ファイルメタデータを削除\n#[command]\npub async fn delete_file_metadata(\n    file_path: String,\n    db_path: String,\n) -\u003e Result\u003cString, String\u003e {\n    let db = MetadataDatabase::new(\u0026db_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to create database connection: {}\", e))))?;\n\n    db.delete_metadata(\u0026file_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to delete metadata: {}\", e))))?;\n\n    Ok(\"Metadata deleted successfully\".to_string())\n}\n\n/// すべてのタグを取得\n#[command]\npub async fn get_all_tags(db_path: String) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n    let db = MetadataDatabase::new(\u0026db_path)\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to create database connection: {}\", e))))?;\n\n    db.get_all_tags()\n        .map_err(|e| standardize_error(InternalError::Database(format!(\"Failed to get tags: {}\", e))))\n}\n\n/// 動画メタデータを抽出\nfn extract_video_metadata(_file_path: \u0026PathBuf) -\u003e Result\u003cVideoMetadata, InternalError\u003e {\n    // TODO: 実際の動画メタデータ抽出を実装\n    // 現在はダミーデータを返す\n    Ok(VideoMetadata {\n        duration: Some(120.0),\n        width: Some(1920),\n        height: Some(1080),\n        frame_rate: Some(30.0),\n        bit_rate: Some(5000000),\n        codec: Some(\"H.264\".to_string()),\n        format: Some(\"MP4\".to_string()),\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs;\n    use std::path::Path;\n    use tempfile::TempDir;\n\n    /// テスト用データベースを作成\n    fn create_test_db() -\u003e (MetadataDatabase, TempDir) {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let db_path = temp_dir.path().join(\"test.db\");\n        let db = MetadataDatabase::new(db_path.to_str().unwrap()).unwrap();\n        (db, temp_dir)\n    }\n\n    /// テスト用ファイルメタデータを作成\n    fn create_test_metadata() -\u003e FileMetadata {\n        let mut custom_fields = HashMap::new();\n        custom_fields.insert(\"description\".to_string(), \"Test video file\".to_string());\n\n        FileMetadata {\n            id: None,\n            file_path: \"/test/video.mp4\".to_string(),\n            file_name: \"video.mp4\".to_string(),\n            file_size: 1024 * 1024 * 100, // 100MB\n            file_hash: \"abc123def456\".to_string(),\n            mime_type: \"video/mp4\".to_string(),\n            created_at: \"1640995200\".to_string(), // 2022-01-01\n            modified_at: \"1640995200\".to_string(),\n            video_metadata: Some(VideoMetadata {\n                duration: Some(120.5),\n                width: Some(1920),\n                height: Some(1080),\n                frame_rate: Some(30.0),\n                bit_rate: Some(5000000),\n                codec: Some(\"h264\".to_string()),\n                format: Some(\"mp4\".to_string()),\n            }),\n            tags: vec![\"test\".to_string(), \"video\".to_string()],\n            custom_fields,\n        }\n    }\n\n    #[test]\n    fn test_database_initialization() {\n        let (_, _temp_dir) = create_test_db();\n        // データベースが正常に作成されることをテスト\n        // temp_dirが削除されることで自動的にクリーンアップ\n    }\n\n    #[test]\n    fn test_save_and_search_metadata() {\n        let (db, _temp_dir) = create_test_db();\n        let metadata = create_test_metadata();\n\n        // メタデータを保存\n        let file_id = db.save_metadata(\u0026metadata).unwrap();\n        assert!(file_id \u003e 0);\n\n        // 保存されたメタデータを検索\n        let search_query = MetadataSearchQuery {\n            file_name_pattern: Some(\"video\".to_string()),\n            tags: None,\n            size_min: None,\n            size_max: None,\n            date_from: None,\n            date_to: None,\n            mime_type: None,\n        };\n\n        let results = db.search_metadata(\u0026search_query).unwrap();\n        assert_eq!(results.len(), 1);\n        assert_eq!(results[0].file_name, \"video.mp4\");\n        assert_eq!(results[0].tags.len(), 2);\n        assert!(results[0].tags.contains(\u0026\"test\".to_string()));\n    }\n\n    #[test]\n    fn test_file_hash_calculation() {\n        // テスト用の一時ファイルを作成\n        let temp_dir = tempfile::tempdir().unwrap();\n        let file_path = temp_dir.path().join(\"test.txt\");\n        fs::write(\u0026file_path, \"Hello, World!\").unwrap();\n\n        // ハッシュを計算\n        let hash = calculate_file_hash(\u0026file_path).unwrap();\n        \n        // SHA256ハッシュが正しい形式であることを確認\n        assert_eq!(hash.len(), 64); // SHA256は64文字の16進数\n        assert!(hash.chars().all(|c| c.is_ascii_hexdigit()));\n    }\n\n    #[test]\n    fn test_mime_type_detection() {\n        let test_cases = vec![\n            (\"test.mp4\", \"video/mp4\"),\n            (\"test.mov\", \"video/quicktime\"),\n            (\"test.avi\", \"video/x-msvideo\"),\n            (\"test.mkv\", \"video/x-matroska\"),\n            (\"test.unknown\", \"application/octet-stream\"),\n        ];\n\n        for (filename, expected_mime) in test_cases {\n            let path = PathBuf::from(filename);\n            let detected_mime = detect_mime_type(\u0026path);\n            assert_eq!(detected_mime, expected_mime);\n        }\n    }\n\n    #[test]\n    fn test_search_with_filters() {\n        let (db, _temp_dir) = create_test_db();\n        \n        // 複数のテストデータを作成\n        let mut metadata1 = create_test_metadata();\n        metadata1.file_path = \"/test/video1.mp4\".to_string();\n        metadata1.file_name = \"video1.mp4\".to_string();\n        metadata1.file_size = 1024 * 1024 * 50; // 50MB\n        \n        let mut metadata2 = create_test_metadata();\n        metadata2.file_path = \"/test/video2.avi\".to_string();\n        metadata2.file_name = \"video2.avi\".to_string();\n        metadata2.mime_type = \"video/x-msvideo\".to_string();\n        metadata2.file_size = 1024 * 1024 * 200; // 200MB\n\n        // メタデータを保存\n        db.save_metadata(\u0026metadata1).unwrap();\n        db.save_metadata(\u0026metadata2).unwrap();\n\n        // サイズフィルタでテスト\n        let size_query = MetadataSearchQuery {\n            file_name_pattern: None,\n            tags: None,\n            size_min: Some(1024 * 1024 * 100), // 100MB以上\n            size_max: None,\n            date_from: None,\n            date_to: None,\n            mime_type: None,\n        };\n\n        let results = db.search_metadata(\u0026size_query).unwrap();\n        assert_eq!(results.len(), 1);\n        assert_eq!(results[0].file_name, \"video2.avi\");\n\n        // MIMEタイプフィルタでテスト\n        let mime_query = MetadataSearchQuery {\n            file_name_pattern: None,\n            tags: None,\n            size_min: None,\n            size_max: None,\n            date_from: None,\n            date_to: None,\n            mime_type: Some(\"video/mp4\".to_string()),\n        };\n\n        let results = db.search_metadata(\u0026mime_query).unwrap();\n        assert_eq!(results.len(), 1);\n        assert_eq!(results[0].file_name, \"video1.mp4\");\n    }\n\n    #[test]\n    fn test_tag_management() {\n        let (db, _temp_dir) = create_test_db();\n        let metadata = create_test_metadata();\n\n        // メタデータを保存\n        let file_id = db.save_metadata(\u0026metadata).unwrap();\n\n        // タグを取得\n        let tags = db.get_tags_for_file(file_id).unwrap();\n        assert_eq!(tags.len(), 2);\n        assert!(tags.contains(\u0026\"test\".to_string()));\n        assert!(tags.contains(\u0026\"video\".to_string()));\n    }\n\n    #[test]\n    fn test_video_metadata_extraction() {\n        let path = PathBuf::from(\"test.mp4\");\n        let video_metadata = extract_video_metadata(\u0026path).unwrap();\n        \n        // 基本実装では format のみ設定される（大文字で返される）\n        assert_eq!(video_metadata.format, Some(\"MP4\".to_string()));\n        assert!(video_metadata.duration.is_some()); // 現在の実装では120.0が設定される\n    }\n\n    #[test]\n    fn test_custom_fields() {\n        let (db, _temp_dir) = create_test_db();\n        let metadata = create_test_metadata();\n\n        // メタデータを保存\n        db.save_metadata(\u0026metadata).unwrap();\n\n        // カスタムフィールドでメタデータを検索\n        let search_query = MetadataSearchQuery {\n            file_name_pattern: Some(\"video\".to_string()),\n            tags: None,\n            size_min: None,\n            size_max: None,\n            date_from: None,\n            date_to: None,\n            mime_type: None,\n        };\n\n        let results = db.search_metadata(\u0026search_query).unwrap();\n        assert_eq!(results.len(), 1);\n        \n        let custom_fields = \u0026results[0].custom_fields;\n        assert_eq!(custom_fields.get(\"description\").unwrap(), \"Test video file\");\n    }\n} ","traces":[{"line":62,"address":[],"length":0,"stats":{"Line":5}},{"line":63,"address":[],"length":0,"stats":{"Line":10}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":5}},{"line":70,"address":[],"length":0,"stats":{"Line":5}},{"line":72,"address":[],"length":0,"stats":{"Line":5}},{"line":89,"address":[],"length":0,"stats":{"Line":5}},{"line":98,"address":[],"length":0,"stats":{"Line":5}},{"line":110,"address":[],"length":0,"stats":{"Line":5}},{"line":115,"address":[],"length":0,"stats":{"Line":5}},{"line":120,"address":[],"length":0,"stats":{"Line":5}},{"line":124,"address":[],"length":0,"stats":{"Line":5}},{"line":125,"address":[],"length":0,"stats":{"Line":5}},{"line":127,"address":[],"length":0,"stats":{"Line":15}},{"line":129,"address":[],"length":0,"stats":{"Line":5}},{"line":132,"address":[],"length":0,"stats":{"Line":10}},{"line":150,"address":[],"length":0,"stats":{"Line":5}},{"line":153,"address":[],"length":0,"stats":{"Line":5}},{"line":155,"address":[],"length":0,"stats":{"Line":5}},{"line":159,"address":[],"length":0,"stats":{"Line":5}},{"line":161,"address":[],"length":0,"stats":{"Line":5}},{"line":163,"address":[],"length":0,"stats":{"Line":5}},{"line":166,"address":[],"length":0,"stats":{"Line":25}},{"line":168,"address":[],"length":0,"stats":{"Line":10}},{"line":170,"address":[],"length":0,"stats":{"Line":10}},{"line":174,"address":[],"length":0,"stats":{"Line":20}},{"line":176,"address":[],"length":0,"stats":{"Line":10}},{"line":177,"address":[],"length":0,"stats":{"Line":20}},{"line":187,"address":[],"length":0,"stats":{"Line":5}},{"line":191,"address":[],"length":0,"stats":{"Line":4}},{"line":192,"address":[],"length":0,"stats":{"Line":4}},{"line":193,"address":[],"length":0,"stats":{"Line":4}},{"line":195,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":5}},{"line":205,"address":[],"length":0,"stats":{"Line":5}},{"line":210,"address":[],"length":0,"stats":{"Line":4}},{"line":215,"address":[],"length":0,"stats":{"Line":4}},{"line":217,"address":[],"length":0,"stats":{"Line":8}},{"line":218,"address":[],"length":0,"stats":{"Line":4}},{"line":220,"address":[],"length":0,"stats":{"Line":4}},{"line":221,"address":[],"length":0,"stats":{"Line":8}},{"line":222,"address":[],"length":0,"stats":{"Line":4}},{"line":223,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":4}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":4}},{"line":238,"address":[],"length":0,"stats":{"Line":4}},{"line":239,"address":[],"length":0,"stats":{"Line":4}},{"line":240,"address":[],"length":0,"stats":{"Line":4}},{"line":241,"address":[],"length":0,"stats":{"Line":4}},{"line":242,"address":[],"length":0,"stats":{"Line":4}},{"line":243,"address":[],"length":0,"stats":{"Line":4}},{"line":244,"address":[],"length":0,"stats":{"Line":4}},{"line":245,"address":[],"length":0,"stats":{"Line":4}},{"line":251,"address":[],"length":0,"stats":{"Line":12}},{"line":252,"address":[],"length":0,"stats":{"Line":4}},{"line":255,"address":[],"length":0,"stats":{"Line":4}},{"line":259,"address":[],"length":0,"stats":{"Line":5}},{"line":260,"address":[],"length":0,"stats":{"Line":10}},{"line":266,"address":[],"length":0,"stats":{"Line":15}},{"line":267,"address":[],"length":0,"stats":{"Line":10}},{"line":271,"address":[],"length":0,"stats":{"Line":25}},{"line":272,"address":[],"length":0,"stats":{"Line":10}},{"line":275,"address":[],"length":0,"stats":{"Line":5}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":3}},{"line":359,"address":[],"length":0,"stats":{"Line":6}},{"line":360,"address":[],"length":0,"stats":{"Line":6}},{"line":367,"address":[],"length":0,"stats":{"Line":12298}},{"line":368,"address":[],"length":0,"stats":{"Line":12298}},{"line":370,"address":[],"length":0,"stats":{"Line":3}},{"line":372,"address":[],"length":0,"stats":{"Line":6146}},{"line":379,"address":[],"length":0,"stats":{"Line":7}},{"line":380,"address":[],"length":0,"stats":{"Line":28}},{"line":382,"address":[],"length":0,"stats":{"Line":1}},{"line":383,"address":[],"length":0,"stats":{"Line":7}},{"line":384,"address":[],"length":0,"stats":{"Line":6}},{"line":385,"address":[],"length":0,"stats":{"Line":5}},{"line":386,"address":[],"length":0,"stats":{"Line":3}},{"line":387,"address":[],"length":0,"stats":{"Line":3}},{"line":388,"address":[],"length":0,"stats":{"Line":3}},{"line":389,"address":[],"length":0,"stats":{"Line":3}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":2}},{"line":418,"address":[],"length":0,"stats":{"Line":2}},{"line":421,"address":[],"length":0,"stats":{"Line":2}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":4}},{"line":427,"address":[],"length":0,"stats":{"Line":4}},{"line":430,"address":[],"length":0,"stats":{"Line":2}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":2}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":1}},{"line":552,"address":[],"length":0,"stats":{"Line":1}},{"line":553,"address":[],"length":0,"stats":{"Line":1}},{"line":554,"address":[],"length":0,"stats":{"Line":1}},{"line":555,"address":[],"length":0,"stats":{"Line":1}},{"line":556,"address":[],"length":0,"stats":{"Line":1}},{"line":557,"address":[],"length":0,"stats":{"Line":1}},{"line":558,"address":[],"length":0,"stats":{"Line":1}},{"line":559,"address":[],"length":0,"stats":{"Line":1}}],"covered":95,"coverable":180},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","state_management.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::sync::{Arc, Mutex};\nuse tauri::{command, State};\nuse crate::internal::{InternalError, standardize_error};\n\n/// アプリケーションのグローバル状態\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct AppState {\n    pub is_watching: bool,\n    pub upload_queue: Vec\u003cUploadItem\u003e,\n    pub current_uploads: Vec\u003cUploadProgress\u003e,\n    pub statistics: AppStatistics,\n    pub last_error: Option\u003cString\u003e,\n    pub system_status: SystemStatus,\n}\n\n/// アップロードキューのアイテム\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct UploadItem {\n    pub id: String,\n    pub file_path: String,\n    pub file_name: String,\n    pub file_size: u64,\n    pub status: UploadStatus,\n    pub created_at: String,\n    pub progress: f64,\n}\n\n/// アップロード状況\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub enum UploadStatus {\n    Pending,\n    InProgress,\n    Completed,\n    Failed,\n    Paused,\n}\n\n/// アップロード進捗\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct UploadProgress {\n    pub item_id: String,\n    pub uploaded_bytes: u64,\n    pub total_bytes: u64,\n    pub percentage: f64,\n    pub speed_mbps: f64,\n    pub eta_seconds: Option\u003cu64\u003e,\n}\n\n/// アプリケーション統計\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct AppStatistics {\n    pub total_files_uploaded: u64,\n    pub total_bytes_uploaded: u64,\n    pub files_in_queue: u64,\n    pub successful_uploads: u64,\n    pub failed_uploads: u64,\n    pub average_upload_speed_mbps: f64,\n}\n\n/// システム状態\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct SystemStatus {\n    pub aws_connected: bool,\n    pub disk_space_gb: f64,\n    pub memory_usage_mb: f64,\n    pub cpu_usage_percent: f64,\n    pub network_available: bool,\n    pub last_heartbeat: String,\n}\n\n/// 状態更新リクエスト\n#[derive(Debug, Deserialize)]\npub struct StateUpdate {\n    pub field: String,\n    pub value: serde_json::Value,\n}\n\nimpl Default for AppState {\n    fn default() -\u003e Self {\n        Self {\n            is_watching: false,\n            upload_queue: Vec::new(),\n            current_uploads: Vec::new(),\n            statistics: AppStatistics {\n                total_files_uploaded: 0,\n                total_bytes_uploaded: 0,\n                files_in_queue: 0,\n                successful_uploads: 0,\n                failed_uploads: 0,\n                average_upload_speed_mbps: 0.0,\n            },\n            last_error: None,\n            system_status: SystemStatus {\n                aws_connected: false,\n                disk_space_gb: 0.0,\n                memory_usage_mb: 0.0,\n                cpu_usage_percent: 0.0,\n                network_available: false,\n                last_heartbeat: chrono::Utc::now().to_rfc3339(),\n            },\n        }\n    }\n}\n\n/// グローバル状態管理用の型エイリアス\npub type AppStateManager = Arc\u003cMutex\u003cAppState\u003e\u003e;\n\n/// 現在のアプリケーション状態を取得\n#[command]\npub async fn get_app_state(state: State\u003c'_, AppStateManager\u003e) -\u003e Result\u003cAppState, String\u003e {\n    let app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    log::debug!(\"App state requested\");\n    Ok(app_state.clone())\n}\n\n/// アプリケーション状態を更新\n#[command]\npub async fn set_app_state(\n    new_state: AppState,\n    state: State\u003c'_, AppStateManager\u003e\n) -\u003e Result\u003cString, String\u003e {\n    let mut app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    *app_state = new_state;\n    \n    log::info!(\"App state updated\");\n    Ok(\"Application state updated successfully\".to_string())\n}\n\n/// 状態の部分更新\n#[command]\npub async fn update_app_state(\n    update: StateUpdate,\n    state: State\u003c'_, AppStateManager\u003e\n) -\u003e Result\u003cString, String\u003e {\n    let mut app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    match update.field.as_str() {\n        \"is_watching\" =\u003e {\n            if let Some(value) = update.value.as_bool() {\n                app_state.is_watching = value;\n                log::info!(\"Watching status updated: {}\", value);\n            } else {\n                return Err(standardize_error(InternalError::Config(\"Invalid value for is_watching field\".to_string())));\n            }\n        }\n        \"last_error\" =\u003e {\n            if update.value.is_null() {\n                app_state.last_error = None;\n            } else if let Some(error) = update.value.as_str() {\n                app_state.last_error = Some(error.to_string());\n                log::warn!(\"Error recorded: {}\", error);\n            } else {\n                return Err(standardize_error(InternalError::Config(\"Invalid value for last_error field\".to_string())));\n            }\n        }\n        \"aws_connected\" =\u003e {\n            if let Some(value) = update.value.as_bool() {\n                app_state.system_status.aws_connected = value;\n                log::info!(\"AWS connection status updated: {}\", value);\n            } else {\n                return Err(standardize_error(InternalError::Config(\"Invalid value for aws_connected field\".to_string())));\n            }\n        }\n        _ =\u003e {\n            return Err(standardize_error(InternalError::Config(format!(\"Unknown state field: {}\", update.field))));\n        }\n    }\n    \n    // ハートビートを更新\n    app_state.system_status.last_heartbeat = chrono::Utc::now().to_rfc3339();\n    \n    Ok(format!(\"State field '{}' updated successfully\", update.field))\n}\n\n/// アップロードキューにアイテムを追加\n#[command]\npub async fn add_to_upload_queue(\n    file_path: String,\n    state: State\u003c'_, AppStateManager\u003e\n) -\u003e Result\u003cString, String\u003e {\n    use std::path::Path;\n    \n    let path = Path::new(\u0026file_path);\n    if !path.exists() {\n        return Err(standardize_error(InternalError::File(format!(\"File does not exist: {}\", file_path))));\n    }\n    \n    let metadata = std::fs::metadata(\u0026path)\n        .map_err(|e| standardize_error(InternalError::File(format!(\"Failed to get file metadata: {}\", e))))?;\n    \n    let file_name = path.file_name()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"Unknown\")\n        .to_string();\n    \n    let upload_item = UploadItem {\n        id: uuid::Uuid::new_v4().to_string(),\n        file_path: file_path.clone(),\n        file_name,\n        file_size: metadata.len(),\n        status: UploadStatus::Pending,\n        created_at: chrono::Utc::now().to_rfc3339(),\n        progress: 0.0,\n    };\n    \n    let mut app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    app_state.upload_queue.push(upload_item);\n    app_state.statistics.files_in_queue = app_state.upload_queue.len() as u64;\n    \n    log::info!(\"Added file to upload queue: {}\", file_path);\n    Ok(format!(\"Added file to upload queue: {}\", file_path))\n}\n\n/// システム統計を更新\n#[command]\npub async fn update_system_stats(\n    state: State\u003c'_, AppStateManager\u003e\n) -\u003e Result\u003cSystemStatus, String\u003e {\n    let mut app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    // システム情報を取得（簡易実装）\n    let disk_space = sysinfo::System::new_all().total_memory() as f64 / 1024.0 / 1024.0 / 1024.0;\n    let memory_usage = sysinfo::System::new_all().used_memory() as f64 / 1024.0 / 1024.0;\n    \n    app_state.system_status.disk_space_gb = disk_space;\n    app_state.system_status.memory_usage_mb = memory_usage;\n    app_state.system_status.last_heartbeat = chrono::Utc::now().to_rfc3339();\n    \n    log::debug!(\"System stats updated\");\n    Ok(app_state.system_status.clone())\n}\n\n/// アプリケーション状態をリセット\n#[command]\npub async fn reset_app_state(\n    state: State\u003c'_, AppStateManager\u003e\n) -\u003e Result\u003cString, String\u003e {\n    let mut app_state = state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock state: {}\", e))))?;\n    \n    *app_state = AppState::default();\n    \n    log::info!(\"App state reset to default\");\n    Ok(\"Application state reset successfully\".to_string())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::{Arc, Mutex};\n\n    #[test]\n    fn test_app_state_default() {\n        let state = AppState::default();\n        \n        assert_eq!(state.is_watching, false);\n        assert_eq!(state.upload_queue.len(), 0);\n        assert_eq!(state.current_uploads.len(), 0);\n        assert_eq!(state.statistics.total_files_uploaded, 0);\n        assert_eq!(state.statistics.total_bytes_uploaded, 0);\n        assert_eq!(state.statistics.files_in_queue, 0);\n        assert_eq!(state.statistics.successful_uploads, 0);\n        assert_eq!(state.statistics.failed_uploads, 0);\n        assert_eq!(state.statistics.average_upload_speed_mbps, 0.0);\n        assert_eq!(state.last_error, None);\n        assert_eq!(state.system_status.aws_connected, false);\n        assert_eq!(state.system_status.disk_space_gb, 0.0);\n        assert_eq!(state.system_status.memory_usage_mb, 0.0);\n        assert_eq!(state.system_status.cpu_usage_percent, 0.0);\n        assert_eq!(state.system_status.network_available, false);\n        assert!(!state.system_status.last_heartbeat.is_empty());\n    }\n\n    #[test]\n    fn test_upload_item_creation() {\n        let item = UploadItem {\n            id: \"test-123\".to_string(),\n            file_path: \"/test/file.mp4\".to_string(),\n            file_name: \"file.mp4\".to_string(),\n            file_size: 1024 * 1024 * 100, // 100MB\n            status: UploadStatus::Pending,\n            created_at: \"2024-01-01T00:00:00Z\".to_string(),\n            progress: 0.0,\n        };\n        \n        assert_eq!(item.id, \"test-123\");\n        assert_eq!(item.file_path, \"/test/file.mp4\");\n        assert_eq!(item.file_name, \"file.mp4\");\n        assert_eq!(item.file_size, 1024 * 1024 * 100);\n        assert!(matches!(item.status, UploadStatus::Pending));\n        assert_eq!(item.progress, 0.0);\n    }\n\n    #[test]\n    fn test_upload_progress_creation() {\n        let progress = UploadProgress {\n            item_id: \"test-123\".to_string(),\n            uploaded_bytes: 50 * 1024 * 1024, // 50MB\n            total_bytes: 100 * 1024 * 1024,   // 100MB\n            percentage: 50.0,\n            speed_mbps: 10.5,\n            eta_seconds: Some(5),\n        };\n        \n        assert_eq!(progress.item_id, \"test-123\");\n        assert_eq!(progress.uploaded_bytes, 50 * 1024 * 1024);\n        assert_eq!(progress.total_bytes, 100 * 1024 * 1024);\n        assert_eq!(progress.percentage, 50.0);\n        assert_eq!(progress.speed_mbps, 10.5);\n        assert_eq!(progress.eta_seconds, Some(5));\n    }\n\n    #[test]\n    fn test_app_statistics_creation() {\n        let stats = AppStatistics {\n            total_files_uploaded: 10,\n            total_bytes_uploaded: 1024 * 1024 * 1024, // 1GB\n            files_in_queue: 5,\n            successful_uploads: 8,\n            failed_uploads: 2,\n            average_upload_speed_mbps: 15.5,\n        };\n        \n        assert_eq!(stats.total_files_uploaded, 10);\n        assert_eq!(stats.total_bytes_uploaded, 1024 * 1024 * 1024);\n        assert_eq!(stats.files_in_queue, 5);\n        assert_eq!(stats.successful_uploads, 8);\n        assert_eq!(stats.failed_uploads, 2);\n        assert_eq!(stats.average_upload_speed_mbps, 15.5);\n    }\n\n    #[test]\n    fn test_system_status_creation() {\n        let status = SystemStatus {\n            aws_connected: true,\n            disk_space_gb: 500.0,\n            memory_usage_mb: 8192.0,\n            cpu_usage_percent: 25.5,\n            network_available: true,\n            last_heartbeat: \"2024-01-01T00:00:00Z\".to_string(),\n        };\n        \n        assert_eq!(status.aws_connected, true);\n        assert_eq!(status.disk_space_gb, 500.0);\n        assert_eq!(status.memory_usage_mb, 8192.0);\n        assert_eq!(status.cpu_usage_percent, 25.5);\n        assert_eq!(status.network_available, true);\n        assert_eq!(status.last_heartbeat, \"2024-01-01T00:00:00Z\");\n    }\n\n    #[tokio::test]\n    async fn test_get_app_state() {\n        let state_manager: AppStateManager = Arc::new(Mutex::new(AppState::default()));\n        \n        // Stateをモックするために、直接関数を呼び出す\n        let result = {\n            let app_state = state_manager.lock().unwrap();\n            app_state.clone()\n        };\n        \n        assert_eq!(result.is_watching, false);\n        assert_eq!(result.upload_queue.len(), 0);\n        assert_eq!(result.current_uploads.len(), 0);\n        assert_eq!(result.last_error, None);\n    }\n\n    #[tokio::test]\n    async fn test_set_app_state() {\n        let state_manager: AppStateManager = Arc::new(Mutex::new(AppState::default()));\n        \n        let mut new_state = AppState::default();\n        new_state.is_watching = true;\n        new_state.last_error = Some(\"Test error\".to_string());\n        \n        // Stateをモックするために、直接関数を呼び出す\n        {\n            let mut app_state = state_manager.lock().unwrap();\n            *app_state = new_state.clone();\n        }\n        \n        // 状態が更新されたことを確認\n        let updated_state = {\n            let app_state = state_manager.lock().unwrap();\n            app_state.clone()\n        };\n        \n        assert_eq!(updated_state.is_watching, true);\n        assert_eq!(updated_state.last_error, Some(\"Test error\".to_string()));\n    }\n\n    #[tokio::test]\n    async fn test_update_app_state() {\n        let state_manager: AppStateManager = Arc::new(Mutex::new(AppState::default()));\n        \n        // is_watchingフィールドの更新テスト\n        {\n            let mut app_state = state_manager.lock().unwrap();\n            app_state.is_watching = true;\n        }\n        \n        // 更新されたことを確認\n        let updated_state = {\n            let app_state = state_manager.lock().unwrap();\n            app_state.clone()\n        };\n        \n        assert_eq!(updated_state.is_watching, true);\n    }\n\n    #[tokio::test]\n    async fn test_reset_app_state() {\n        let state_manager: AppStateManager = Arc::new(Mutex::new(AppState::default()));\n        \n        // 初期状態を変更\n        {\n            let mut app_state = state_manager.lock().unwrap();\n            app_state.is_watching = true;\n            app_state.last_error = Some(\"Test error\".to_string());\n        }\n        \n        // リセット\n        {\n            let mut app_state = state_manager.lock().unwrap();\n            *app_state = AppState::default();\n        }\n        \n        // リセットされたことを確認\n        let reset_state = {\n            let app_state = state_manager.lock().unwrap();\n            app_state.clone()\n        };\n        \n        assert_eq!(reset_state.is_watching, false);\n        assert_eq!(reset_state.last_error, None);\n        assert_eq!(reset_state.upload_queue.len(), 0);\n    }\n\n    #[tokio::test]\n    async fn test_upload_status_transitions() {\n        // UploadStatusの各状態をテスト\n        let pending = UploadStatus::Pending;\n        let in_progress = UploadStatus::InProgress;\n        let completed = UploadStatus::Completed;\n        let failed = UploadStatus::Failed;\n        let paused = UploadStatus::Paused;\n        \n        // 各状態が正しく識別されることを確認\n        assert!(matches!(pending, UploadStatus::Pending));\n        assert!(matches!(in_progress, UploadStatus::InProgress));\n        assert!(matches!(completed, UploadStatus::Completed));\n        assert!(matches!(failed, UploadStatus::Failed));\n        assert!(matches!(paused, UploadStatus::Paused));\n    }\n\n    #[tokio::test]\n    async fn test_app_statistics_calculation() {\n        let mut stats = AppStatistics {\n            total_files_uploaded: 0,\n            total_bytes_uploaded: 0,\n            files_in_queue: 0,\n            successful_uploads: 0,\n            failed_uploads: 0,\n            average_upload_speed_mbps: 0.0,\n        };\n        \n        // 統計情報の更新をシミュレート\n        stats.total_files_uploaded += 1;\n        stats.total_bytes_uploaded += 1024 * 1024 * 100; // 100MB\n        stats.successful_uploads += 1;\n        stats.average_upload_speed_mbps = 10.5;\n        \n        assert_eq!(stats.total_files_uploaded, 1);\n        assert_eq!(stats.total_bytes_uploaded, 1024 * 1024 * 100);\n        assert_eq!(stats.successful_uploads, 1);\n        assert_eq!(stats.failed_uploads, 0);\n        assert_eq!(stats.average_upload_speed_mbps, 10.5);\n    }\n\n    #[tokio::test]\n    async fn test_system_status_monitoring() {\n        let mut status = SystemStatus {\n            aws_connected: false,\n            disk_space_gb: 0.0,\n            memory_usage_mb: 0.0,\n            cpu_usage_percent: 0.0,\n            network_available: false,\n            last_heartbeat: \"2024-01-01T00:00:00Z\".to_string(),\n        };\n        \n        // システム状態の更新をシミュレート\n        status.aws_connected = true;\n        status.disk_space_gb = 500.0;\n        status.memory_usage_mb = 8192.0;\n        status.cpu_usage_percent = 25.5;\n        status.network_available = true;\n        status.last_heartbeat = \"2024-01-01T01:00:00Z\".to_string();\n        \n        assert_eq!(status.aws_connected, true);\n        assert_eq!(status.disk_space_gb, 500.0);\n        assert_eq!(status.memory_usage_mb, 8192.0);\n        assert_eq!(status.cpu_usage_percent, 25.5);\n        assert_eq!(status.network_available, true);\n        assert_eq!(status.last_heartbeat, \"2024-01-01T01:00:00Z\");\n    }\n\n    #[tokio::test]\n    async fn test_state_update_validation() {\n        let state_manager: AppStateManager = Arc::new(Mutex::new(AppState::default()));\n        \n        // 無効なフィールド名での更新をテスト\n        // 実際の実装では、update_app_state関数でエラーハンドリングされる\n        // ここでは状態管理の基本動作を確認\n        \n        let initial_state = {\n            let app_state = state_manager.lock().unwrap();\n            app_state.clone()\n        };\n        \n        // 初期状態の確認\n        assert_eq!(initial_state.is_watching, false);\n        assert_eq!(initial_state.last_error, None);\n        assert_eq!(initial_state.system_status.aws_connected, false);\n    }\n} ","traces":[{"line":80,"address":[],"length":0,"stats":{"Line":8}},{"line":83,"address":[],"length":0,"stats":{"Line":8}},{"line":84,"address":[],"length":0,"stats":{"Line":8}},{"line":85,"address":[],"length":0,"stats":{"Line":8}},{"line":94,"address":[],"length":0,"stats":{"Line":8}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}}],"covered":5,"coverable":74},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","commands","upload_system.rs"],"content":"use std::collections::HashMap;\nuse std::path::Path;\nuse std::sync::{Arc, Mutex};\nuse std::time::{Duration, Instant};\nuse serde::{Deserialize, Serialize};\nuse tauri::{command, State, AppHandle, Emitter};\nuse tokio::sync::mpsc;\nuse tokio::time::sleep;\nuse uuid::Uuid;\n\nuse crate::commands::aws_auth::AwsCredentials;\nuse crate::commands::metadata::create_file_metadata;\nuse crate::internal::{InternalError, standardize_error};\nuse crate::commands::aws_operations::{S3ClientTrait, MockS3Client, RealS3Client, create_s3_client};\n\n/// アップロードアイテムの状態\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\npub enum UploadStatus {\n    Pending,\n    InProgress,\n    Completed,\n    Failed,\n    Paused,\n    Cancelled,\n}\n\n/// アップロードアイテム\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UploadItem {\n    pub id: String,\n    pub file_path: String,\n    pub file_name: String,\n    pub file_size: u64,\n    pub s3_key: String,\n    pub status: UploadStatus,\n    pub progress: f64,\n    pub uploaded_bytes: u64,\n    pub speed_mbps: f64,\n    pub eta_seconds: Option\u003cu64\u003e,\n    pub created_at: String,\n    pub started_at: Option\u003cString\u003e,\n    pub completed_at: Option\u003cString\u003e,\n    pub error_message: Option\u003cString\u003e,\n    pub retry_count: u32,\n}\n\n/// アップロード進捗情報\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UploadProgress {\n    pub item_id: String,\n    pub uploaded_bytes: u64,\n    pub total_bytes: u64,\n    pub percentage: f64,\n    pub speed_mbps: f64,\n    pub eta_seconds: Option\u003cu64\u003e,\n    pub status: UploadStatus,\n}\n\n/// アップロード設定\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UploadConfig {\n    pub aws_credentials: AwsCredentials,\n    pub bucket_name: String,\n    pub max_concurrent_uploads: usize,\n    pub chunk_size_mb: u64,\n    pub retry_attempts: u32,\n    pub timeout_seconds: u64,\n    pub auto_create_metadata: bool,\n    pub s3_key_prefix: Option\u003cString\u003e,\n    \n    // 🎯 統一システム用の制限パラメータ\n    pub max_concurrent_parts: usize,        // チャンクレベル並列度（無料版: 1, プレミアム版: 4-8）\n    pub adaptive_chunk_size: bool,          // 動的チャンクサイズ（無料版: false, プレミアム版: true）\n    pub min_chunk_size_mb: u64,            // 最小チャンクサイズ（無料版: 5MB固定）\n    pub max_chunk_size_mb: u64,            // 最大チャンクサイズ（無料版: 5MB固定）\n    pub bandwidth_limit_mbps: Option\u003cf64\u003e,  // 帯域制限（無料版: なし, プレミアム版: 設定可能）\n    pub enable_resume: bool,                // 中断・再開機能（無料版: false, プレミアム版: true）\n    pub tier: UploadTier,                   // 機能ティア\n}\n\n/// アップロード機能ティア\n#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq)]\npub enum UploadTier {\n    Free,     // 無料版\n    Premium,  // プレミアム版\n}\n\nimpl UploadConfig {\n\n\n}\n\n\n\n/// アップロードキューの管理\n#[derive(Debug)]\npub struct UploadQueue {\n    pub items: Vec\u003cUploadItem\u003e,\n    pub active_uploads: HashMap\u003cString, UploadProgress\u003e,\n    pub config: Option\u003cUploadConfig\u003e,\n    pub is_processing: bool,\n    pub total_uploaded_bytes: u64,\n    pub total_files_uploaded: u64,\n    /// 厳格な同時実行制御のための専用カウンター\n    pub active_upload_count: usize,\n}\n\nimpl UploadQueue {\n    pub fn new() -\u003e Self {\n        Self {\n            items: Vec::new(),\n            active_uploads: HashMap::new(),\n            config: None,\n            is_processing: false,\n            total_uploaded_bytes: 0,\n            total_files_uploaded: 0,\n            active_upload_count: 0,\n        }\n    }\n    \n    /// 安全な同時実行数取得\n    pub fn get_active_upload_count(\u0026self) -\u003e usize {\n        // 複数の状態を確認して最も正確な値を返す\n        let in_progress_count = self.items.iter()\n            .filter(|item| item.status == UploadStatus::InProgress)\n            .count();\n        let active_uploads_count = self.active_uploads.len();\n        \n        // 最大値を使用（より保守的なアプローチ）\n        std::cmp::max(\n            std::cmp::max(in_progress_count, active_uploads_count),\n            self.active_upload_count\n        )\n    }\n    \n    /// アップロード開始時の状態更新\n    pub fn start_upload(\u0026mut self, item_id: \u0026str) -\u003e Result\u003c(), InternalError\u003e {\n        if let Some(config) = \u0026self.config {\n            let current_active = self.get_active_upload_count();\n            \n            // 無料版の厳格な制限チェック\n            if config.max_concurrent_uploads == 1 \u0026\u0026 current_active \u003e 0 {\n                return Err(InternalError::Other(format!(\"無料版では同時アップロードは1つまでです。現在アクティブ: {}\", current_active)));\n            }\n            \n            if current_active \u003e= config.max_concurrent_uploads {\n                return Err(InternalError::Other(format!(\"同時アップロード数の上限に達しています: {}/{}\", \n                                 current_active, config.max_concurrent_uploads)));\n            }\n        }\n        \n        // 状態を更新\n        if let Some(item) = self.items.iter_mut().find(|i| i.id == item_id) {\n            item.status = UploadStatus::InProgress;\n            item.started_at = Some(chrono::Utc::now().to_rfc3339());\n            self.active_upload_count += 1;\n            \n            log::info!(\"Upload started: {} (active count: {})\", item_id, self.active_upload_count);\n            Ok(())\n        } else {\n            Err(InternalError::Other(format!(\"Upload item not found: {}\", item_id)))\n        }\n    }\n    \n    /// アップロード完了時の状態更新\n    pub fn complete_upload(\u0026mut self, item_id: \u0026str, success: bool, error_msg: Option\u003cString\u003e) {\n        log::info!(\"🔧 complete_upload called: {} (success: {})\", item_id, success);\n        \n        // アイテムの現在の状態をチェック\n        let current_status = self.items.iter()\n            .find(|i| i.id == item_id)\n            .map(|i| i.status.clone());\n        \n        if let Some(status) = \u0026current_status {\n            if *status == UploadStatus::Completed {\n                log::info!(\"⚠️  Upload already completed, skipping duplicate cleanup: {}\", item_id);\n                return;\n            }\n        }\n        \n        // アクティブカウントを減らす（重複減算を防ぐ）\n        let was_active = self.active_uploads.contains_key(item_id) || \n                        current_status == Some(UploadStatus::InProgress);\n        \n        log::info!(\"🔍 Cleanup state check - was_active: {}, active_uploads contains: {}, current_status: {:?}\", \n                   was_active, self.active_uploads.contains_key(item_id), current_status);\n        \n        if was_active \u0026\u0026 self.active_upload_count \u003e 0 {\n            self.active_upload_count -= 1;\n            log::info!(\"🔽 Active upload count decreased: {} -\u003e {}\", \n                       self.active_upload_count + 1, self.active_upload_count);\n        }\n        \n        // active_uploadsから削除（成功・失敗に関わらず必ず削除）\n        let removed = self.active_uploads.remove(item_id);\n        log::info!(\"🗑️  Removing from active_uploads: {} (was present: {})\", item_id, removed.is_some());\n        \n        // アイテムの状態を更新\n        if let Some(item) = self.items.iter_mut().find(|i| i.id == item_id) {\n            if success {\n                item.status = UploadStatus::Completed;\n                item.completed_at = Some(chrono::Utc::now().to_rfc3339());\n                item.progress = 100.0;\n                self.total_files_uploaded += 1;\n                self.total_uploaded_bytes += item.file_size;\n                log::info!(\"✅ Upload marked as completed: {} ({})\", item.file_name, item_id);\n            } else {\n                item.status = UploadStatus::Failed;\n                item.error_message = error_msg;\n                log::error!(\"❌ Upload marked as failed: {} ({})\", item.file_name, item_id);\n            }\n        }\n        \n        log::info!(\"📊 Upload completion summary - Active count: {}, Active uploads: {}, Items in progress: {}\", \n                   self.active_upload_count, \n                   self.active_uploads.len(),\n                   self.items.iter().filter(|i| i.status == UploadStatus::InProgress).count());\n    }\n    \n    /// 無料版制限チェック\n    pub fn check_free_tier_limits(\u0026self, new_files_count: usize) -\u003e Result\u003c(), InternalError\u003e {\n        if let Some(config) = \u0026self.config {\n            if config.tier == UploadTier::Free {\n                // 無料版の制限チェック\n                let total_files = self.items.len() + new_files_count;\n                if total_files \u003e 10 {\n                    return Err(InternalError::Other(\"無料版では最大10ファイルまでアップロードできます\".to_string()));\n                }\n                \n                let total_size_mb = (self.total_uploaded_bytes + \n                    self.items.iter().map(|i| i.file_size).sum::\u003cu64\u003e()) / 1024 / 1024;\n                if total_size_mb \u003e 100 {\n                    return Err(InternalError::Other(\"無料版では最大100MBまでアップロードできます\".to_string()));\n                }\n            }\n        }\n        Ok(())\n    }\n}\n\npub type UploadQueueState = Arc\u003cMutex\u003cUploadQueue\u003e\u003e;\n\n/// アップロード統計\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UploadStatistics {\n    pub total_files: u64,\n    pub completed_files: u64,\n    pub failed_files: u64,\n    pub pending_files: u64,\n    pub in_progress_files: u64,\n    pub total_bytes: u64,\n    pub uploaded_bytes: u64,\n    pub average_speed_mbps: f64,\n    pub estimated_time_remaining: Option\u003cu64\u003e,\n}\n\n/// ファイル選択ダイアログの結果\n#[derive(Debug, Serialize, Deserialize)]\npub struct FileSelection {\n    pub selected_files: Vec\u003cString\u003e,\n    pub total_size: u64,\n    pub file_count: u32,\n}\n\n/// S3キー生成設定\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct S3KeyConfig {\n    pub prefix: Option\u003cString\u003e,\n    pub use_date_folder: bool,\n    pub preserve_directory_structure: bool,\n    pub custom_naming_pattern: Option\u003cString\u003e,\n}\n\n/// アップロードキューを初期化\n#[command]\npub async fn initialize_upload_queue(\n    config: UploadConfig,\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    queue.config = Some(config);\n    queue.is_processing = false;\n    queue.items.clear();\n    queue.active_uploads.clear();\n    queue.total_uploaded_bytes = 0;\n    queue.total_files_uploaded = 0;\n    queue.active_upload_count = 0;\n    \n    log::info!(\"Upload queue initialized with configuration\");\n    Ok(\"Upload queue initialized successfully\".to_string())\n}\n\n/// ファイル選択ダイアログを開く\n#[command]\npub async fn open_file_dialog(\n    _app_handle: AppHandle,\n    multiple: bool,\n    _file_types: Option\u003cVec\u003cString\u003e\u003e,\n) -\u003e Result\u003cFileSelection, String\u003e {\n    let files = if multiple {\n        rfd::FileDialog::new()\n            .set_title(\"Select files to upload\")\n            .pick_files()\n    } else {\n        rfd::FileDialog::new()\n            .set_title(\"Select a file to upload\")\n            .pick_file()\n            .map(|f| vec![f])\n    };\n\n    match files {\n        Some(selected_files) =\u003e {\n            let total_size: u64 = selected_files.iter()\n                .map(|f| f.as_path().metadata().map(|m| m.len()).unwrap_or(0))\n                .sum();\n            \n            let file_paths: Vec\u003cString\u003e = selected_files.iter()\n                .map(|f| f.as_path().to_string_lossy().to_string())\n                .collect();\n            \n            Ok(FileSelection {\n                selected_files: file_paths,\n                total_size,\n                file_count: selected_files.len() as u32,\n            })\n        }\n        None =\u003e Err(standardize_error(InternalError::Other(\"No files selected\".to_string())))\n    }\n}\n\n/// ファイルをアップロードキューに追加\n#[command]\npub async fn add_files_to_upload_queue(\n    file_paths: Vec\u003cString\u003e,\n    s3_key_config: S3KeyConfig,\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    // 無料版の制限チェック\n    queue.check_free_tier_limits(file_paths.len())\n        .map_err(|e| standardize_error(e))?;\n    \n    let _config = queue.config.as_ref()\n        .ok_or_else(|| standardize_error(InternalError::Config(\"Upload configuration not initialized\".to_string())))?;\n    \n    for file_path in \u0026file_paths {\n        // ファイルの存在確認\n        if !Path::new(\u0026file_path).exists() {\n            return Err(standardize_error(InternalError::File(format!(\"File not found: {}\", file_path))));\n        }\n        \n        // S3キーを生成\n        let s3_key = generate_s3_key(\u0026file_path, \u0026s3_key_config)\n            .map_err(|e| standardize_error(InternalError::Other(e.to_string())))?;\n        \n        // ファイル情報を取得\n        let metadata = std::fs::metadata(\u0026file_path)\n            .map_err(|e| standardize_error(InternalError::File(format!(\"Failed to get file metadata: {}\", e))))?;\n        \n        let file_name = Path::new(\u0026file_path)\n            .file_name()\n            .and_then(|n| n.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string();\n        \n        // アップロードアイテムを作成\n        let item = UploadItem {\n            id: Uuid::new_v4().to_string(),\n            file_path: file_path.clone(),\n            file_name,\n            file_size: metadata.len(),\n            s3_key,\n            status: UploadStatus::Pending,\n            progress: 0.0,\n            uploaded_bytes: 0,\n            speed_mbps: 0.0,\n            eta_seconds: None,\n            created_at: chrono::Utc::now().to_rfc3339(),\n            started_at: None,\n            completed_at: None,\n            error_message: None,\n            retry_count: 0,\n        };\n        \n        queue.items.push(item);\n    }\n    \n    log::info!(\"Added {} files to upload queue\", file_paths.len());\n    Ok(format!(\"Added {} files to upload queue\", file_paths.len()))\n}\n\n/// アップロードアイテムを削除\n#[command]\npub async fn remove_upload_item(\n    item_id: String,\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    let initial_count = queue.items.len();\n    queue.items.retain(|item| item.id != item_id);\n    queue.active_uploads.remove(\u0026item_id);\n    \n    let removed_count = initial_count - queue.items.len();\n    if removed_count \u003e 0 {\n        log::info!(\"Removed upload item: {}\", item_id);\n        Ok(format!(\"Removed {} upload item(s)\", removed_count))\n    } else {\n        Err(standardize_error(InternalError::Other(format!(\"Upload item not found: {}\", item_id))))\n    }\n}\n\n/// アップロード処理を開始\n#[command]\npub async fn start_upload_processing(\n    app_handle: AppHandle,\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    if queue.is_processing {\n        return Err(standardize_error(InternalError::Other(\"Upload processing is already running\".to_string())));\n    }\n    \n    let config = queue.config.as_ref()\n        .ok_or_else(|| standardize_error(InternalError::Config(\"Upload configuration not initialized\".to_string())))?\n        .clone();\n    \n    queue.is_processing = true;\n    drop(queue); // ロックを解放\n    \n    // バックグラウンドでアップロード処理を開始\n    let queue_state_clone = queue_state.inner().clone();\n    let config_clone = config.clone();\n    \n    tokio::spawn(async move {\n        if let Err(e) = process_upload_queue(queue_state_clone, app_handle, config_clone).await {\n            log::error!(\"Upload processing failed: {}\", e);\n        }\n    });\n    \n    Ok(\"Upload processing started\".to_string())\n}\n\n/// アップロード処理を停止\n#[command]\npub async fn stop_upload_processing(\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    queue.is_processing = false;\n    \n    // 進行中のアップロードをキャンセル\n    for item in queue.items.iter_mut() {\n        if item.status == UploadStatus::InProgress {\n            item.status = UploadStatus::Cancelled;\n        }\n    }\n    \n    queue.active_uploads.clear();\n    queue.active_upload_count = 0;\n    \n    log::info!(\"Upload processing stopped\");\n    Ok(\"Upload processing stopped\".to_string())\n}\n\n/// アップロードキューの状態を取得\n#[command]\npub async fn get_upload_queue_status(\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cUploadStatistics, String\u003e {\n    let queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    let total_files = queue.items.len() as u64;\n    let completed_files = queue.items.iter()\n        .filter(|item| item.status == UploadStatus::Completed)\n        .count() as u64;\n    let failed_files = queue.items.iter()\n        .filter(|item| item.status == UploadStatus::Failed)\n        .count() as u64;\n    let pending_files = queue.items.iter()\n        .filter(|item| item.status == UploadStatus::Pending)\n        .count() as u64;\n    let in_progress_files = queue.items.iter()\n        .filter(|item| item.status == UploadStatus::InProgress)\n        .count() as u64;\n    \n    let total_bytes: u64 = queue.items.iter().map(|item| item.file_size).sum();\n    let uploaded_bytes: u64 = queue.items.iter().map(|item| item.uploaded_bytes).sum();\n    \n    let average_speed = if !queue.active_uploads.is_empty() {\n        queue.active_uploads.values()\n            .map(|progress| progress.speed_mbps)\n            .sum::\u003cf64\u003e() / queue.active_uploads.len() as f64\n    } else {\n        0.0\n    };\n    \n    let estimated_time = if average_speed \u003e 0.0 {\n        let remaining_bytes = total_bytes.saturating_sub(uploaded_bytes);\n        let remaining_mb = remaining_bytes as f64 / 1024.0 / 1024.0;\n        Some((remaining_mb / average_speed) as u64)\n    } else {\n        None\n    };\n    \n    Ok(UploadStatistics {\n        total_files,\n        completed_files,\n        failed_files,\n        pending_files,\n        in_progress_files,\n        total_bytes,\n        uploaded_bytes,\n        average_speed_mbps: average_speed,\n        estimated_time_remaining: estimated_time,\n    })\n}\n\n/// アップロードキューアイテムを取得\n#[command]\npub async fn get_upload_queue_items(\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cVec\u003cUploadItem\u003e, String\u003e {\n    let queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    Ok(queue.items.clone())\n}\n\n/// アップロードアイテムをリトライ\n#[command]\npub async fn retry_upload_item(\n    item_id: String,\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| standardize_error(InternalError::Other(format!(\"Failed to lock upload queue: {}\", e))))?;\n    \n    if let Some(item) = queue.items.iter_mut().find(|i| i.id == item_id) {\n        item.status = UploadStatus::Pending;\n        item.progress = 0.0;\n        item.uploaded_bytes = 0;\n        item.error_message = None;\n        item.retry_count += 1;\n        \n        log::info!(\"Retrying upload item: {}\", item_id);\n        Ok(\"Upload item queued for retry\".to_string())\n    } else {\n        Err(standardize_error(InternalError::Other(format!(\"Upload item not found: {}\", item_id))))\n    }\n}\n\n/// S3キーを生成\nfn generate_s3_key(file_path: \u0026str, config: \u0026S3KeyConfig) -\u003e Result\u003cString, InternalError\u003e {\n    let path = Path::new(file_path);\n    let file_name = path.file_name()\n        .and_then(|n| n.to_str())\n        .ok_or_else(|| InternalError::File(\"Invalid file name\".to_string()))?;\n    \n    let mut s3_key = String::new();\n    \n    // プレフィックスを追加\n    if let Some(prefix) = \u0026config.prefix {\n        s3_key.push_str(prefix);\n        if !s3_key.ends_with('/') {\n            s3_key.push('/');\n        }\n    }\n    \n    // 日付フォルダを追加\n    if config.use_date_folder {\n        let date = chrono::Utc::now().format(\"%Y/%m/%d\");\n        s3_key.push_str(\u0026date.to_string());\n        s3_key.push('/');\n    }\n    \n    // ディレクトリ構造を保持\n    if config.preserve_directory_structure {\n        if let Some(parent) = path.parent() {\n            if let Some(parent_str) = parent.to_str() {\n                if !parent_str.is_empty() \u0026\u0026 parent_str != \".\" {\n                    s3_key.push_str(parent_str);\n                    s3_key.push('/');\n                }\n            }\n        }\n    }\n    \n    // カスタム命名パターンを適用\n    if let Some(pattern) = \u0026config.custom_naming_pattern {\n        // 簡易的なパターン置換\n        let custom_name = pattern\n            .replace(\"{filename}\", file_name)\n            .replace(\"{timestamp}\", \u0026chrono::Utc::now().timestamp().to_string())\n            .replace(\"{uuid}\", \u0026Uuid::new_v4().to_string());\n        s3_key.push_str(\u0026custom_name);\n    } else {\n        s3_key.push_str(file_name);\n    }\n    \n    Ok(s3_key)\n}\n\n/// バックグラウンドでアップロードキューを処理\nasync fn process_upload_queue(\n    queue_state: UploadQueueState,\n    app_handle: AppHandle,\n    config: UploadConfig,\n) -\u003e Result\u003c(), String\u003e {\n    log::info!(\"🚀 process_upload_queue started with max_concurrent: {}\", config.max_concurrent_uploads);\n    \n    // 開始時のテストイベント送信\n    if let Err(e) = app_handle.emit(\"test-event\", \"process_upload_queue started\") {\n        log::error!(\"Failed to emit process start test event: {}\", e);\n    } else {\n        log::info!(\"Process start test event emitted successfully\");\n    }\n    \n    let max_concurrent = config.max_concurrent_uploads;\n    let (tx, mut rx) = mpsc::channel::\u003cUploadProgress\u003e(100);\n    \n    loop {\n        // 処理停止チェック\n        {\n            let queue = queue_state.lock()\n                .map_err(|e| format!(\"Failed to lock queue: {}\", e))?;\n            if !queue.is_processing {\n                break;\n            }\n        }\n        \n        // 新しいアップロードを開始できるかチェック\n        let (should_wait, pending_items) = {\n            let mut queue = queue_state.lock()\n                .map_err(|e| format!(\"Failed to lock queue: {}\", e))?;\n            let current_active = queue.get_active_upload_count();\n            if current_active \u003e= max_concurrent {\n                (true, Vec::new())\n            } else {\n                let available_slots = max_concurrent.saturating_sub(current_active);\n                let mut pending = Vec::new();\n                let max_new_uploads = if max_concurrent == 1 {\n                    if current_active \u003e 0 { 0 } else { 1 }\n                } else {\n                    available_slots\n                };\n                let pending_item_ids: Vec\u003cString\u003e = queue.items.iter()\n                    .filter(|item| item.status == UploadStatus::Pending)\n                    .take(max_new_uploads)\n                    .map(|item| item.id.clone())\n                    .collect();\n                for item_id in pending_item_ids {\n                    match queue.start_upload(\u0026item_id) {\n                        Ok(()) =\u003e {\n                            if let Some(item) = queue.items.iter().find(|i| i.id == item_id) {\n                                pending.push(item.clone());\n                                if max_concurrent == 1 {\n                                    break;\n                                }\n                            }\n                        }\n                        Err(e) =\u003e {\n                            log::error!(\"Failed to start upload for {}: {}\", item_id, e);\n                            break;\n                        }\n                    }\n                }\n                (false, pending)\n            }\n        };\n        \n        if should_wait {\n            sleep(Duration::from_millis(1000)).await;\n            continue;\n        }\n        \n        // 新しいアップロードタスクを開始\n        for item in pending_items {\n            let queue_state_clone = queue_state.clone();\n            let config_clone = config.clone();\n            let tx_clone = tx.clone();\n            let item_id = item.id.clone();\n            let file_name = item.file_name.clone();\n            \n            tokio::spawn(async move {\n                log::info!(\"🔄 Starting upload task for: {} ({})\", file_name, item_id);\n                \n                // RealS3Clientを作成\n                let s3_client = match create_s3_client(\u0026config_clone.aws_credentials).await {\n                    Ok(client) =\u003e RealS3Client::new(client),\n                    Err(e) =\u003e {\n                        log::error!(\"Failed to create S3 client: {}\", e);\n                        let mut queue = queue_state_clone.lock().unwrap();\n                        queue.complete_upload(\u0026item_id, false, Some(format!(\"Failed to create S3 client: {}\", e)));\n                        return;\n                    }\n                };\n                \n                let result = upload_file_to_s3(\n                    item.file_path,\n                    item.s3_key,\n                    config_clone,\n                    tx_clone,\n                    item_id.clone(),\n                    \u0026s3_client,\n                ).await;\n                \n                let (success, error_msg) = match result {\n                    Ok(_) =\u003e (true, None),\n                    Err(e) =\u003e (false, Some(e)),\n                };\n                \n                // 新しい状態管理システムを使用してアップロード完了を記録\n                {\n                    let mut queue = queue_state_clone.lock().unwrap();\n                    // 既に完了済みかチェック（進捗更新で先に処理された場合）\n                    if let Some(item) = queue.items.iter().find(|i| i.id == item_id) {\n                        if item.status == UploadStatus::Completed {\n                            log::info!(\"✅ Upload already completed by progress update, skipping task cleanup: {}\", item_id);\n                        } else {\n                            log::info!(\"🔄 Task completion: calling complete_upload for {}\", item_id);\n                            queue.complete_upload(\u0026item_id, success, error_msg.clone());\n                        }\n                    } else {\n                        log::warn!(\"⚠️  Upload item not found during task completion: {}\", item_id);\n                    }\n                }\n                \n                if success {\n                    log::info!(\"Upload task completed successfully: {} ({})\", file_name, item_id);\n                } else {\n                    log::error!(\"Upload task failed: {} ({}), error: {}\", file_name, item_id, error_msg.unwrap_or_default());\n                }\n            });\n        }\n        \n        // 進捗更新を処理\n        let mut progress_received = 0;\n        while let Ok(progress) = rx.try_recv() {\n            progress_received += 1;\n            {\n                let mut queue = queue_state.lock()\n                    .map_err(|e| format!(\"Failed to lock queue: {}\", e))?;\n                queue.active_uploads.insert(progress.item_id.clone(), progress.clone());\n                \n                // キューアイテムの進捗も更新\n                let (should_cleanup, file_name, file_size, is_success) = {\n                    if let Some(item) = queue.items.iter_mut().find(|i| i.id == progress.item_id) {\n                        let was_in_progress = item.status == UploadStatus::InProgress;\n                        \n                        item.progress = progress.percentage;\n                        item.uploaded_bytes = progress.uploaded_bytes;\n                        item.speed_mbps = progress.speed_mbps;\n                        item.eta_seconds = progress.eta_seconds;\n                        item.status = progress.status.clone();\n                        \n                        // 完了時（成功・失敗問わず）の判定と必要な値の取得\n                        let is_completed = matches!(progress.status, UploadStatus::Completed | UploadStatus::Failed);\n                        if is_completed \u0026\u0026 was_in_progress {\n                            if progress.status == UploadStatus::Completed {\n                                item.completed_at = Some(chrono::Utc::now().to_rfc3339());\n                            }\n                            (true, item.file_name.clone(), item.file_size, progress.status == UploadStatus::Completed)\n                        } else {\n                            (false, String::new(), 0, false)\n                        }\n                    } else {\n                        (false, String::new(), 0, false)\n                    }\n                };\n                \n                // 借用が終了した後でクリーンアップ処理\n                if should_cleanup {\n                    if is_success {\n                        log::info!(\"🎉 Upload 100% completed, performing immediate cleanup: {}\", progress.item_id);\n                        queue.total_files_uploaded += 1;\n                        queue.total_uploaded_bytes += file_size;\n                    } else {\n                        log::info!(\"💥 Upload failed, performing immediate cleanup: {}\", progress.item_id);\n                    }\n                    \n                    // アクティブカウントを減らす\n                    let old_count = queue.active_upload_count;\n                    if queue.active_upload_count \u003e 0 {\n                        queue.active_upload_count -= 1;\n                        log::info!(\"🔽 Active upload count decreased: {} -\u003e {}\", \n                                   old_count, queue.active_upload_count);\n                    }\n                    \n                    // active_uploadsから削除\n                    let removed = queue.active_uploads.remove(\u0026progress.item_id);\n                    log::info!(\"🗑️  Removed from active_uploads: {} (was present: {})\", progress.item_id, removed.is_some());\n                    \n                    if is_success {\n                        log::info!(\"✅ Upload completed and cleaned up: {} ({})\", file_name, progress.item_id);\n                    } else {\n                        log::info!(\"❌ Upload failed and cleaned up: {} ({})\", file_name, progress.item_id);\n                    }\n                    log::info!(\"📊 Cleanup summary - Active count: {}, Active uploads: {}\", \n                               queue.active_upload_count, queue.active_uploads.len());\n                }\n            } // ロックをここで解放\n            \n            // フロントエンドに進捗を通知\n            log::info!(\"Emitting progress event to frontend: {:.1}% for {}\", \n                       progress.percentage, progress.item_id);\n            if let Err(e) = app_handle.emit(\"upload-progress\", \u0026progress) {\n                log::error!(\"Failed to emit upload progress: {}\", e);\n            } else {\n                log::info!(\"Progress event emitted successfully: {:.1}%\", progress.percentage);\n            }\n        }\n        \n        if progress_received \u003e 0 {\n            log::info!(\"Processed {} progress updates in this cycle\", progress_received);\n        }\n        \n        // アップロード停止検出とリカバリ\n        let (has_pending, has_active, all_completed) = {\n            let queue = queue_state.lock()\n                .map_err(|e| format!(\"Failed to lock queue: {}\", e))?;\n            let pending = queue.items.iter().any(|item| item.status == UploadStatus::Pending);\n            let active = queue.get_active_upload_count() \u003e 0;\n            let completed = queue.items.iter().all(|item| \n                matches!(item.status, UploadStatus::Completed | UploadStatus::Failed | UploadStatus::Cancelled)\n            );\n            (pending, active, completed)\n        };\n        \n        // 全てのファイルが完了した場合は処理を停止\n        if all_completed {\n            log::info!(\"🎉 All uploads completed! Stopping processing\");\n            break;\n        }\n        \n        // 待機時間を設定\n        if !has_pending \u0026\u0026 !has_active {\n            log::info!(\"No pending or active uploads, waiting...\");\n            sleep(Duration::from_millis(5000)).await;\n        } else {\n            sleep(Duration::from_millis(100)).await;\n        }\n    }\n    \n    log::info!(\"🚀 process_upload_queue completed\");\n    Ok(())\n}\n\n/// 単一ファイルのアップロード処理\nasync fn upload_file_to_s3(\n    file_path: String,\n    s3_key: String,\n    config: UploadConfig,\n    progress_tx: mpsc::Sender\u003cUploadProgress\u003e,\n    item_id: String,\n    s3_client: \u0026dyn S3ClientTrait,\n) -\u003e Result\u003cString, String\u003e {\n    use std::path::Path;\n    use tokio::fs::File;\n    use tokio::io::AsyncReadExt;\n    \n    log::info!(\"Starting upload for file: {} -\u003e s3://{}/{}\", file_path, config.bucket_name, s3_key);\n    \n    // 🔍 受信した設定の全詳細をデバッグ出力\n    log::info!(\"🔧 === アップロード設定詳細 ===\");\n    log::info!(\"🔧 tier: {:?}\", config.tier);\n    log::info!(\"🔧 chunk_size_mb: {}\", config.chunk_size_mb);\n    log::info!(\"🔧 max_concurrent_uploads: {}\", config.max_concurrent_uploads);\n    log::info!(\"🔧 max_concurrent_parts: {}\", config.max_concurrent_parts);\n    log::info!(\"🔧 adaptive_chunk_size: {}\", config.adaptive_chunk_size);\n    log::info!(\"🔧 min_chunk_size_mb: {}\", config.min_chunk_size_mb);\n    log::info!(\"🔧 max_chunk_size_mb: {}\", config.max_chunk_size_mb);\n    log::info!(\"🔧 retry_attempts: {}\", config.retry_attempts);\n    log::info!(\"🔧 timeout_seconds: {}\", config.timeout_seconds);\n    log::info!(\"🔧 enable_resume: {}\", config.enable_resume);\n    log::info!(\"🔧 ========================\");\n    \n    // ファイル存在確認\n    let path = Path::new(\u0026file_path);\n    if !path.exists() {\n        return Err(format!(\"File does not exist: {}\", file_path));\n    }\n    \n    let file_size = std::fs::metadata(\u0026path)\n        .map_err(|e| format!(\"Failed to get file metadata: {}\", e))?\n        .len();\n    \n    let start_time = Instant::now();\n    let mut uploaded_bytes = 0u64;\n    \n    // 進捗レポート用のクロージャ\n    let report_progress = |uploaded: u64, total: u64, speed_mbps: f64| {\n        let percentage = if total \u003e 0 {\n            (uploaded as f64 / total as f64) * 100.0\n        } else {\n            0.0\n        };\n        \n        let eta_seconds = if speed_mbps \u003e 0.0 {\n            let remaining_mb = (total - uploaded) as f64 / (1024.0 * 1024.0);\n            Some((remaining_mb / speed_mbps) as u64)\n        } else {\n            None\n        };\n        \n        let progress = UploadProgress {\n            item_id: item_id.clone(),\n            uploaded_bytes: uploaded,\n            total_bytes: total,\n            percentage,\n            speed_mbps,\n            eta_seconds,\n            status: if uploaded \u003e= total {\n                UploadStatus::Completed\n            } else {\n                UploadStatus::InProgress\n            },\n        };\n        \n        if let Err(e) = progress_tx.try_send(progress) {\n            log::warn!(\"Failed to send progress update: {}\", e);\n        }\n    };\n    \n    // S3制限準拠のチャンクサイズ設定（事前計算）\n    let configured_size = config.chunk_size_mb * 1024 * 1024;\n    let s3_min_size = 5 * 1024 * 1024; // 5MB\n    let effective_chunk_size = std::cmp::max(configured_size, s3_min_size);\n    \n    // 🔍 チャンクサイズ計算の詳細をデバッグ出力\n    log::info!(\"🔧 === チャンクサイズ計算 ===\");\n    log::info!(\"🔧 config.chunk_size_mb: {}\", config.chunk_size_mb);\n    log::info!(\"🔧 configured_size (bytes): {}\", configured_size);\n    log::info!(\"🔧 s3_min_size (bytes): {}\", s3_min_size);\n    log::info!(\"🔧 effective_chunk_size (bytes): {}\", effective_chunk_size);\n    log::info!(\"🔧 effective_chunk_size (MB): {}\", effective_chunk_size / (1024 * 1024));\n    log::info!(\"🔧 ========================\");\n    \n    if effective_chunk_size != configured_size {\n        log::warn!(\"⚠️ Chunk size adjusted for S3 compliance: {} MB -\u003e {} MB\", \n                  configured_size / (1024 * 1024), effective_chunk_size / (1024 * 1024));\n    }\n    \n    // 小さなファイルの場合は単純アップロード（調整後のチャンクサイズで判定）\n    if file_size \u003c= effective_chunk_size {\n        log::info!(\"Using simple upload for small file: {} bytes\", file_size);\n        \n        let mut file = File::open(\u0026path).await\n            .map_err(|e| format!(\"Failed to open file: {}\", e))?;\n        \n        let mut buffer = Vec::new();\n        file.read_to_end(\u0026mut buffer).await\n            .map_err(|e| format!(\"Failed to read file: {}\", e))?;\n        \n        uploaded_bytes = buffer.len() as u64;\n        \n        // 進捗レポート\n        let elapsed = start_time.elapsed().as_secs_f64();\n        let speed_mbps = if elapsed \u003e 0.0 {\n            (uploaded_bytes as f64 / (1024.0 * 1024.0)) / elapsed\n        } else {\n            0.0\n        };\n        \n        report_progress(uploaded_bytes, file_size, speed_mbps);\n        \n        s3_client\n            .put_object(\u0026config.bucket_name, \u0026s3_key, buffer)\n            .await?;\n        \n        log::info!(\"Simple upload completed: {} bytes\", uploaded_bytes);\n        \n    } else {\n        // マルチパートアップロード\n        log::info!(\"Using multipart upload for large file: {} bytes\", file_size);\n        \n        let upload_id = s3_client\n            .create_multipart_upload(\u0026config.bucket_name, \u0026s3_key)\n            .await?;\n        \n        // 事前計算されたチャンクサイズを使用\n        let chunk_size = effective_chunk_size;\n        let mut part_number = 1;\n        let mut completed_parts = Vec::new();\n        \n        let mut file = File::open(\u0026path).await\n            .map_err(|e| format!(\"Failed to open file: {}\", e))?;\n        \n        loop {\n            let mut buffer = vec![0u8; chunk_size as usize];\n            \n            // 🔍 バッファサイズをデバッグ出力\n            log::info!(\"🔧 Reading chunk: buffer_size={} bytes ({} MB)\", \n                       buffer.len(), buffer.len() / (1024 * 1024));\n            \n            // 完全にチャンクサイズを読み込むまでループ\n            let mut total_bytes_read = 0;\n            let mut temp_buffer = vec![0u8; chunk_size as usize];\n            \n            while total_bytes_read \u003c chunk_size as usize {\n                let bytes_read = file.read(\u0026mut temp_buffer[total_bytes_read..]).await\n                    .map_err(|e| format!(\"Failed to read file chunk: {}\", e))?;\n                \n                if bytes_read == 0 {\n                    // ファイル終端に達した\n                    break;\n                }\n                \n                total_bytes_read += bytes_read;\n            }\n            \n            // 🔍 実際の読み込みサイズをデバッグ出力\n            log::info!(\"🔧 Read result: total_bytes_read={} bytes ({} MB)\", \n                       total_bytes_read, total_bytes_read / (1024 * 1024));\n            \n            if total_bytes_read == 0 {\n                break;\n            }\n            \n            // 実際に読み込んだサイズでバッファを調整\n            temp_buffer.truncate(total_bytes_read);\n            buffer = temp_buffer;\n            \n            let etag = s3_client\n                .upload_part(\u0026config.bucket_name, \u0026s3_key, \u0026upload_id, part_number, buffer)\n                .await?;\n            \n            completed_parts.push((part_number, etag));\n            \n            uploaded_bytes += total_bytes_read as u64;\n            part_number += 1;\n            \n            // 進捗レポート\n            let elapsed = start_time.elapsed().as_secs_f64();\n            let speed_mbps = if elapsed \u003e 0.0 {\n                (uploaded_bytes as f64 / (1024.0 * 1024.0)) / elapsed\n            } else {\n                0.0\n            };\n            \n            report_progress(uploaded_bytes, file_size, speed_mbps);\n            \n            log::info!(\"Uploaded part {}: {} bytes (total: {}/{})\", \n                       part_number - 1, total_bytes_read, uploaded_bytes, file_size);\n        }\n        \n        // マルチパートアップロード完了（エラーハンドリング強化）\n        log::info!(\"🔧 Completing multipart upload with {} parts\", completed_parts.len());\n        \n        // パーツを部品番号順にソート（重要）\n        let mut sorted_parts = completed_parts;\n        sorted_parts.sort_by_key(|(part_number, _)| *part_number);\n        \n        // デバッグ情報（詳細）\n        log::info!(\"🔧 Preparing to complete multipart upload with {} parts:\", sorted_parts.len());\n        for (i, (part_number, etag)) in sorted_parts.iter().enumerate() {\n            log::info!(\"  Part {}: number={}, etag={}\", i + 1, part_number, etag);\n        }\n        \n        let parts_count = sorted_parts.len();\n        \n        // リトライ付きマルチパート完了\n        let mut retry_count = 0;\n        let max_retries = 3;\n        \n        loop {\n            match s3_client\n                .complete_multipart_upload(\u0026config.bucket_name, \u0026s3_key, \u0026upload_id, sorted_parts.clone())\n                .await\n            {\n                Ok(_) =\u003e {\n                    log::info!(\"✅ Multipart upload completed successfully\");\n                    break;\n                }\n                Err(e) =\u003e {\n                    retry_count += 1;\n                    \n                    // 詳細なエラー情報をログ出力\n                    log::error!(\"🔍 Multipart upload completion error details:\");\n                    log::error!(\"  ├─ Error: {:?}\", e);\n                    log::error!(\"  ├─ Bucket: {}\", config.bucket_name);\n                    log::error!(\"  ├─ Key: {}\", s3_key);\n                    log::error!(\"  ├─ Upload ID: {}\", upload_id);\n                    log::error!(\"  ├─ Parts count: {}\", parts_count);\n                    log::error!(\"  └─ Attempt: {}/{}\", retry_count, max_retries);\n                    \n                    if retry_count \u003e max_retries {\n                        log::error!(\"❌ Multipart upload completion failed after {} retries: {}\", max_retries, e);\n                        return Err(format!(\"Failed to complete multipart upload after {} retries: {}\", max_retries, e));\n                    }\n                    \n                    let delay = Duration::from_millis(1000 * retry_count as u64);\n                    log::warn!(\"⚠️ Multipart upload completion failed (attempt {}), retrying in {:?}: {}\", \n                              retry_count, delay, e);\n                    tokio::time::sleep(delay).await;\n                }\n            }\n        }\n        \n        log::info!(\"Multipart upload completed: {} bytes in {} parts\", uploaded_bytes, part_number - 1);\n    }\n    \n    // 最終進捗レポート\n    let elapsed = start_time.elapsed().as_secs_f64();\n    let speed_mbps = if elapsed \u003e 0.0 {\n        (uploaded_bytes as f64 / (1024.0 * 1024.0)) / elapsed\n    } else {\n        0.0\n    };\n    \n    report_progress(uploaded_bytes, file_size, speed_mbps);\n    \n    // メタデータ作成（設定されている場合）\n    if config.auto_create_metadata {\n        use std::collections::HashMap;\n        let tags = vec![\"upload\".to_string()];\n        let custom_fields = HashMap::new();\n        if let Err(e) = create_file_metadata(file_path.clone(), tags, custom_fields).await {\n            log::warn!(\"Failed to create metadata for {}: {}\", s3_key, e);\n        }\n    }\n    \n    Ok(format!(\"Upload completed: {} bytes\", uploaded_bytes))\n}\n\n/// アップロードキューをクリア\n#[command]\npub async fn clear_upload_queue(\n    queue_state: State\u003c'_, UploadQueueState\u003e,\n) -\u003e Result\u003cString, String\u003e {\n    let mut queue = queue_state.lock()\n        .map_err(|e| format!(\"Failed to lock upload queue: {}\", e))?;\n    \n    // アクティブなアップロードがある場合は停止\n    if !queue.active_uploads.is_empty() {\n        queue.is_processing = false;\n    }\n    \n    queue.items.clear();\n    queue.active_uploads.clear();\n    \n    log::info!(\"Upload queue cleared\");\n    Ok(\"Upload queue cleared\".to_string())\n}\n\n/// アップロード設定をテスト\n#[command]\npub async fn test_upload_config(config: UploadConfig) -\u003e Result\u003cString, String\u003e {\n    use aws_config::{BehaviorVersion, Region};\n    use aws_sdk_s3::Client as S3Client;\n    use aws_credential_types::Credentials;\n    \n    // AWS認証テスト\n    let region = Region::new(config.aws_credentials.region.clone());\n    let mut config_builder = aws_config::defaults(BehaviorVersion::latest())\n        .region(region);\n    \n    let creds = Credentials::new(\n        \u0026config.aws_credentials.access_key_id,\n        \u0026config.aws_credentials.secret_access_key,\n        config.aws_credentials.session_token.clone(),\n        None,\n        \"test\",\n    );\n    \n    config_builder = config_builder.credentials_provider(creds);\n    let aws_config = config_builder.load().await;\n    let s3_client = S3Client::new(\u0026aws_config);\n    \n    // バケットアクセステスト\n    s3_client\n        .head_bucket()\n        .bucket(\u0026config.bucket_name)\n        .send()\n        .await\n        .map_err(|e| format!(\"Bucket access test failed: {}\", e))?;\n    \n    Ok(format!(\"Upload configuration test successful for bucket: {}\", config.bucket_name))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::collections::HashMap;\n    use tempfile::tempdir;\n    use std::fs::File;\n    use std::io::Write;\n\n    #[cfg(test)]\n    fn create_test_credentials() -\u003e AwsCredentials {\n        AwsCredentials {\n            access_key_id: \"test_access_key\".to_string(),\n            secret_access_key: \"test_secret_key\".to_string(),\n            region: \"ap-northeast-1\".to_string(),\n            session_token: None,\n        }\n    }\n\n    #[cfg(test)]\n    fn create_test_upload_config() -\u003e UploadConfig {\n        UploadConfig {\n            aws_credentials: create_test_credentials(),\n            bucket_name: \"test-bucket\".to_string(),\n            max_concurrent_uploads: 8,\n            chunk_size_mb: 10,\n            retry_attempts: 10,\n            timeout_seconds: 1800,\n            auto_create_metadata: true,\n            s3_key_prefix: Some(\"uploads\".to_string()),\n            max_concurrent_parts: 8,\n            adaptive_chunk_size: true,\n            min_chunk_size_mb: 5,\n            max_chunk_size_mb: 100,\n            bandwidth_limit_mbps: None,\n            enable_resume: true,\n            tier: UploadTier::Premium,\n        }\n    }\n\n    #[cfg(test)]\n    fn create_test_s3_key_config() -\u003e S3KeyConfig {\n        S3KeyConfig {\n            prefix: Some(\"test\".to_string()),\n            use_date_folder: true,\n            preserve_directory_structure: false,\n            custom_naming_pattern: None,\n        }\n    }\n\n    #[test]\n    fn test_upload_queue_creation() {\n        let queue = UploadQueue::new();\n        assert_eq!(queue.items.len(), 0);\n        assert_eq!(queue.active_uploads.len(), 0);\n        assert!(!queue.is_processing);\n        assert_eq!(queue.total_uploaded_bytes, 0);\n        assert_eq!(queue.total_files_uploaded, 0);\n    }\n\n    #[test]\n    fn test_s3_key_generation_simple() {\n        let config = S3KeyConfig {\n            prefix: Some(\"uploads\".to_string()),\n            use_date_folder: false,\n            preserve_directory_structure: false,\n            custom_naming_pattern: None,\n        };\n\n        let result = generate_s3_key(\"/path/to/test.mp4\", \u0026config).unwrap();\n        assert_eq!(result, \"uploads/test.mp4\");\n    }\n\n    #[test]\n    fn test_s3_key_generation_with_date() {\n        let config = S3KeyConfig {\n            prefix: Some(\"media\".to_string()),\n            use_date_folder: true,\n            preserve_directory_structure: false,\n            custom_naming_pattern: None,\n        };\n\n        let result = generate_s3_key(\"/path/to/video.mov\", \u0026config).unwrap();\n        assert!(result.starts_with(\"media/\"));\n        assert!(result.contains(\"/video.mov\"));\n        // 日付フォルダが含まれているかチェック（YYYY/MM/DD形式）\n        let parts: Vec\u003c\u0026str\u003e = result.split('/').collect();\n        assert!(parts.len() \u003e= 4); // media/YYYY/MM/DD/video.mov\n    }\n\n    #[test]\n    fn test_s3_key_generation_custom_pattern() {\n        let config = S3KeyConfig {\n            prefix: None,\n            use_date_folder: false,\n            preserve_directory_structure: false,\n            custom_naming_pattern: Some(\"{timestamp}_{filename}\".to_string()),\n        };\n\n        let result = generate_s3_key(\"/path/to/test.mp4\", \u0026config).unwrap();\n        assert!(result.contains(\"_test.mp4\"));\n        assert!(result.len() \u003e \"test.mp4\".len()); // タイムスタンプが追加されている\n    }\n\n    #[tokio::test]\n    async fn test_upload_queue_initialization() {\n        let queue = Arc::new(Mutex::new(UploadQueue::new()));\n        let config = create_test_upload_config();\n\n        // 初期化テスト（実際のAWS接続は行わない）\n        {\n            let mut q = queue.lock().unwrap();\n            q.config = Some(config.clone());\n        }\n\n        let q = queue.lock().unwrap();\n        assert!(q.config.is_some());\n        assert_eq!(q.config.as_ref().unwrap().bucket_name, \"test-bucket\");\n    }\n\n    #[tokio::test]\n    async fn test_file_addition_to_queue() {\n        let temp_dir = tempdir().unwrap();\n        let file_path = temp_dir.path().join(\"test_video.mp4\");\n        \n        // テスト用ファイルを作成\n        {\n            let mut file = File::create(\u0026file_path).unwrap();\n            file.write_all(b\"test video content\").unwrap();\n        }\n\n        let queue = Arc::new(Mutex::new(UploadQueue::new()));\n        let s3_key_config = create_test_s3_key_config();\n\n        // ファイルをキューに追加（モック）\n        let file_path_str = file_path.to_string_lossy().to_string();\n        let s3_key = generate_s3_key(\u0026file_path_str, \u0026s3_key_config).unwrap();\n\n        let item = UploadItem {\n            id: Uuid::new_v4().to_string(),\n            file_path: file_path_str.clone(),\n            file_name: \"test_video.mp4\".to_string(),\n            file_size: 18, // \"test video content\".len()\n            s3_key,\n            status: UploadStatus::Pending,\n            progress: 0.0,\n            uploaded_bytes: 0,\n            speed_mbps: 0.0,\n            eta_seconds: None,\n            created_at: chrono::Utc::now().to_rfc3339(),\n            started_at: None,\n            completed_at: None,\n            error_message: None,\n            retry_count: 0,\n        };\n\n        {\n            let mut q = queue.lock().unwrap();\n            q.items.push(item);\n        }\n\n        let q = queue.lock().unwrap();\n        assert_eq!(q.items.len(), 1);\n        assert_eq!(q.items[0].file_name, \"test_video.mp4\");\n        assert_eq!(q.items[0].status, UploadStatus::Pending);\n        assert!(q.items[0].s3_key.contains(\"test_video.mp4\"));\n    }\n\n    #[test]\n    fn test_upload_statistics_calculation() {\n        let mut queue = UploadQueue::new();\n\n        // テストアイテムを追加\n        for i in 0..5 {\n            let item = UploadItem {\n                id: format!(\"item_{}\", i),\n                file_path: format!(\"/test/file_{}.mp4\", i),\n                file_name: format!(\"file_{}.mp4\", i),\n                file_size: 1000,\n                s3_key: format!(\"uploads/file_{}.mp4\", i),\n                status: if i \u003c 2 { UploadStatus::Completed } else if i \u003c 4 { UploadStatus::Pending } else { UploadStatus::Failed },\n                progress: if i \u003c 2 { 100.0 } else { 0.0 },\n                uploaded_bytes: if i \u003c 2 { 1000 } else { 0 },\n                speed_mbps: 0.0,\n                eta_seconds: None,\n                created_at: chrono::Utc::now().to_rfc3339(),\n                started_at: None,\n                completed_at: None,\n                error_message: None,\n                retry_count: 0,\n            };\n            queue.items.push(item);\n        }\n\n        let total_files = queue.items.len() as u64;\n        let completed_files = queue.items.iter()\n            .filter(|item| item.status == UploadStatus::Completed)\n            .count() as u64;\n        let failed_files = queue.items.iter()\n            .filter(|item| item.status == UploadStatus::Failed)\n            .count() as u64;\n        let pending_files = queue.items.iter()\n            .filter(|item| item.status == UploadStatus::Pending)\n            .count() as u64;\n\n        assert_eq!(total_files, 5);\n        assert_eq!(completed_files, 2);\n        assert_eq!(failed_files, 1);\n        assert_eq!(pending_files, 2);\n    }\n\n    #[test]\n    fn test_upload_item_status_transitions() {\n        let mut item = UploadItem {\n            id: \"test_item\".to_string(),\n            file_path: \"/test/file.mp4\".to_string(),\n            file_name: \"file.mp4\".to_string(),\n            file_size: 1000,\n            s3_key: \"uploads/file.mp4\".to_string(),\n            status: UploadStatus::Pending,\n            progress: 0.0,\n            uploaded_bytes: 0,\n            speed_mbps: 0.0,\n            eta_seconds: None,\n            created_at: chrono::Utc::now().to_rfc3339(),\n            started_at: None,\n            completed_at: None,\n            error_message: None,\n            retry_count: 0,\n        };\n\n        // Pending -\u003e InProgress\n        item.status = UploadStatus::InProgress;\n        item.started_at = Some(chrono::Utc::now().to_rfc3339());\n        assert_eq!(item.status, UploadStatus::InProgress);\n        assert!(item.started_at.is_some());\n\n        // InProgress -\u003e Completed\n        item.status = UploadStatus::Completed;\n        item.progress = 100.0;\n        item.uploaded_bytes = 1000;\n        item.completed_at = Some(chrono::Utc::now().to_rfc3339());\n        assert_eq!(item.status, UploadStatus::Completed);\n        assert_eq!(item.progress, 100.0);\n        assert_eq!(item.uploaded_bytes, 1000);\n        assert!(item.completed_at.is_some());\n    }\n\n    #[test]\n    fn test_upload_progress_calculation() {\n        let uploaded_bytes = 500u64;\n        let total_bytes = 1000u64;\n        let percentage = (uploaded_bytes as f64 / total_bytes as f64) * 100.0;\n\n        assert_eq!(percentage, 50.0);\n\n        // 速度計算のテスト\n        let elapsed_seconds = 10.0;\n        let speed_mbps = (uploaded_bytes as f64 / (1024.0 * 1024.0)) / elapsed_seconds;\n        assert!(speed_mbps \u003e 0.0);\n\n        // ETA計算のテスト\n        if speed_mbps \u003e 0.0 {\n            let remaining_mb = (total_bytes - uploaded_bytes) as f64 / (1024.0 * 1024.0);\n            let eta_seconds = (remaining_mb / speed_mbps) as u64;\n            assert!(eta_seconds \u003e 0);\n        }\n    }\n\n    #[test]\n    fn test_upload_config_validation() {\n        let config = create_test_upload_config();\n        \n        assert!(!config.aws_credentials.access_key_id.is_empty());\n        assert!(!config.aws_credentials.secret_access_key.is_empty());\n        assert!(!config.aws_credentials.region.is_empty());\n        assert!(!config.bucket_name.is_empty());\n        assert!(config.max_concurrent_uploads \u003e 0);\n        assert!(config.chunk_size_mb \u003e 0);\n        assert!(config.retry_attempts \u003e 0);\n        assert!(config.timeout_seconds \u003e 0);\n    }\n\n    #[test]\n    fn test_s3_key_config_presets() {\n        let config = S3KeyConfig {\n            prefix: Some(\"backup/\".to_string()),\n            use_date_folder: true,\n            preserve_directory_structure: false,\n            custom_naming_pattern: None,\n        };\n        \n        assert_eq!(config.prefix, Some(\"backup/\".to_string()));\n        assert!(config.use_date_folder);\n        assert!(!config.preserve_directory_structure);\n        assert!(config.custom_naming_pattern.is_none());\n    }\n    \n    #[tokio::test]\n    async fn test_upload_file_to_s3_with_mock_simple_upload() {\n        let credentials = create_test_credentials();\n        let config = create_test_upload_config();\n        let (tx, _rx) = mpsc::channel::\u003cUploadProgress\u003e(10);\n        let item_id = \"test-item-1\".to_string();\n        \n        // テスト用の一時ファイルを作成\n        let temp_dir = tempfile::tempdir().unwrap();\n        let test_file_path = temp_dir.path().join(\"test_file.txt\");\n        std::fs::write(\u0026test_file_path, \"Hello, World!\").unwrap();\n        \n        let s3_key = \"test/upload/test_file.txt\".to_string();\n        \n        // MockS3Clientを使用\n        let mock_client = MockS3Client;\n        \n        let result = upload_file_to_s3(\n            test_file_path.to_string_lossy().to_string(),\n            s3_key,\n            config,\n            tx,\n            item_id,\n            \u0026mock_client,\n        ).await;\n        \n        assert!(result.is_ok());\n        let result_str = result.unwrap();\n        assert!(result_str.contains(\"Upload completed\"));\n    }\n    \n    #[tokio::test]\n    async fn test_upload_file_to_s3_with_mock_multipart_upload() {\n        let credentials = create_test_credentials();\n        let mut config = create_test_upload_config();\n        // チャンクサイズを小さくしてマルチパートアップロードを強制\n        config.chunk_size_mb = 1; // 1MB\n        let (tx, _rx) = mpsc::channel::\u003cUploadProgress\u003e(10);\n        let item_id = \"test-item-2\".to_string();\n        \n        // テスト用の大きな一時ファイルを作成（5MB以上）\n        let temp_dir = tempfile::tempdir().unwrap();\n        let test_file_path = temp_dir.path().join(\"large_test_file.bin\");\n        let large_data = vec![0u8; 6 * 1024 * 1024]; // 6MB\n        std::fs::write(\u0026test_file_path, large_data).unwrap();\n        \n        let s3_key = \"test/upload/large_test_file.bin\".to_string();\n        \n        // MockS3Clientを使用\n        let mock_client = MockS3Client;\n        \n        let result = upload_file_to_s3(\n            test_file_path.to_string_lossy().to_string(),\n            s3_key,\n            config,\n            tx,\n            item_id,\n            \u0026mock_client,\n        ).await;\n        \n        assert!(result.is_ok());\n        let result_str = result.unwrap();\n        assert!(result_str.contains(\"Upload completed\"));\n    }\n    \n    #[tokio::test]\n    async fn test_upload_file_to_s3_file_not_found() {\n        let credentials = create_test_credentials();\n        let config = create_test_upload_config();\n        let (tx, _rx) = mpsc::channel::\u003cUploadProgress\u003e(10);\n        let item_id = \"test-item-3\".to_string();\n        \n        let non_existent_file = \"/path/to/non/existent/file.txt\".to_string();\n        let s3_key = \"test/upload/non_existent.txt\".to_string();\n        \n        // MockS3Clientを使用\n        let mock_client = MockS3Client;\n        \n        let result = upload_file_to_s3(\n            non_existent_file,\n            s3_key,\n            config,\n            tx,\n            item_id,\n            \u0026mock_client,\n        ).await;\n        \n        assert!(result.is_err());\n        let error_msg = result.unwrap_err();\n        assert!(error_msg.contains(\"File does not exist\"));\n    }\n}","traces":[{"line":109,"address":[],"length":0,"stats":{"Line":4}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":112,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":4}},{"line":565,"address":[],"length":0,"stats":{"Line":4}},{"line":566,"address":[],"length":0,"stats":{"Line":8}},{"line":567,"address":[],"length":0,"stats":{"Line":12}},{"line":568,"address":[],"length":0,"stats":{"Line":8}},{"line":573,"address":[],"length":0,"stats":{"Line":3}},{"line":575,"address":[],"length":0,"stats":{"Line":3}},{"line":576,"address":[],"length":0,"stats":{"Line":3}},{"line":581,"address":[],"length":0,"stats":{"Line":2}},{"line":582,"address":[],"length":0,"stats":{"Line":2}},{"line":583,"address":[],"length":0,"stats":{"Line":2}},{"line":584,"address":[],"length":0,"stats":{"Line":2}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":1}},{"line":608,"address":[],"length":0,"stats":{"Line":3}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":761,"address":[],"length":0,"stats":{"Line":0}},{"line":762,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":3}},{"line":872,"address":[],"length":0,"stats":{"Line":3}},{"line":875,"address":[],"length":0,"stats":{"Line":3}},{"line":876,"address":[],"length":0,"stats":{"Line":3}},{"line":877,"address":[],"length":0,"stats":{"Line":3}},{"line":878,"address":[],"length":0,"stats":{"Line":3}},{"line":879,"address":[],"length":0,"stats":{"Line":3}},{"line":880,"address":[],"length":0,"stats":{"Line":3}},{"line":881,"address":[],"length":0,"stats":{"Line":3}},{"line":882,"address":[],"length":0,"stats":{"Line":3}},{"line":883,"address":[],"length":0,"stats":{"Line":3}},{"line":884,"address":[],"length":0,"stats":{"Line":3}},{"line":885,"address":[],"length":0,"stats":{"Line":3}},{"line":886,"address":[],"length":0,"stats":{"Line":3}},{"line":889,"address":[],"length":0,"stats":{"Line":3}},{"line":890,"address":[],"length":0,"stats":{"Line":3}},{"line":891,"address":[],"length":0,"stats":{"Line":1}},{"line":894,"address":[],"length":0,"stats":{"Line":4}},{"line":895,"address":[],"length":0,"stats":{"Line":4}},{"line":902,"address":[],"length":0,"stats":{"Line":5}},{"line":903,"address":[],"length":0,"stats":{"Line":10}},{"line":904,"address":[],"length":0,"stats":{"Line":5}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":10}},{"line":910,"address":[],"length":0,"stats":{"Line":5}},{"line":911,"address":[],"length":0,"stats":{"Line":5}},{"line":913,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":5}},{"line":923,"address":[],"length":0,"stats":{"Line":5}},{"line":930,"address":[],"length":0,"stats":{"Line":5}},{"line":931,"address":[],"length":0,"stats":{"Line":0}},{"line":941,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":1}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":1}},{"line":958,"address":[],"length":0,"stats":{"Line":2}},{"line":959,"address":[],"length":0,"stats":{"Line":2}},{"line":963,"address":[],"length":0,"stats":{"Line":2}},{"line":965,"address":[],"length":0,"stats":{"Line":1}},{"line":968,"address":[],"length":0,"stats":{"Line":1}},{"line":970,"address":[],"length":0,"stats":{"Line":1}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":1}},{"line":985,"address":[],"length":0,"stats":{"Line":1}},{"line":987,"address":[],"length":0,"stats":{"Line":1}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":1}},{"line":997,"address":[],"length":0,"stats":{"Line":2}},{"line":1000,"address":[],"length":0,"stats":{"Line":3}},{"line":1003,"address":[],"length":0,"stats":{"Line":3}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1007,"address":[],"length":0,"stats":{"Line":3}},{"line":1008,"address":[],"length":0,"stats":{"Line":3}},{"line":1010,"address":[],"length":0,"stats":{"Line":7}},{"line":1011,"address":[],"length":0,"stats":{"Line":12}},{"line":1012,"address":[],"length":0,"stats":{"Line":12}},{"line":1016,"address":[],"length":0,"stats":{"Line":2}},{"line":1019,"address":[],"length":0,"stats":{"Line":4}},{"line":1023,"address":[],"length":0,"stats":{"Line":3}},{"line":1024,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":1}},{"line":1031,"address":[],"length":0,"stats":{"Line":2}},{"line":1032,"address":[],"length":0,"stats":{"Line":2}},{"line":1034,"address":[],"length":0,"stats":{"Line":2}},{"line":1036,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":2}},{"line":1048,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":1}},{"line":1061,"address":[],"length":0,"stats":{"Line":1}},{"line":1062,"address":[],"length":0,"stats":{"Line":4}},{"line":1065,"address":[],"length":0,"stats":{"Line":1}},{"line":1066,"address":[],"length":0,"stats":{"Line":3}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":1}},{"line":1073,"address":[],"length":0,"stats":{"Line":1}},{"line":1074,"address":[],"length":0,"stats":{"Line":1}},{"line":1077,"address":[],"length":0,"stats":{"Line":1}},{"line":1078,"address":[],"length":0,"stats":{"Line":1}},{"line":1079,"address":[],"length":0,"stats":{"Line":1}},{"line":1082,"address":[],"length":0,"stats":{"Line":1}},{"line":1085,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1089,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1092,"address":[],"length":0,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1098,"address":[],"length":0,"stats":{"Line":0}},{"line":1099,"address":[],"length":0,"stats":{"Line":0}},{"line":1102,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1114,"address":[],"length":0,"stats":{"Line":2}},{"line":1116,"address":[],"length":0,"stats":{"Line":2}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":2}},{"line":1127,"address":[],"length":0,"stats":{"Line":2}},{"line":1128,"address":[],"length":0,"stats":{"Line":2}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":2}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1141,"address":[],"length":0,"stats":{"Line":0}},{"line":1142,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1146,"address":[],"length":0,"stats":{"Line":0}},{"line":1149,"address":[],"length":0,"stats":{"Line":0}},{"line":1150,"address":[],"length":0,"stats":{"Line":0}},{"line":1152,"address":[],"length":0,"stats":{"Line":0}},{"line":1153,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1166,"address":[],"length":0,"stats":{"Line":0}},{"line":1169,"address":[],"length":0,"stats":{"Line":0}},{"line":1170,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1181,"address":[],"length":0,"stats":{"Line":0}},{"line":1183,"address":[],"length":0,"stats":{"Line":0}},{"line":1185,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1188,"address":[],"length":0,"stats":{"Line":0}}],"covered":91,"coverable":504},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","internal","error.rs"],"content":"use thiserror::Error;\n\n/// 内部ロジックで使用するエラー型\n/// Tauriコマンドの境界ではStringに変換される\n#[derive(Error, Debug)]\npub enum InternalError {\n    /// AWS S3関連のエラー\n    #[error(\"AWS S3 error: {0}\")]\n    S3(String),\n\n    /// AWS STS関連のエラー\n    #[error(\"AWS STS error: {0}\")]\n    Sts(#[from] aws_sdk_sts::Error),\n\n    /// AWS設定関連のエラー\n    #[error(\"AWS configuration error: {0}\")]\n    AwsConfig(String),\n\n    /// 設定ファイル関連のエラー\n    #[error(\"Configuration error: {0}\")]\n    Config(String),\n\n    /// ファイル操作関連のエラー\n    #[error(\"File operation error: {0}\")]\n    File(String),\n\n    /// データベース関連のエラー\n    #[error(\"Database error: {0}\")]\n    Database(String),\n\n    /// 認証関連のエラー\n    #[error(\"Authentication error: {0}\")]\n    Auth(String),\n\n    /// 暗号化関連のエラー\n    #[error(\"Encryption error: {0}\")]\n    Encryption(String),\n\n    /// メタデータ関連のエラー\n    #[error(\"Metadata error: {0}\")]\n    Metadata(String),\n\n    /// その他のエラー\n    #[error(\"Unexpected error: {0}\")]\n    Other(String),\n}\n\nimpl From\u003cstd::io::Error\u003e for InternalError {\n    fn from(err: std::io::Error) -\u003e Self {\n        InternalError::File(err.to_string())\n    }\n}\n\nimpl From\u003cserde_json::Error\u003e for InternalError {\n    fn from(err: serde_json::Error) -\u003e Self {\n        InternalError::Config(err.to_string())\n    }\n}\n\nimpl From\u003crusqlite::Error\u003e for InternalError {\n    fn from(err: rusqlite::Error) -\u003e Self {\n        InternalError::Database(err.to_string())\n    }\n}\n\nimpl From\u003ckeyring::Error\u003e for InternalError {\n    fn from(err: keyring::Error) -\u003e Self {\n        InternalError::Auth(err.to_string())\n    }\n}\n\nimpl From\u003cring::error::Unspecified\u003e for InternalError {\n    fn from(_err: ring::error::Unspecified) -\u003e Self {\n        InternalError::Encryption(\"Cryptographic operation failed\".to_string())\n    }\n}\n\nimpl From\u003cbase64::DecodeError\u003e for InternalError {\n    fn from(err: base64::DecodeError) -\u003e Self {\n        InternalError::Encryption(format!(\"Base64 decode error: {}\", err))\n    }\n}\n\nimpl From\u003cuuid::Error\u003e for InternalError {\n    fn from(err: uuid::Error) -\u003e Self {\n        InternalError::Other(format!(\"UUID error: {}\", err))\n    }\n}\n\nimpl From\u003cchrono::ParseError\u003e for InternalError {\n    fn from(err: chrono::ParseError) -\u003e Self {\n        InternalError::Metadata(format!(\"Date/time parse error: {}\", err))\n    }\n}\n\nimpl From\u003cnotify::Error\u003e for InternalError {\n    fn from(err: notify::Error) -\u003e Self {\n        InternalError::File(format!(\"File system watch error: {}\", err))\n    }\n}\n\nimpl From\u003cregex::Error\u003e for InternalError {\n    fn from(err: regex::Error) -\u003e Self {\n        InternalError::Other(format!(\"Regex error: {}\", err))\n    }\n}\n\n/// エラーメッセージの標準化\npub fn standardize_error(e: InternalError) -\u003e String {\n    match e {\n        InternalError::S3(e) =\u003e format!(\"AWS S3 error: {}\", e),\n        InternalError::Sts(e) =\u003e format!(\"AWS STS error: {}\", e),\n        InternalError::AwsConfig(msg) =\u003e format!(\"AWS configuration error: {}\", msg),\n        InternalError::Config(msg) =\u003e format!(\"Configuration error: {}\", msg),\n        InternalError::File(msg) =\u003e format!(\"File operation error: {}\", msg),\n        InternalError::Database(msg) =\u003e format!(\"Database error: {}\", msg),\n        InternalError::Auth(msg) =\u003e format!(\"Authentication error: {}\", msg),\n        InternalError::Encryption(msg) =\u003e format!(\"Encryption error: {}\", msg),\n        InternalError::Metadata(msg) =\u003e format!(\"Metadata error: {}\", msg),\n        InternalError::Other(msg) =\u003e format!(\"Unexpected error: {}\", msg),\n    }\n}\n\n/// エラーコードの取得\npub fn get_error_code(e: \u0026InternalError) -\u003e \u0026'static str {\n    match e {\n        InternalError::S3(_) =\u003e \"AWS_S3_ERROR\",\n        InternalError::Sts(_) =\u003e \"AWS_STS_ERROR\",\n        InternalError::AwsConfig(_) =\u003e \"AWS_CONFIG_ERROR\",\n        InternalError::Config(_) =\u003e \"CONFIG_ERROR\",\n        InternalError::File(_) =\u003e \"FILE_ERROR\",\n        InternalError::Database(_) =\u003e \"DATABASE_ERROR\",\n        InternalError::Auth(_) =\u003e \"AUTH_ERROR\",\n        InternalError::Encryption(_) =\u003e \"ENCRYPTION_ERROR\",\n        InternalError::Metadata(_) =\u003e \"METADATA_ERROR\",\n        InternalError::Other(_) =\u003e \"UNKNOWN_ERROR\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_error_conversion() {\n        let internal_error = InternalError::Config(\"test configuration error\".to_string());\n        let result = standardize_error(internal_error);\n        assert!(result.contains(\"Configuration error\"));\n        assert!(result.contains(\"test configuration error\"));\n    }\n\n    #[test]\n    fn test_error_code() {\n        let internal_error = InternalError::File(\"test file error\".to_string());\n        let code = get_error_code(\u0026internal_error);\n        assert_eq!(code, \"FILE_ERROR\");\n    }\n\n    #[test]\n    fn test_from_io_error() {\n        let io_error = std::io::Error::new(std::io::ErrorKind::NotFound, \"file not found\");\n        let internal_error: InternalError = io_error.into();\n        match internal_error {\n            InternalError::File(msg) =\u003e assert!(msg.contains(\"file not found\")),\n            _ =\u003e panic!(\"Expected File error\"),\n        }\n    }\n} ","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":12}},{"line":110,"address":[],"length":0,"stats":{"Line":12}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":6}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":44},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","internal","mod.rs"],"content":"pub mod error;\n\npub use error::{InternalError, standardize_error}; ","traces":[],"covered":0,"coverable":0},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","lib.rs"],"content":"// Learn more about Tauri commands at https://tauri.app/v1/guides/features/command\nuse std::sync::{Arc, Mutex};\nuse tauri::{\n    menu::{Menu, MenuItem, PredefinedMenuItem},\n    tray::{MouseButton, MouseButtonState, TrayIconBuilder, TrayIconEvent},\n    Manager, Emitter,\n};\n\n// モジュール定義\nmod commands {\n    pub mod file_operations;\n    pub mod aws_operations; \n    pub mod config;\n    pub mod state_management;\n    pub mod aws_auth;\n    pub mod metadata;\n    pub mod upload_system;\n    pub mod lifecycle;\n}\n\nmod logger;\nmod internal;\n\n// コマンドをインポート\nuse commands::file_operations::*;\nuse commands::aws_operations::*;\nuse commands::config::*;\nuse commands::state_management::*;\nuse commands::aws_auth::*;\nuse commands::metadata::*;\nuse commands::upload_system::*;\nuse commands::lifecycle::*;\n\n// システムトレイのセットアップ関数\nfn setup_system_tray(app: \u0026tauri::App) -\u003e tauri::Result\u003c()\u003e {\n    let settings_item = MenuItem::with_id(app, \"settings\", \"設定\", true, Some(\"Cmd+,\"))?;\n    let separator = PredefinedMenuItem::separator(app)?;\n    let quit_item = MenuItem::with_id(app, \"quit\", \"終了\", true, Some(\"Cmd+Q\"))?;\n    \n    let menu = Menu::with_items(app, \u0026[\u0026settings_item, \u0026separator, \u0026quit_item])?;\n    \n    let _tray = TrayIconBuilder::new()\n        .icon(app.default_window_icon().unwrap().clone())\n        .menu(\u0026menu)\n        .show_menu_on_left_click(false)  // 左クリックでメニューを無効化\n        .on_tray_icon_event(|tray, event| match event {\n            // 左クリックでメインウィンドウを開く\n            TrayIconEvent::Click {\n                button: MouseButton::Left,\n                button_state: MouseButtonState::Up,\n                ..\n            } =\u003e {\n                let app = tray.app_handle();\n                if let Some(window) = app.get_webview_window(\"main\") {\n                    let _ = window.show();\n                    let _ = window.set_focus();\n                }\n            }\n            _ =\u003e {}\n        })\n        .on_menu_event(|app, event| match event.id.as_ref() {\n            \"settings\" =\u003e {\n                // 設定画面を開く\n                if let Some(window) = app.get_webview_window(\"main\") {\n                    let _ = window.show();\n                    let _ = window.set_focus();\n                    let _ = app.emit(\"open-settings\", ());\n                }\n            }\n            \"quit\" =\u003e app.exit(0),\n            _ =\u003e {}\n        })\n        .build(app)?;\n    \n    Ok(())\n}\n\n#[cfg_attr(mobile, tauri::mobile_entry_point)]\npub fn run() {\n  // アプリケーション状態の初期化\n  let app_state = Arc::new(Mutex::new(commands::state_management::AppState::default()));\n  let upload_queue = Arc::new(Mutex::new(commands::upload_system::UploadQueue::new()));\n\n  tauri::Builder::default()\n    .plugin(tauri_plugin_shell::init())\n    .plugin(tauri_plugin_dialog::init())\n    .manage(app_state)\n    .manage(upload_queue)\n    .invoke_handler(tauri::generate_handler![\n\n        // ファイル操作API\n        list_files,\n        get_file_info,\n        select_directory,\n        watch_directory,\n        test_watch_system,\n        get_sample_watch_configs,\n        // AWS操作API\n        test_aws_connection,\n        list_s3_objects,\n        restore_file,\n        check_restore_status,\n        get_restore_notifications,\n        download_s3_file,\n    download_restored_file,\n        list_restore_jobs,\n        cancel_restore_job,\n        clear_restore_history,\n        // AWS認証API\n        authenticate_aws,\n        test_s3_bucket_access,\n        save_aws_credentials_secure,\n        load_aws_credentials_secure,\n        // 設定管理API\n        get_config,\n        set_config,\n        update_config,\n        reset_config,\n        validate_config_file,\n        validate_config_data,\n        backup_config,\n        export_config,\n        import_config,\n        restore_config,\n        \n        // 状態管理API\n        get_app_state,\n        set_app_state,\n        update_app_state,\n        add_to_upload_queue,\n        update_system_stats,\n        reset_app_state,\n        // メタデータ管理API\n        initialize_metadata_db,\n        create_file_metadata,\n        save_file_metadata,\n        search_file_metadata,\n        update_file_metadata,\n        delete_file_metadata,\n        get_all_tags,\n        // アップロードシステムAPI\n        initialize_upload_queue,\n        open_file_dialog,\n        add_files_to_upload_queue,\n        remove_upload_item,\n        start_upload_processing,\n        stop_upload_processing,\n        get_upload_queue_status,\n        get_upload_queue_items,\n        retry_upload_item,\n        clear_upload_queue,\n        test_upload_config,\n        // ライフサイクル管理API\n        enable_reelvault_lifecycle,\n        get_lifecycle_status,\n        disable_lifecycle_policy,\n        list_lifecycle_rules,\n        validate_lifecycle_config,\n        check_upload_readiness\n    ])\n    .setup(|app| {\n        // ロガーを初期化\n        if let Err(e) = logger::init_logger(app.handle()) {\n            eprintln!(\"Failed to initialize logger: {}\", e);\n        }\n        tracing::info!(\"Logger initialized, setting up system tray...\");\n\n        // システムトレイを初期化\n        setup_system_tray(app)?;\n      \n        Ok(())\n    })\n    .on_window_event(|window, event| {\n      match event {\n        tauri::WindowEvent::CloseRequested { api, .. } =\u003e {\n          // ウィンドウを閉じる代わりに隠す\n          window.hide().unwrap();\n          api.prevent_close();\n        }\n        _ =\u003e {}\n      }\n    })\n    .run(tauri::generate_context!())\n    .expect(\"error while running tauri application\");\n}\n","traces":[{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":106},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","logger.rs"],"content":"use tauri::{AppHandle, Manager};\nuse tracing_subscriber::{fmt, prelude::*, EnvFilter, Layer};\nuse anyhow::{Context, Result};\n\nconst LOG_FILE_NAME: \u0026str = \"ReelVault.log\";\n\npub fn init_logger(app: \u0026AppHandle) -\u003e Result\u003c()\u003e {\n    let log_dir = app\n        .path()\n        .app_log_dir()\n        .context(\"Failed to get app log directory\")?;\n    std::fs::create_dir_all(\u0026log_dir)?;\n    let log_path = log_dir.join(LOG_FILE_NAME);\n\n    let env_filter = EnvFilter::try_from_default_env()\n        .unwrap_or_else(|_| EnvFilter::new(\"info,reel_vault=debug,tauri=info,aws=warn\"));\n\n    let file_appender = tracing_appender::rolling::daily(\u0026log_dir, LOG_FILE_NAME);\n    let file_layer = fmt::layer()\n        .with_thread_ids(true)\n        .with_thread_names(true)\n        .with_target(true)\n        .with_ansi(false)\n        .with_timer(fmt::time::ChronoUtc::new(\n            \"%Y-%m-%dT%H:%M:%S%.3f%z\".to_string(),\n        ))\n        .with_writer(file_appender)\n        .with_filter(EnvFilter::new(\"info,reel_vault=trace\"));\n\n    let stdout_layer = fmt::layer()\n        .with_thread_ids(true)\n        .with_thread_names(true)\n        .with_target(true)\n        .with_ansi(true)\n        .with_timer(fmt::time::ChronoUtc::new(\"%H:%M:%S%.3f\".to_string()))\n        .with_writer(std::io::stdout);\n\n    let subscriber = tracing_subscriber::registry()\n        .with(env_filter)\n        .with(file_layer);\n\n    if cfg!(debug_assertions) {\n        subscriber\n            .with(stdout_layer.with_filter(EnvFilter::new(\"debug\")))\n            .init();\n    } else {\n        subscriber.init();\n    }\n\n    tracing::info!(\"==================================================\");\n    tracing::info!(\n        \"Logger initialized. Log file at: {}\",\n        log_path.display()\n    );\n    tracing::info!(\"Log level: RUST_LOG or default (info, reel_vault=debug)\");\n    tracing::info!(\"==================================================\");\n\n    Ok(())\n}","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":28},{"path":["/","Users","kazuki","Develop","Own","ReelVault","src-tauri","src","main.rs"],"content":"// Prevents additional console window on Windows in release, DO NOT REMOVE!!\n#![cfg_attr(not(debug_assertions), windows_subsystem = \"windows\")]\n\nfn main() {\n  app_lib::run();\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":0}},{"line":5,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>